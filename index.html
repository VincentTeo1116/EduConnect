<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduConnect Learning Centre</title>
  <link rel="icon" href="Images/Logo.png" type="image/png">
  <link rel="stylesheet" href="App.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .global-popup-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background-color: rgba(0, 0, 0, 0.7) !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      z-index: 9999 !important;
    }
    
    .global-popup-content {
      background: white !important;
      padding: 30px !important;
      border-radius: 15px !important;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
      width: 90% !important;
      max-width: 500px !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
    }
    
    .global-popup-content form {
      display: flex !important;
      flex-direction: column !important;
      gap: 15px !important;
    }
    
    .global-popup-content input,
    .global-popup-content select {
      padding: 12px 15px !important;
      border: 1px solid #ddd !important;
      border-radius: 8px !important;
      font-size: 16px !important;
      transition: border-color 0.3s !important;
    }
    
    .global-popup-content input:focus,
    .global-popup-content select:focus {
      outline: none !important;
      border-color: #667eea !important;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1) !important;
    }
    
    /* Fix body overflow */
    body.popup-open {
      overflow: hidden !important;
    }

    /* Login alert styling */
    .login-alert-credentials {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    
    .login-alert-credentials h4 {
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .login-alert-credentials p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }

    /* Loading screen styles */
    .loading-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 20px;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    .invitation-code-display {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
      font-size: 24px;
      letter-spacing: 2px;
      font-weight: bold;
    }
    
    .invite-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .copy-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .copy-btn:hover {
      background-color: #45a049;
    }
    
    .refresh-btn {
      background-color: #ff9800;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .refresh-btn:hover {
      background-color: #e68900;
    }
    
    .join-module-form {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #667eea;
    }
    
    .no-class-found {
      background-color: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="global-popup-container"></div>
  
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const supabaseUrl = 'https://etilwlveocqsozzuizil.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0aWx3bHZlb2Nxc296enVpemlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDc0NTQsImV4cCI6MjA4MjY4MzQ1NH0.VY_acdqcgBFXxXCfUUCIGKKrDRYqZmFTpsNj9_h2pm0';
    
    // Create Supabase client
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
    
    // SUPABASE SERVICE FUNCTIONS
    const SupabaseService = {
      // Users
      async getUsers() {
        try {
          const { data, error } = await supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) {
            console.error('Supabase getUsers error:', error);
            throw error;
          }
          return data || [];
        } catch (error) {
          console.error('Error fetching users:', error);
          return [];
        }
      },
      
      async createUser(user) {
        try {
          const { data, error } = await supabase
            .from('users')
            .insert([user])
            .select();
          
          if (error) {
            console.error('Supabase createUser error:', error);
            throw error;
          }
          return data[0];
        } catch (error) {
          console.error('Error creating user:', error);
          throw error;
        }
      },
      
      async updateUser(userId, updates) {
        try {
          const { data, error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', userId)
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error updating user:', error);
          throw error;
        }
      },
      
      async userExists(email) {
        try {
          const { data, error } = await supabase
            .from('users')
            .select('id')
            .eq('email', email)
            .single();
          
          return !error && data !== null;
        } catch (error) {
          return false;
        }
      },
      
      async loginUser(email, password) {
        try {
          const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .eq('active', true)
            .single();
          
          if (error) throw error;
          return data;
        } catch (error) {
          console.error('Login error:', error);
          throw error;
        }
      },
      
      // Modules
      async getModules() {
        try {
          const { data, error } = await supabase
            .from('modules')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching modules:', error);
          return [];
        }
      },
      
      async createModule(module) {
        try {
          console.log('Creating module with data:', module);
          
          // Map camelCase to snake_case for Supabase
          const supabaseModule = {
            code: module.code,
            name: module.name,
            description: module.description,
            instructor_id: module.instructor_id || module.instructorId || null,
            exam_admin_id: module.exam_admin_id || module.examAdminId || null,
            invitation_code: module.invitation_code
          };
          
          const { data, error } = await supabase
            .from('modules')
            .insert([supabaseModule])
            .select();
          
          if (error) {
            console.error('Supabase createModule error details:', error);
            throw error;
          }
          return data[0];
        } catch (error) {
          console.error('Error creating module:', error);
          throw error;
        }
      },
      
      async deleteModule(moduleCode) {
        try {
          const { error } = await supabase
            .from('modules')
            .delete()
            .eq('code', moduleCode);
          
          if (error) throw error;
        } catch (error) {
          console.error('Error deleting module:', error);
          throw error;
        }
      },
      
      // Classes
      async getClasses() {
        try {
          const { data, error } = await supabase
            .from('classes')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching classes:', error);
          return [];
        }
      },
      
      async createClass(classData) {
        try {
          console.log('Creating class with data (matching your schema):', classData);
          
          // Map to your actual database columns
          const supabaseClass = {
            name: classData.name,
            module_code: classData.module_code,
            students: classData.students || []
          };
          
          console.log('Sending to Supabase (your schema):', supabaseClass);
          
          const { data, error } = await supabase
            .from('classes')
            .insert([supabaseClass])
            .select();
          
          if (error) {
            console.error('Supabase createClass error:', error);
            console.error('Error details:', error.message);
            throw error;
          }
          
          console.log('Class created successfully:', data);
          return data[0];
        } catch (error) {
          console.error('Error creating class:', error);
          throw error;
        }
      },
      
      async deleteClass(classId) {
        try {
          const { error } = await supabase
            .from('classes')
            .delete()
            .eq('id', classId);
          
          if (error) throw error;
        } catch (error) {
          console.error('Error deleting class:', error);
          throw error;
        }
      },
      
      // Assessments
      async getAssessments() {
        try {
          const { data, error } = await supabase
            .from('assessments')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching assessments:', error);
          return [];
        }
      },
      
      async createAssessment(assessment) {
        try {
          const { data, error } = await supabase
            .from('assessments')
            .insert([assessment])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating assessment:', error);
          throw error;
        }
      },
      
      // Submissions
      async getSubmissions() {
        try {
          const { data, error } = await supabase
            .from('submissions')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching submissions:', error);
          return [];
        }
      },
      
      async createSubmission(submission) {
        try {
          const { data, error } = await supabase
            .from('submissions')
            .insert([submission])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating submission:', error);
          throw error;
        }
      },
      
      async updateSubmission(submissionId, updates) {
        try {
          const { data, error } = await supabase
            .from('submissions')
            .update(updates)
            .eq('id', submissionId)
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error updating submission:', error);
          throw error;
        }
      },
      
      // Questions
      async getQuestions() {
        try {
          const { data, error } = await supabase
            .from('questions')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching questions:', error);
          return [];
        }
      },
      
      async createQuestion(question) {
        try {
          const { data, error } = await supabase
            .from('questions')
            .insert([question])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating question:', error);
          throw error;
        }
      },
      
      async updateQuestion(questionId, updates) {
        try {
          const { data, error } = await supabase
            .from('questions')
            .update(updates)
            .eq('id', questionId)
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error updating question:', error);
          throw error;
        }
      },

      // Invitation Code Functions
      generateInvitationCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let invitation_code = '';
        for (let i = 0; i < 8; i++) {
          invitation_code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return invitation_code;
      },
      
      async checkInvitationCodeExists(invitationCode) {
        try {
          const { data, error } = await supabase
            .from('modules')
            .select('invitation_code')
            .eq('invitation_code', invitationCode)
            .single();
          
          return data !== null;
        } catch (error) {
          if (error.code === 'PGRST116') {
            return false; // Code doesn't exist
          }
          console.error('Error checking invitation code:', error);
          return true; // Assume exists on error to be safe
        }
      },
      
      // Generate unique invitation code with retry logic
      async generateUniqueInvitationCode(maxAttempts = 10) {
        let attempts = 0;
        
        while (attempts < maxAttempts) {
          const code = this.generateInvitationCode();
          const exists = await this.checkInvitationCodeExists(code);
          
          if (!exists) {
            return code; // Found unique code
          }
          
          attempts++;
          console.log(`Invitation code ${code} already exists, trying again... (attempt ${attempts})`);
        }
        
        // Fallback: add timestamp to ensure uniqueness
        const timestamp = Date.now().toString().slice(-4);
        const baseCode = this.generateInvitationCode().slice(0, 4);
        return baseCode + timestamp;
      },
      
      // Update module invitation code
      async updateModuleInvitationCode(moduleCode, invitationCode) {
        try {
          console.log('Updating invitation code for module:', moduleCode, 'New code:', invitationCode);
          
          const { data, error } = await supabase
            .from('modules')
            .update({ 
              invitation_code: invitationCode,
              updated_at: new Date().toISOString()
            })
            .eq('code', moduleCode)
            .select();
          
          if (error) {
            console.error('Supabase update error:', error);
            throw error;
          }
          return data[0];
        } catch (error) {
          console.error('Error updating invitation code:', error);
          throw error;
        }
      },
      
      // Find module by invitation code
      async findModuleByInvitationCode(invitationCode) {
        try {
          console.log('Searching for module with invitation code:', invitationCode);
          
          const { data, error } = await supabase
            .from('modules')
            .select('*')
            .eq('invitation_code', invitationCode)
            .single();
          
          if (error) {
            if (error.code === 'PGRST116') { // No rows found
              console.log('No module found with invitation code:', invitationCode);
              return null;
            }
            throw error;
          }
          console.log('Found module:', data);
          return data;
        } catch (error) {
          console.error('Error finding module by invitation code:', error);
          return null;
        }
      },
      
      // Get module by code
      async getModuleByCode(moduleCode) {
        try {
          const { data, error } = await supabase
            .from('modules')
            .select('*')
            .eq('code', moduleCode)
            .single();
          
          if (error) throw error;
          return data;
        } catch (error) {
          console.error('Error getting module:', error);
          throw error;
        }
      },
      
      // Add student to class
      async addStudentToClass(classId, studentId) {
        try {
          console.log('Adding student', studentId, 'to class', classId);
          
          // First get the current class
          const { data: classData, error: fetchError } = await supabase
            .from('classes')
            .select('students')
            .eq('id', classId)
            .single();
          
          if (fetchError) throw fetchError;
          
          // Add student to students array if not already there
          const students = classData.students || [];
          if (!students.includes(parseInt(studentId))) {
            students.push(parseInt(studentId));
            
            const { data, error } = await supabase
              .from('classes')
              .update({ 
                students: students,
                updated_at: new Date().toISOString()
              })
              .eq('id', classId)
              .select();
            
            if (error) throw error;
            return data[0];
          }
          return classData; // Already in class
        } catch (error) {
          console.error('Error adding student to class:', error);
          throw error;
        }
      },
      
      // Get classes for a module
      async getClassesForModule(moduleCode) {
        try {
          const { data, error } = await supabase
            .from('classes')
            .select('*')
            .eq('module_code', moduleCode);
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching classes for module:', error);
          return [];
        }
      }
    };

    // ==================== GLOBAL POPUP COMPONENT ====================
    const GlobalAddUserPopup = ({ 
      show, 
      onClose, 
      userData, 
      setUserData, 
      onSubmit 
    }) => {
      if (!show) return null;
      
      useEffect(() => {
        document.body.classList.add('popup-open');
        return () => {
          document.body.classList.remove('popup-open');
        };
      }, []);
      
      return ReactDOM.createPortal(
        <div className="global-popup-overlay">
          <div className="global-popup-content">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h2 style={{
                fontSize: '28px',
                fontWeight: '300',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                margin: 0
              }}>
                Add New User
              </h2>
              <button 
                onClick={onClose}
                style={{ 
                  background: 'none', 
                  border: 'none', 
                  fontSize: '28px', 
                  cursor: 'pointer', 
                  color: '#666',
                  width: '40px',
                  height: '40px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '50%',
                  transition: 'background-color 0.3s'
                }}
                onMouseOver={(e) => e.target.style.backgroundColor = '#f0f0f0'}
                onMouseOut={(e) => e.target.style.backgroundColor = 'transparent'}
              >
                Ã—
              </button>
            </div>
            
            <form onSubmit={onSubmit}>
              <input 
                type="text" 
                placeholder="Full Name" 
                value={userData.name} 
                onChange={(e) => setUserData({ ...userData, name: e.target.value })} 
                required
              />
              <input 
                type="email" 
                placeholder="Email Address" 
                value={userData.email} 
                onChange={(e) => setUserData({ ...userData, email: e.target.value })} 
                required
              />
              <input 
                type="password" 
                placeholder="Password" 
                value={userData.password} 
                onChange={(e) => setUserData({ ...userData, password: e.target.value })} 
                required
              />
              <select 
                value={userData.role} 
                onChange={(e) => setUserData({ ...userData, role: e.target.value })} 
                required
              >
                <option value="">Select Role</option>
                <option value="Student">Student</option>
                <option value="Instructor">Instructor</option>
                <option value="System Administrator">System Administrator</option>
                <option value="Exam Administrator">Exam Administrator</option>
              </select>
              <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                <button type="submit" className="btn-primary" style={{ flex: 1 }}>Create User</button>
                <button type="button" onClick={onClose} className="btn-secondary" style={{ flex: 1 }}>Cancel</button>
              </div>
            </form>
          </div>
        </div>,
        document.getElementById('global-popup-container')
      );
    };

    // LoginPage Component with Login Alert Credentials
    const LoginPage = ({ loginData, setLoginData, handleLogin, goToRegister }) => (
      <div className="form-container">
        <div style={{ textAlign: 'center', marginBottom: '20px' }}>
          <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
        </div>
        <h2 style={{
          fontSize: '32px',
          fontWeight: '300',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          WebkitBackgroundClip: 'text',
          WebkitTextFillColor: 'transparent',
          marginBottom: '25px',
          textAlign: 'center',
          letterSpacing: '0.5px'
        }}>
          Login to EduConnect
        </h2>
        
        <form onSubmit={handleLogin}>
          <input 
            type="email" 
            placeholder="Email" 
            value={loginData.email} 
            onChange={e => setLoginData({ ...loginData, email: e.target.value })} 
            required 
          />
          <input 
            type="password" 
            placeholder="Password" 
            value={loginData.password} 
            onChange={e => setLoginData({ ...loginData, password: e.target.value })} 
            required 
          />

          {/* Login Alert Section */}
          <div className="login-alert-credentials">
            <h4><i className="fas fa-info-circle"></i> No Account Access?</h4>
            <p>Contact the administrator to request account creation.</p>
          </div>

          <button type="submit" className="btn-primary">Login</button>
        </form>
      </div>
    );

    // RegisterPage Component
    const RegisterPage = ({ registerData, setRegisterData, handleRegister, goToLogin }) => (
      <div className="form-container">
        <div style={{ textAlign: 'center', marginBottom: '20px' }}>
          <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
        </div>
        <h2
          style={{
            fontSize: '32px',
            fontWeight: '300',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            marginBottom: '25px',
            textAlign: 'center',
            letterSpacing: '0.5px'
          }}
        >Register for EduConnect</h2>
        <form onSubmit={handleRegister}>
          <input 
            type="text" 
            placeholder="Full Name" 
            value={registerData.name} 
            onChange={e => setRegisterData({ ...registerData, name: e.target.value })} 
            required 
          />
          <input 
            type="email" 
            placeholder="Email Address" 
            value={registerData.email} 
            onChange={e => setRegisterData({ ...registerData, email: e.target.value })} 
            required 
          />
          <input 
            type="password" 
            placeholder="Password" 
            value={registerData.password} 
            onChange={e => setRegisterData({ ...registerData, password: e.target.value })} 
            required 
          />
          <select 
            value={registerData.role} 
            onChange={e => setRegisterData({ ...registerData, role: e.target.value })} 
            required
          >
            <option value="">Select Role</option>
            <option value="Student">Student</option>
            <option value="Instructor">Instructor</option>
            <option value="System Administrator">System Administrator</option>
            <option value="Exam Administrator">Exam Administrator</option>
          </select>
          <button type="submit" className="btn-primary">Register</button>
        </form>
        <p>
          Already have an account?{' '}
          <button onClick={goToLogin} className="btn-secondary">Login</button>
        </p>
      </div>
    );

    // StudentDashboard Component
    const StudentDashboard = ({ 
      currentUser, 
      assessments, 
      submissions, 
      questions, 
      setSubmissions, 
      setQuestions, 
      handleLogout, 
      goToProfile,
      modules = [],
      classes = [],
      setClasses = () => {}
    }) => {
      const [questionData, setQuestionData] = useState({ assessmentId: '', text: '' });
      const [invitationCode, setInvitationCode] = useState('');
      const [userModules, setUserModules] = useState([]);

      // Load user's modules on component mount
      useEffect(() => {
        loadUserModules();
      }, [classes, currentUser, modules]);

      const loadUserModules = () => {
        // Find modules where user is enrolled in any class
        const enrolledModules = [];
        modules.forEach(module => {
          const moduleClasses = classes.filter(c => 
            c.module_code === module.code && 
            c.students && 
            c.students.includes(currentUser.id)
          );
          if (moduleClasses.length > 0) {
            enrolledModules.push({
              ...module,
              classCount: moduleClasses.length
            });
          }
        });
        setUserModules(enrolledModules);
      };

      const submitAssessment = async (assessmentId) => {
        try {
          const submission = {
            id: Date.now(),
            assessmentId,
            studentId: currentUser.id,
            files: 'file.pdf',
            drafts: [{ version: 1, content: 'file.pdf', timestamp: new Date().toISOString() }],
            grade: null,
            feedback: '',
            status: 'submitted'
          };
          
          // Try Supabase first
          const createdSubmission = await SupabaseService.createSubmission(submission);
          const updatedSubmissions = [...submissions, createdSubmission];
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Submission successful');
        } catch (error) {
          console.error('Error submitting assessment:', error);
          // Fallback to localStorage
          const submission = {
            id: Date.now(),
            assessmentId,
            studentId: currentUser.id,
            files: 'file.pdf',
            drafts: [{ version: 1, content: 'file.pdf', timestamp: new Date().toISOString() }],
            grade: null,
            feedback: '',
            status: 'submitted'
          };
          const updatedSubmissions = [...submissions, submission];
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Submission successful (local)');
        }
      };

      const handleQuestionSubmit = async (e) => {
        e.preventDefault();
        try {
          const question = {
            id: Date.now(),
            assessmentId: parseInt(questionData.assessmentId),
            studentId: currentUser.id,
            question: questionData.text,
            answers: []
          };
          
          const createdQuestion = await SupabaseService.createQuestion(question);
          const updatedQuestions = [...questions, createdQuestion];
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          setQuestionData({ assessmentId: '', text: '' });
          alert('Question submitted');
        } catch (error) {
          console.error('Error submitting question:', error);
          // Fallback
          const question = {
            id: Date.now(),
            assessmentId: parseInt(questionData.assessmentId),
            studentId: currentUser.id,
            question: questionData.text,
            answers: []
          };
          const updatedQuestions = [...questions, question];
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          setQuestionData({ assessmentId: '', text: '' });
          alert('Question submitted (local)');
        }
      };

      const handleJoinModule = async (e) => {
        e.preventDefault();
        const noClassElement = document.getElementById('no-class-found');
        noClassElement.style.display = 'none';
        
        // Validate invitation code
        if (!invitationCode || invitationCode.length < 6) {
          noClassElement.innerHTML = `
            <i class="fas fa-exclamation-circle"></i> 
            <strong> Invalid invitation code.</strong>
            <div style="font-size: 14px; margin-top: 5px;">
              Please enter a valid invitation code (8 characters).
            </div>
          `;
          noClassElement.style.display = 'block';
          return;
        }
        
        try {
          // Find module by invitation_code
          const module = await SupabaseService.findModuleByInvitationCode(invitationCode);
          
          if (!module) {
            noClassElement.innerHTML = `
              <i class="fas fa-exclamation-circle"></i> 
              <strong> No module found with invitation code: ${invitationCode}</strong>
              <div style="font-size: 14px; margin-top: 5px;">
                Please check the code and try again, or contact your instructor.
              </div>
            `;
            noClassElement.style.display = 'block';
            return;
          }
          
          // Get classes for this module
          const moduleClasses = await SupabaseService.getClassesForModule(module.code);
          
          if (moduleClasses.length === 0) {
            alert(`Module "${module.name}" has no classes set up yet. Please contact the instructor.`);
            return;
          }
          
          // Add student to all classes in the module
          let enrolledCount = 0;
          let alreadyEnrolledCount = 0;
          
          for (const classItem of moduleClasses) {
            try {
              const result = await SupabaseService.addStudentToClass(classItem.id, currentUser.id);
              
              // Check if student was newly added
              const students = result.students || [];
              if (students.includes(parseInt(currentUser.id))) {
                enrolledCount++;
              } else {
                alreadyEnrolledCount++;
              }
            } catch (error) {
              console.error(`Error adding to class ${classItem.id}:`, error);
            }
          }
          
          // Update local state
          const updatedClasses = [...classes];
          moduleClasses.forEach(classItem => {
            const index = updatedClasses.findIndex(c => c.id === classItem.id);
            if (index !== -1) {
              const students = updatedClasses[index].students || [];
              if (!students.includes(parseInt(currentUser.id))) {
                students.push(parseInt(currentUser.id));
                updatedClasses[index] = { ...updatedClasses[index], students };
              }
            }
          });
          
          setClasses(updatedClasses);
          localStorage.setItem('classes', JSON.stringify(updatedClasses));
          
          // Reload user modules
          loadUserModules();
          
          setInvitationCode('');
          
          let message = `Successfully joined module: ${module.name}\n`;
          message += `Module Code: ${module.code}\n`;
          message += `Invitation Code: ${module.invitation_code}\n\n`;
          
          if (enrolledCount > 0) {
            message += `You've been added to ${enrolledCount} new class(es).\n`;
          }
          if (alreadyEnrolledCount > 0) {
            message += `You were already enrolled in ${alreadyEnrolledCount} class(es).\n`;
          }
          
          alert(message);
          
        } catch (error) {
          console.error('Error joining module:', error);
          alert('Failed to join module. Please try again or contact support.');
        }
      };

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Welcome, {currentUser.name} (Student)</h1>
            </div>
            <div>
              <button onClick={goToProfile} className="btn-secondary">Profile</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>
          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">Student Dashboard</h2>
              <p className="welcome-subtitle">
                View assessments, submit work, and ask questions
              </p>
            </section>
            
            <section>
              <h3>My Assessments ({assessments.length})</h3>
              <div className="quick-actions">
                {assessments.map(a => (
                  <div key={a.id} className="item-card">
                    <h4>{a.title}</h4>
                    <p>{a.description}</p>
                    <p><strong>Deadline:</strong> {a.deadline}</p>
                    <button 
                      onClick={() => submitAssessment(a.id)}
                      className="btn-primary"
                      style={{ marginTop: '10px', width: '100%' }}
                    >
                      Submit Assessment
                    </button>
                  </div>
                ))}
              </div>
            </section>
            
            <section>
              <h3>Ask a Question</h3>
              <form onSubmit={handleQuestionSubmit} className="form-container" style={{ maxWidth: '600px' }}>
                <select 
                  value={questionData.assessmentId} 
                  onChange={e => setQuestionData({ ...questionData, assessmentId: e.target.value })} 
                  required
                >
                  <option value="">Select Assessment</option>
                  {assessments.map(a => (
                    <option key={a.id} value={a.id}>{a.title}</option>
                  ))}
                </select>
                <textarea 
                  placeholder="Enter your question here..." 
                  value={questionData.text} 
                  onChange={e => setQuestionData({ ...questionData, text: e.target.value })} 
                  required
                  rows="4"
                />
                <button type="submit" className="btn-primary">Submit Question</button>
              </form>
            </section>

            <section>
              <h3>Join a Module</h3>
              <div className="join-module-form">
                <form onSubmit={handleJoinModule} style={{ marginBottom: '15px' }}>
                  <input 
                    type="text" 
                    placeholder="Enter invitation code (e.g., ABC123XY)" 
                    value={invitationCode}
                    onChange={(e) => {
                      const value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                      setInvitationCode(value.slice(0, 8));
                    }}
                    required
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px',
                      marginBottom: '10px',
                      fontSize: '16px',
                      letterSpacing: '2px',
                      textAlign: 'center',
                      fontFamily: 'monospace',
                      fontWeight: 'bold'
                    }}
                    maxLength="8"
                  />
                  <button type="submit" className="btn-primary" style={{ width: '100%' }}>
                    <i className="fas fa-sign-in-alt"></i> Join Module
                  </button>
                </form>
                
                <div id="no-class-found" className="no-class-found">
                  <i className="fas fa-exclamation-circle"></i> No module found with this invitation code.
                </div>
              </div>
              
              <div style={{ marginTop: '20px' }}>
                <h4>My Enrolled Modules</h4>
                {userModules.length > 0 ? (
                  <div className="quick-actions">
                    {userModules.map(module => (
                      <div key={module.code} className="item-card">
                        <h5>{module.name}</h5>
                        <p><strong>Module Code:</strong> {module.code}</p>
                        <p><strong>Invitation Code:</strong> {module.invitation_code}</p>
                        <p><strong>Classes enrolled:</strong> {module.classCount}</p>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p>You haven't joined any modules yet. Enter an invitation code above.</p>
                )}
              </div>
            </section>
          </main>
        </div>
      );
    };

    // InstructorDashboard Component
    const InstructorDashboard = ({ 
      currentUser, 
      assessments, 
      submissions, 
      questions, 
      setAssessments, 
      setSubmissions, 
      setQuestions, 
      handleLogout, 
      goToProfile,
      modules = [],
      setModules = () => {}
    }) => {
      const [assessmentData, setAssessmentData] = useState({ 
        title: '', 
        description: '', 
        course: '', 
        deadline: '', 
        criteria: '' 
      });

      const handleAssessmentSubmit = async (e) => {
        e.preventDefault();
        try {
          const assessment = {
            id: Date.now(),
            title: assessmentData.title,
            description: assessmentData.description,
            course: assessmentData.course,
            deadline: assessmentData.deadline,
            criteria: assessmentData.criteria,
            instructorId: currentUser.id,
            files: []
          };
          
          const createdAssessment = await SupabaseService.createAssessment(assessment);
          const updatedAssessments = [...assessments, createdAssessment];
          setAssessments(updatedAssessments);
          localStorage.setItem('assessments', JSON.stringify(updatedAssessments));
          setAssessmentData({ title: '', description: '', course: '', deadline: '', criteria: '' });
          alert('Assessment created successfully');
        } catch (error) {
          console.error('Error creating assessment:', error);
          const assessment = {
            id: Date.now(),
            title: assessmentData.title,
            description: assessmentData.description,
            course: assessmentData.course,
            deadline: assessmentData.deadline,
            criteria: assessmentData.criteria,
            instructorId: currentUser.id,
            files: []
          };
          const updatedAssessments = [...assessments, assessment];
          setAssessments(updatedAssessments);
          localStorage.setItem('assessments', JSON.stringify(updatedAssessments));
          setAssessmentData({ title: '', description: '', course: '', deadline: '', criteria: '' });
          alert('Assessment created (local)');
        }
      };

      const gradeSubmission = async (submissionId, grade) => {
        try {
          const updatedSubmission = await SupabaseService.updateSubmission(submissionId, { 
            grade, 
            status: 'graded' 
          });
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? updatedSubmission : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
        } catch (error) {
          console.error('Error grading submission:', error);
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? { ...s, grade, status: 'graded' } : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
        }
      };

      const updateFeedback = async (submissionId, feedback) => {
        try {
          const updatedSubmission = await SupabaseService.updateSubmission(submissionId, { feedback });
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? updatedSubmission : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
        } catch (error) {
          console.error('Error updating feedback:', error);
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? { ...s, feedback } : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
        }
      };

      const answerQuestion = async (questionId, answer) => {
        try {
          const question = questions.find(q => q.id === questionId);
          const updatedAnswers = [...(question.answers || []), { 
            instructorId: currentUser.id, 
            answer, 
            official: true, 
            resolved: false 
          }];
          
          const updatedQuestion = await SupabaseService.updateQuestion(questionId, { 
            answers: updatedAnswers 
          });
          
          const updatedQuestions = questions.map(q => 
            q.id === questionId ? updatedQuestion : q
          );
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
        } catch (error) {
          console.error('Error answering question:', error);
          const updatedQuestions = questions.map(q => 
            q.id === questionId ? { 
              ...q, 
              answers: [...(q.answers || []), { 
                instructorId: currentUser.id, 
                answer, 
                official: true, 
                resolved: false 
              }] 
            } : q
          );
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
        }
      };

      // Invitation code functions for Instructor
      const generateInvitationCode = async (moduleCode) => {
        try {
          const newCode = await SupabaseService.generateUniqueInvitationCode();
          const updatedModule = await SupabaseService.updateModuleInvitationCode(moduleCode, newCode);
          
          // Update local modules
          const updatedModules = modules.map(m => 
            m.code === moduleCode ? { ...m, invitation_code: newCode } : m
          );
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          
          alert(`Invitation code generated: ${newCode}`);
        } catch (error) {
          console.error('Error generating invitation code:', error);
          alert('Failed to generate invitation code');
        }
      };

      const regenerateInvitationCode = async (moduleCode) => {
        if (!confirm('Are you sure you want to regenerate the invitation code? The old code will no longer work.')) {
          return;
        }
        
        try {
          const newCode = await SupabaseService.generateUniqueInvitationCode();
          const updatedModule = await SupabaseService.updateModuleInvitationCode(moduleCode, newCode);
          
          // Update local modules
          const updatedModules = modules.map(m => 
            m.code === moduleCode ? { ...m, invitation_code: newCode } : m
          );
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          
          alert(`New invitation code generated: ${newCode}\n\nShare this new code with students.`);
        } catch (error) {
          console.error('Error regenerating invitation code:', error);
          alert('Failed to regenerate invitation code');
        }
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text)
          .then(() => {
            alert('Invitation code copied to clipboard!');
          })
          .catch(err => {
            console.error('Failed to copy: ', err);
            // Fallback
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Invitation code copied!');
          });
      };

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Welcome, {currentUser.name} (Instructor)</h1>
            </div>
            <div>
              <button onClick={goToProfile} className="btn-secondary">Profile</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>
          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">Instructor Dashboard</h2>
              <p className="welcome-subtitle">
                Create assessments, grade submissions, and answer student questions
              </p>
            </section>
            
            <section>
              <h3>Create New Assessment</h3>
              <form onSubmit={handleAssessmentSubmit} className="form-container" style={{ maxWidth: '600px' }}>
                <input 
                  type="text" 
                  placeholder="Assessment Title" 
                  value={assessmentData.title} 
                  onChange={e => setAssessmentData({ ...assessmentData, title: e.target.value })} 
                  required 
                />
                <textarea 
                  placeholder="Assessment Description" 
                  value={assessmentData.description} 
                  onChange={e => setAssessmentData({ ...assessmentData, description: e.target.value })} 
                  required 
                  rows="3"
                />
                <input 
                  type="text" 
                  placeholder="Course Name" 
                  value={assessmentData.course} 
                  onChange={e => setAssessmentData({ ...assessmentData, course: e.target.value })} 
                  required 
                />
                <input 
                  type="datetime-local" 
                  value={assessmentData.deadline} 
                  onChange={e => setAssessmentData({ ...assessmentData, deadline: e.target.value })} 
                  required 
                />
                <textarea 
                  placeholder="Grading Criteria" 
                  value={assessmentData.criteria} 
                  onChange={e => setAssessmentData({ ...assessmentData, criteria: e.target.value })} 
                  required 
                  rows="3"
                />
                <button type="submit" className="btn-primary">Create Assessment</button>
              </form>
            </section>
            
            <section>
              <h3>Student Submissions ({submissions.length})</h3>
              <div className="quick-actions">
                {submissions.filter(s => 
                  assessments.find(a => a.id === s.assessmentId && a.instructorId === currentUser.id)
                ).map(s => (
                  <div key={s.id} className="item-card">
                    <h4>Submission #{s.id}</h4>
                    <p><strong>Student ID:</strong> {s.studentId}</p>
                    <p><strong>Status:</strong> {s.status}</p>
                    <p><strong>Current Grade:</strong> {s.grade || 'Not graded'}</p>
                    <div style={{ marginTop: '15px' }}>
                      <input 
                        type="number" 
                        placeholder="Enter grade" 
                        onChange={e => gradeSubmission(s.id, e.target.value)}
                        style={{ marginBottom: '10px', width: '100%', padding: '8px' }}
                      />
                      <textarea 
                        placeholder="Provide feedback..." 
                        value={s.feedback || ''}
                        onChange={e => updateFeedback(s.id, e.target.value)}
                        style={{ width: '100%', padding: '8px', marginBottom: '10px' }}
                        rows="3"
                      />
                    </div>
                  </div>
                ))}
              </div>
            </section>
            
            <section>
              <h3>My Modules & Invitation Codes</h3>
              <div className="quick-actions">
                {modules.filter(m => m.instructor_id === currentUser.id).map(module => (
                  <div key={module.code} className="item-card">
                    <h4>{module.name}</h4>
                    <p><strong>Code:</strong> {module.code}</p>
                    
                    {module.invitation_code ? (
                      <>
                        <div className="invitation-code-display">
                          {module.invitation_code}
                        </div>
                        <div className="invite-actions">
                          <button 
                            onClick={() => regenerateInvitationCode(module.code)}
                            className="refresh-btn"
                          >
                            <i className="fas fa-sync-alt"></i> Regenerate Code
                          </button>
                          <button 
                            onClick={() => copyToClipboard(module.invitation_code)}
                            className="copy-btn"
                          >
                            <i className="fas fa-copy"></i> Copy
                          </button>
                        </div>
                      </>
                    ) : (
                      <div>
                        <p style={{ color: '#666', marginBottom: '10px' }}>
                          No invitation code generated yet.
                        </p>
                        <button 
                          onClick={() => generateInvitationCode(module.code)}
                          className="btn-primary"
                          style={{ width: '100%' }}
                        >
                          <i className="fas fa-key"></i> Generate Invitation Code
                        </button>
                      </div>
                    )}
                    
                    <div style={{ marginTop: '15px', fontSize: '14px', color: '#666' }}>
                      <p><strong>Share this code with students to join your module.</strong></p>
                      <p>Students will be automatically added to all classes in this module.</p>
                    </div>
                  </div>
                ))}
              </div>
            </section>
            
            <section>
              <h3>Student Questions ({questions.length})</h3>
              <div className="quick-actions">
                {questions.map(q => (
                  <div key={q.id} className="item-card">
                    <h4>Question #{q.id}</h4>
                    <p><strong>Question:</strong> {q.question}</p>
                    <textarea 
                      placeholder="Type your answer here..." 
                      onChange={e => answerQuestion(q.id, e.target.value)}
                      style={{ width: '100%', padding: '8px', marginTop: '10px' }}
                      rows="3"
                    />
                    <button 
                      onClick={() => answerQuestion(q.id, document.querySelector(`textarea[placeholder="Type your answer here..."]`).value)}
                      className="btn-primary"
                      style={{ marginTop: '10px', width: '100%' }}
                    >
                      Submit Answer
                    </button>
                  </div>
                ))}
              </div>
            </section>
          </main>
        </div>
      );
    };

    // ExamAdminDashboard Component
    const ExamAdminDashboard = ({ 
      currentUser, 
      assessments, 
      submissions, 
      users, 
      handleLogout, 
      goToProfile 
    }) => {
      // Group submissions by assessment
      const groupedSubmissions = {};
      assessments.forEach(assessment => {
        const assessmentSubmissions = submissions.filter(s => s.assessmentId === assessment.id);
        if (assessmentSubmissions.length > 0) {
          groupedSubmissions[assessment.id] = {
            assessment,
            submissions: assessmentSubmissions
          };
        }
      });

      // Calculate average grades per assessment
      const assessmentStats = assessments.map(assessment => {
        const assessmentSubmissions = submissions.filter(s => s.assessmentId === assessment.id && s.grade);
        const totalGrade = assessmentSubmissions.reduce((sum, s) => sum + parseFloat(s.grade || 0), 0);
        const averageGrade = assessmentSubmissions.length > 0 ? totalGrade / assessmentSubmissions.length : 0;
        
        return {
          ...assessment,
          submissionCount: assessmentSubmissions.length,
          averageGrade: averageGrade.toFixed(2)
        };
      });

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Welcome, {currentUser.name} (Exam Administrator)</h1>
            </div>
            <div>
              <button onClick={goToProfile} className="btn-secondary">Profile</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>
          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">Exam Administration Dashboard</h2>
              <p className="welcome-subtitle">
                Monitor assessment results, grades, and feedback across all courses
              </p>
            </section>
            
            <section>
              <h3>Assessment Statistics ({assessments.length})</h3>
              <div className="quick-actions">
                {assessmentStats.map(stat => (
                  <div key={stat.id} className="item-card">
                    <h4>{stat.title}</h4>
                    <p><strong>Course:</strong> {stat.course}</p>
                    <p><strong>Submissions:</strong> {stat.submissionCount}</p>
                    <p><strong>Average Grade:</strong> {stat.averageGrade}%</p>
                    <p><strong>Deadline:</strong> {stat.deadline}</p>
                  </div>
                ))}
              </div>
            </section>
            
            <section>
              <h3>Detailed Submission Results ({submissions.length})</h3>
              <div className="quick-actions">
                {Object.values(groupedSubmissions).map(({ assessment, submissions: assessmentSubmissions }) => (
                  <div key={assessment.id} className="item-card">
                    <h4>{assessment.title}</h4>
                    <p><strong>Grading Criteria:</strong> {assessment.criteria}</p>
                    <div style={{ marginTop: '15px' }}>
                      <h5>Student Submissions:</h5>
                      {assessmentSubmissions.map(submission => {
                        const student = users.find(u => u.id === submission.studentId);
                        return (
                          <div key={submission.id} style={{ 
                            padding: '10px', 
                            margin: '5px 0', 
                            backgroundColor: 'rgba(102, 126, 234, 0.05)',
                            borderRadius: '5px'
                          }}>
                            <p><strong>Student:</strong> {student?.name || 'Unknown'}</p>
                            <p><strong>Grade:</strong> {submission.grade || 'Not graded'}</p>
                            <p><strong>Status:</strong> {submission.status}</p>
                            {submission.feedback && (
                              <p><strong>Feedback:</strong> {submission.feedback}</p>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </section>
          </main>
        </div>
      );
    };

    // ProfilePage Component
    const ProfilePage = ({ currentUser, setCurrentUser, users, setUsers, goBack, handleLogout }) => {
      const [profileData, setProfileData] = useState({ 
        name: currentUser.name, 
        email: currentUser.email,
        password: ''
      });

      const handleUpdate = async (e) => {
        e.preventDefault();
        try {
          const updatedUser = { 
            ...currentUser, 
            name: profileData.name, 
            email: profileData.email
          };
          
          // Update password if provided
          if (profileData.password) {
            updatedUser.password = profileData.password;
          }
          
          // Try Supabase first
          const supabaseUpdatedUser = await SupabaseService.updateUser(currentUser.id, {
            name: profileData.name,
            email: profileData.email,
            ...(profileData.password && { password: profileData.password })
          });
          
          setCurrentUser(supabaseUpdatedUser);
          
          // Update in users array
          const updatedUsers = users.map(u => 
            u.id === currentUser.id ? supabaseUpdatedUser : u
          );
          setUsers(updatedUsers);
          
          // Save to localStorage
          localStorage.setItem('currentUser', JSON.stringify(supabaseUpdatedUser));
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          
          alert('Profile updated successfully');
          setProfileData({ ...profileData, password: '' });
        } catch (error) {
          console.error('Error updating profile:', error);
          // Fallback to localStorage
          const updatedUser = { 
            ...currentUser, 
            name: profileData.name, 
            email: profileData.email
          };
          
          if (profileData.password) {
            updatedUser.password = profileData.password;
          }
          
          setCurrentUser(updatedUser);
          
          const updatedUsers = users.map(u => 
            u.id === currentUser.id ? updatedUser : u
          );
          setUsers(updatedUsers);
          
          localStorage.setItem('currentUser', JSON.stringify(updatedUser));
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          
          alert('Profile updated (local)');
          setProfileData({ ...profileData, password: '' });
        }
      };

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Profile Settings</h1>
            </div>
            <div>
              <button onClick={goBack} className="btn-secondary">Back to Dashboard</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>
          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">Profile Management</h2>
              <p className="welcome-subtitle">
                Update your personal information and account settings
              </p>
            </section>
            
            <section>
              <h3>Your Profile Information</h3>
              <form onSubmit={handleUpdate} className="form-container" style={{ maxWidth: '600px' }}>
                <div style={{ marginBottom: '20px' }}>
                  <p><strong>Current Role:</strong> {currentUser.role}</p>
                  <p><strong>Account Status:</strong> {currentUser.active ? 'Active' : 'Inactive'}</p>
                </div>
                
                <input 
                  type="text" 
                  placeholder="Full Name" 
                  value={profileData.name} 
                  onChange={e => setProfileData({ ...profileData, name: e.target.value })} 
                  required 
                />
                <input 
                  type="email" 
                  placeholder="Email Address" 
                  value={profileData.email} 
                  onChange={e => setProfileData({ ...profileData, email: e.target.value })} 
                  required 
                />
                <input 
                  type="password" 
                  placeholder="New Password (leave blank to keep current)" 
                  value={profileData.password} 
                  onChange={e => setProfileData({ ...profileData, password: e.target.value })} 
                />
                <button type="submit" className="btn-primary">Update Profile</button>
              </form>
            </section>
          </main>
        </div>
      );
    };

    // ==================== SYSTEM ADMIN DASHBOARD ====================
    const SystemAdminDashboard = ({ 
      currentUser, 
      users = [], 
      setUsers, 
      modules = [], 
      setModules,
      classes = [],
      setClasses,
      handleLogout, 
      goToProfile,
      // Popup control props
      showAddUserPopup,
      setShowAddUserPopup,
      popupUserData,
      setPopupUserData,
      handlePopupUserSubmit
    }) => {
      // Safety check - if no currentUser
      if (!currentUser) {
        return (
          <div className="form-container">
            <h2>No User Logged In</h2>
            <p>Please log in to access the admin dashboard.</p>
            <button className="btn-primary" onClick={handleLogout}>
              Go to Login
            </button>
          </div>
        );
      }

      const [moduleData, setModuleData] = useState({ 
        name: '', 
        description: '',
        instructorId: '',
        examAdminId: '' 
      });
      const [classData, setClassData] = useState({ name: '', moduleCode: '', classType: 'lecture' });

      // Handle module creation with Supabase
      const handleModuleSubmit = async (e) => {
        e.preventDefault();

        if (!moduleData.instructorId) {
          alert('Please select an instructor for the module');
          return;
        }
        
        if (!moduleData.examAdminId) {
          alert('Please select an exam administrator for the module');
          return;
        }
        
        try {
          // Improved module code generation
          const generateModuleCode = (name) => {
            if (!name) return 'MOD';
            
            // Get first letters of each word, max 3
            const initials = name
              .split(' ')
              .map(word => word[0] || '')
              .filter(char => char && char.match(/[A-Za-z]/))
              .join('')
              .toUpperCase()
              .slice(0, 3);
            
            // Add current month and year
            const now = new Date();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yyyy = now.getFullYear().toString();
            
            return `${initials || 'MOD'}-${mm}${yyyy}`;
          };
          
          const code = generateModuleCode(moduleData.name);
          const invitationCode = await SupabaseService.generateUniqueInvitationCode();
          
          // Prepare module data for Supabase
          const newModule = { 
            code, 
            name: moduleData.name, 
            description: moduleData.description,
            instructor_id: moduleData.instructorId ? parseInt(moduleData.instructorId) : null,
            exam_admin_id: moduleData.examAdminId ? parseInt(moduleData.examAdminId) : null,
            invitation_code: invitationCode
          };
          
          // Try Supabase first
          const createdModule = await SupabaseService.createModule(newModule);
          const updatedModules = [...modules, createdModule];
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          setModuleData({ name: '', description: '', instructorId: '', examAdminId: '' });
          alert(`Module "${moduleData.name}" created with code: ${code}, the invitation code is: ${invitationCode}`);
          window.location.reload();
        } catch (error) {
          console.error('Error creating module:', error);
          // Fallback with local unique code generation
          const generateModuleCode = (name) => {
            if (!name) return 'MOD';
            
            const initials = name
              .split(' ')
              .map(word => word[0] || '')
              .filter(char => char && char.match(/[A-Za-z]/))
              .join('')
              .toUpperCase()
              .slice(0, 3);
            
            const now = new Date();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yyyy = now.getFullYear().toString();
            
            return `${initials || 'MOD'}-${mm}${yyyy}`;
          };
          
          const moduleCode = generateModuleCode(moduleData.name);
          const invitationCode = SupabaseService.generateInvitationCode();
          
          const newModule = { 
            code: moduleCode,
            name: moduleData.name, 
            description: moduleData.description,
            instructorId: moduleData.instructorId ? parseInt(moduleData.instructorId) : null,
            examAdminId: moduleData.examAdminId ? parseInt(moduleData.examAdminId) : null,
            invitation_code: invitationCode
          };
          
          const updatedModules = [...modules, newModule];
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          
          setModuleData({ name: '', description: '', instructorId: '', examAdminId: '' });
          alert(`Module created (local storage)\n\nModule Code: ${moduleCode}\nInvitation Code: ${invitationCode}`);
        }
      };

      // Add the missing handleGenerateInvitationCode function
      const handleGenerateInvitationCode = async (moduleCode) => {
        try {
          const newCode = await SupabaseService.generateUniqueInvitationCode();
          console.log('Generating new invitation code:', newCode, 'for module:', moduleCode);
          
          // Update in Supabase
          const updatedModule = await SupabaseService.updateModuleInvitationCode(moduleCode, newCode);
          
          // Update local state
          const updatedModules = modules.map(m => 
            m.code === moduleCode ? { ...m, invitation_code: newCode } : m
          );
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          
          alert(`New invitation code generated: ${newCode}`);
        } catch (error) {
          console.error('Error generating invitation code:', error);
          alert('Failed to generate invitation code');
        }
      };

      // Add the missing copyToClipboard function
      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text)
          .then(() => {
            alert('Invitation code copied to clipboard!');
          })
          .catch(err => {
            console.error('Failed to copy: ', err);
            // Fallback method
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Invitation code copied!');
          });
      };

      const deleteModule = async (moduleCode) => {
        if (window.confirm('Are you sure you want to delete this module?')) {
          try {
            await SupabaseService.deleteModule(moduleCode);
            const updatedModules = modules.filter(m => m.code !== moduleCode);
            setModules(updatedModules);
            localStorage.setItem('modules', JSON.stringify(updatedModules));
          } catch (error) {
            console.error('Error deleting module:', error);
            const updatedModules = modules.filter(m => m.code !== moduleCode);
            setModules(updatedModules);
            localStorage.setItem('modules', JSON.stringify(updatedModules));
          }
        }
      };

      // UPDATED: Class creation matching your database schema
      const handleClassSubmit = async (e) => {
        e.preventDefault();
        
        if (!classData.moduleCode || !classData.classType || !classData.name) {
          alert('Please fill in all required fields');
          return;
        }
        
        try {
          // Get count of existing classes for this module and type
          const existingClasses = classes.filter(c => 
            c.module_code === classData.moduleCode
          );
          const classNumber = existingClasses.length + 1;
          
          // Generate class display name with type and number
          const displayName = `${classData.name} - ${classData.classType.charAt(0).toUpperCase() + classData.classType.slice(1)} ${classNumber}`;
          
          // Prepare class data for Supabase - using YOUR schema
          const newClass = { 
            name: displayName, // Store class type in the name
            module_code: classData.moduleCode,
            students: [] // Initialize empty students array
          };
          
          console.log('Attempting to create class (your schema):', newClass);
          
          // Create class in Supabase
          const createdClass = await SupabaseService.createClass(newClass);
          
          console.log('Class created successfully:', createdClass);
          
          // Add class_type to the created class object for local display
          const classWithType = {
            ...createdClass,
            class_type: classData.classType, // Keep for UI display
            display_code: `${classData.moduleCode}_${classData.classType}_${classNumber}` // Virtual code for display
          };
          
          const updatedClasses = [...classes, classWithType];
          setClasses(updatedClasses);
          localStorage.setItem('classes', JSON.stringify(updatedClasses));
          
          setClassData({ name: '', moduleCode: '', classType: 'lecture' });
          alert(`Class "${displayName}" created successfully!`);
        } catch (error) {
          console.error('Error creating class in Supabase:', error);
          
          // Check if it's a database schema issue
          if (error.message && error.message.includes('column')) {
            alert(`Database error: ${error.message}. Please check your database schema.`);
          } else {
            // Fallback to localStorage
            const existingClassesOfSameType = classes.filter(c => 
              c.module_code === classData.moduleCode
            );
            const classNumber = existingClassesOfSameType.length + 1;
            const displayName = `${classData.name} - ${classData.classType.charAt(0).toUpperCase() + classData.classType.slice(1)} ${classNumber}`;
            
            const newClass = { 
              id: Date.now(), 
              name: displayName,
              module_code: classData.moduleCode,
              class_type: classData.classType,
              students: [],
              display_code: `${classData.moduleCode}_${classData.classType}_${classNumber}`,
              created_at: new Date().toISOString()
            };
            
            const updatedClasses = [...classes, newClass];
            setClasses(updatedClasses);
            localStorage.setItem('classes', JSON.stringify(updatedClasses));
            
            setClassData({ name: '', moduleCode: '', classType: 'lecture' });
            alert(`Class created (local storage only): ${displayName}`);
          }
        }
      };

      // UPDATED: Class deletion
      const deleteClass = async (classId) => {
        if (window.confirm('Are you sure you want to delete this class?')) {
          try {
            await SupabaseService.deleteClass(classId);
            const updatedClasses = classes.filter(c => c.id !== classId);
            setClasses(updatedClasses);
            localStorage.setItem('classes', JSON.stringify(updatedClasses));
            alert('Class deleted successfully from database');
          } catch (error) {
            console.error('Error deleting class:', error);
            const updatedClasses = classes.filter(c => c.id !== classId);
            setClasses(updatedClasses);
            localStorage.setItem('classes', JSON.stringify(updatedClasses));
            alert('Class deleted (local storage only)');
          }
        }
      };

      const toggleUser = async (userId) => {
        try {
          const user = users.find(u => u.id === userId);
          const updatedUser = await SupabaseService.updateUser(userId, {
            active: !user.active
          });
          
          const updatedUsers = users.map(u => 
            u.id === userId ? updatedUser : u
          );
          setUsers(updatedUsers);
          localStorage.setItem('users', JSON.stringify(updatedUsers));
        } catch (error) {
          console.error('Error updating user:', error);
          const updatedUsers = users.map(u => 
            u.id === userId ? { ...u, active: !u.active } : u
          );
          setUsers(updatedUsers);
          localStorage.setItem('users', JSON.stringify(updatedUsers));
        }
      };

      // Helper function to get user name by ID
      const getUserName = (userId) => {
        if (!userId) return 'Not assigned';
        const user = users.find(u => u.id === userId);
        return user ? user.name : 'Unknown';
      };

      // Helper function to get class type badge color
      const getClassTypeBadge = (type) => {
        switch(type) {
          case 'lecture':
            return { label: 'Lecture', color: '#3498db', bgColor: '#ebf5fb' };
          case 'tutorial':
            return { label: 'Tutorial', color: '#2ecc71', bgColor: '#eafaf1' };
          case 'lab':
            return { label: 'Lab', color: '#e74c3c', bgColor: '#fdedec' };
          default:
            return { label: type, color: '#7f8c8d', bgColor: '#f2f3f4' };
        }
      };

      // Helper function to get class type from name
      const getClassTypeFromName = (name) => {
        if (!name) return 'unknown';
        const lowerName = name.toLowerCase();
        if (lowerName.includes('lecture')) return 'lecture';
        if (lowerName.includes('tutorial')) return 'tutorial';
        if (lowerName.includes('lab')) return 'lab';
        return 'unknown';
      };

      // Helper function to extract display code
      const getDisplayCode = (classObj) => {
        if (classObj.display_code) return classObj.display_code;
        
        // Try to extract from name or generate
        const module = modules.find(m => m.code === classObj.module_code);
        if (module) {
          const type = getClassTypeFromName(classObj.name);
          // Find other classes of same module and type to get number
          const similarClasses = classes.filter(c => 
            c.module_code === classObj.module_code && 
            getClassTypeFromName(c.name) === type
          );
          const index = similarClasses.findIndex(c => c.id === classObj.id) + 1;
          return `${module.code}_${type}_${index}`;
        }
        return 'N/A';
      };

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Welcome, {currentUser.name} (System Administrator)</h1>
            </div>
            <div>
              <button className="btn-secondary" onClick={goToProfile}>Profile</button>
              <button className="btn-danger" onClick={handleLogout}>Logout</button>
            </div>
          </header>

          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">System Administrator Dashboard</h2>
              <p className="welcome-subtitle">
                Manage users, modules, classes, and system settings
              </p>
            </section>

            <section>
              <h3>Quick Actions</h3>
              <div className="quick-actions">
                <div className="action-card">
                  <div className="action-card-icon">
                    <i className="fas fa-user-plus"></i>
                  </div>
                  <h4 className="action-card-title">Create User Account</h4>
                  <p className="action-card-description">
                    Add new students, instructors, or administrators to the system
                  </p>
                  <button className="action-btn" onClick={() => setShowAddUserPopup(true)}>
                    <i className="fas fa-plus"></i> Add User
                  </button>
                </div>
                
                <div className="action-card">
                  <div className="action-card-icon">
                    <i className="fas fa-book"></i>
                  </div>
                  <h4 className="action-card-title">Manage Modules</h4>
                  <p className="action-card-description">
                    Create and manage course modules for the academic system
                  </p>
                  <button className="action-btn" onClick={() => document.getElementById('manage-modules')?.scrollIntoView({ behavior: 'smooth' })}>
                    <i className="fas fa-arrow-right"></i> View Modules
                  </button>
                </div>
                
                <div className="action-card">
                  <div className="action-card-icon">
                    <i className="fas fa-users"></i>
                  </div>
                  <h4 className="action-card-title">Class Management</h4>
                  <p className="action-card-description">
                    Create and manage classes (lecture, tutorial, lab) for modules
                  </p>
                  <button className="action-btn" onClick={() => document.getElementById('create-class-form')?.scrollIntoView({ behavior: 'smooth' })}>
                    <i className="fas fa-arrow-right"></i> Create Class
                  </button>
                </div>
              </div>
            </section>
            
            <section id="manage-users">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h3>Manage Users ({users.length})</h3>
                <button 
                  onClick={() => setShowAddUserPopup(true)}
                  className="btn-primary"
                  style={{ display: 'flex', alignItems: 'center', gap: '8px' }}
                >
                  <i className="fas fa-plus"></i> Add User
                </button>
              </div>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', 
                gap: '20px', 
                marginTop: '20px' 
              }}>
                {users.map(u => (
                  <div key={u.id} className="item-card">
                    <h4>{u.name}</h4>
                    <p><strong>Email:</strong> {u.email}</p>
                    <p><strong>Role:</strong> {u.role}</p>
                    <p><strong>Status:</strong> {u.active ? 'âœ… Active' : 'âŒ Inactive'}</p>
                    <button 
                      onClick={() => toggleUser(u.id)}
                      className={u.active ? 'btn-danger' : 'btn-success'}
                      style={{ marginTop: '10px', width: '100%' }}
                    >
                      {u.active ? 'Deactivate Account' : 'Activate Account'}
                    </button>
                  </div>
                ))}
              </div>
            </section>
            
            <section id="create-module-form">
              <h3>Create Module</h3>
              <form onSubmit={handleModuleSubmit} className="form-container" style={{ maxWidth: '600px', margin: '0 auto' }}>
                <input 
                  type="text" 
                  placeholder="Module Name (e.g., Software Development)" 
                  value={moduleData.name} 
                  onChange={(e) => setModuleData({ ...moduleData, name: e.target.value })} 
                  required
                />
                <textarea 
                  placeholder="Module Description" 
                  value={moduleData.description} 
                  onChange={(e) => setModuleData({ ...moduleData, description: e.target.value })} 
                  required
                  rows="4"
                />
                
                {/* Instructor Selection */}
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500', color: '#333' }}>
                    Select instructor
                  </label>
                  <select 
                    value={moduleData.instructorId} 
                    onChange={(e) => setModuleData({ ...moduleData, instructorId: e.target.value })} 
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px', 
                      marginBottom: '15px',
                      border: '1px solid #ddd',
                      borderRadius: '8px',
                      fontSize: '16px',
                      backgroundColor: 'white'
                    }}
                  >
                    {users
                      .filter(user => user.role === 'Instructor' && user.active)
                      .map(instructor => (
                        <option key={instructor.id} value={instructor.id}>
                          {instructor.name} ({instructor.email})
                        </option>
                      ))
                    }
                  </select>
                </div>
                
                {/* Exam Administrator Selection */}
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500', color: '#333' }}>
                    Select Exam Administrator
                  </label>
                  <select 
                    value={moduleData.examAdminId} 
                    onChange={(e) => setModuleData({ ...moduleData, examAdminId: e.target.value })} 
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px', 
                      marginBottom: '15px',
                      border: '1px solid #ddd',
                      borderRadius: '8px',
                      fontSize: '16px',
                      backgroundColor: 'white'
                    }}
                  >
                    {users
                      .filter(user => user.role === 'Exam Administrator' && user.active)
                      .map(admin => (
                        <option key={admin.id} value={admin.id}>
                          {admin.name} ({admin.email})
                        </option>
                      ))
                    }
                  </select>
                </div>
                
                <button type="submit" className="btn-primary">Create Module</button>
              </form>
            </section>
            
            <section id="manage-modules">
              <h3>Manage Modules ({modules.length})</h3>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', 
                gap: '20px', 
                marginTop: '20px' 
              }}>
                {modules.map(m => {
                  const instructorId = m.instructor_id || m.instructorId;
                  const examAdminId = m.exam_admin_id || m.examAdminId;
                  const moduleClasses = classes.filter(c => c.module_code === m.code);
                  
                  return (
                    <div key={m.code} className="item-card">
                      <h4>{m.name}</h4>
                      <p><strong>Code:</strong> {m.code}</p>
                      <p><strong>Description:</strong> {m.description}</p>
                      <p><strong>Instructor:</strong> {getUserName(instructorId)}</p>
                      <p><strong>Exam Admin:</strong> {getUserName(examAdminId)}</p>
                      <p><strong>Total Classes:</strong> {moduleClasses.length}</p>
                      <button 
                        onClick={() => deleteModule(m.code)}
                        className="btn-danger"
                        style={{ marginTop: '10px', width: '100%' }}
                      >
                        Delete Module
                      </button>
                    </div>
                  );
                })}
              </div>
            </section>

            <section id="module-invitation">
              <h3>Module Invitation Codes</h3>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', 
                gap: '20px', 
                marginTop: '20px' 
              }}>
                {modules.map(m => {
                  const instructorId = m.instructor_id || m.instructorId;
                  const moduleClasses = classes.filter(c => c.module_code === m.code);
                  
                  return (
                    <div key={m.code} className="item-card">
                      <h4>{m.name}</h4>
                      <p><strong>Code:</strong> {m.code}</p>
                      <div className="invitation-code-display">
                        {m.invitation_code || 'No code generated'}
                      </div>
                      
                      <div className="invite-actions">
                        <button 
                          onClick={() => handleGenerateInvitationCode(m.code)}
                          className="refresh-btn"
                        >
                          <i className="fas fa-sync-alt"></i>
                          {m.invitation_code ? 'Regenerate' : 'Generate'}
                        </button>
                        
                        {m.invitation_code && (
                          <button 
                            onClick={() => copyToClipboard(m.invitation_code)}
                            className="copy-btn"
                          >
                            <i className="fas fa-copy"></i>
                            Copy Code
                          </button>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </section>
            
            {/* UPDATED: Create Class form - simplified for your schema */}
            <section id="create-class-form">
              <h3>Create Class</h3>
              <form onSubmit={handleClassSubmit} className="form-container" style={{ maxWidth: '600px', margin: '0 auto' }}>
                <input 
                  type="text" 
                  placeholder="Class Base Name (e.g., SDM Class)" 
                  value={classData.name} 
                  onChange={(e) => setClassData({ ...classData, name: e.target.value })} 
                  required
                />
                
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500', color: '#333' }}>
                    Select Module *
                  </label>
                  <select 
                    value={classData.moduleCode} 
                    onChange={(e) => setClassData({ ...classData, moduleCode: e.target.value })} 
                    required
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px', 
                      marginBottom: '15px',
                      border: '1px solid #ddd',
                      borderRadius: '8px',
                      fontSize: '16px',
                      backgroundColor: 'white'
                    }}
                  >
                    <option value="">Select Module</option>
                    {modules.map(m => (
                      <option key={m.code} value={m.code}>
                        {m.name} ({m.code})
                      </option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500', color: '#333' }}>
                    Select Class Type *
                  </label>
                  <select 
                    value={classData.classType} 
                    onChange={(e) => setClassData({ ...classData, classType: e.target.value })} 
                    required
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px', 
                      marginBottom: '15px',
                      border: '1px solid #ddd',
                      borderRadius: '8px',
                      fontSize: '16px',
                      backgroundColor: 'white'
                    }}
                  >
                    <option value="lecture">Lecture</option>
                    <option value="tutorial">Tutorial</option>
                    <option value="lab">Lab</option>
                  </select>
                </div>
                
                {/* Preview of generated class */}
                {classData.moduleCode && classData.classType && classData.name && (
                  <div style={{ 
                    padding: '12px 15px', 
                    marginBottom: '15px',
                    border: '1px solid #ddd',
                    borderRadius: '8px',
                    backgroundColor: '#f8f9fa',
                    fontSize: '14px'
                  }}>
                    <p style={{ margin: '0', fontWeight: '500' }}>Class Preview:</p>
                    <p style={{ 
                      margin: '5px 0 0 0', 
                      fontSize: '16px', 
                      fontWeight: '600',
                      color: '#667eea'
                    }}>
                      {classData.name} - {classData.classType.charAt(0).toUpperCase() + classData.classType.slice(1)} {classes.filter(c => c.module_code === classData.moduleCode).length + 1}
                    </p>
                    <p style={{ 
                      margin: '5px 0 0 0', 
                      fontSize: '14px', 
                      color: '#666'
                    }}>
                      <strong>Display Code:</strong> {classData.moduleCode}_{classData.classType}_{classes.filter(c => c.module_code === classData.moduleCode).length + 1}
                    </p>
                    <p style={{ 
                      margin: '5px 0 0 0', 
                      fontSize: '12px', 
                      color: '#666',
                      fontStyle: 'italic'
                    }}>
                      Class type will be stored in the name field
                    </p>
                  </div>
                )}
                
                <button type="submit" className="btn-primary">Create Class (Save to Database)</button>
              </form>
            </section>
            
            {/* UPDATED: Manage Classes - adapted for your schema */}
            <section id="manage-classes">
              <h3>Manage Classes ({classes.length})</h3>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', 
                gap: '20px', 
                marginTop: '20px' 
              }}>
                {classes.map(c => {
                  const module = modules.find(m => m.code === c.module_code);
                  const classType = c.class_type || getClassTypeFromName(c.name);
                  const badge = getClassTypeBadge(classType);
                  const displayCode = getDisplayCode(c);
                  
                  return (
                    <div key={c.id} className="item-card">
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                        <h4 style={{ margin: 0 }}>{c.name}</h4>
                        <span style={{
                          padding: '4px 8px',
                          backgroundColor: badge.bgColor,
                          color: badge.color,
                          borderRadius: '4px',
                          fontSize: '12px',
                          fontWeight: '600'
                        }}>
                          {badge.label}
                        </span>
                      </div>
                      <p><strong>Module:</strong> {module?.name || 'Unknown'}</p>
                      <p><strong>Display Code:</strong> {displayCode}</p>
                      <p><strong>Module Code:</strong> {c.module_code || 'N/A'}</p>
                      <p><strong>Students:</strong> {c.students?.length || 0}</p>
                      {c.created_at && (
                        <p><strong>Created:</strong> {new Date(c.created_at).toLocaleDateString()}</p>
                      )}
                      <button 
                        onClick={() => deleteClass(c.id)}
                        className="btn-danger"
                        style={{ marginTop: '10px', width: '100%' }}
                      >
                        Delete Class
                      </button>
                    </div>
                  );
                })}
              </div>
            </section>
          </main>
        </div>
      );
    };

    // ==================== HOMEPAGE (MAIN CONTROLLER) ====================
    const HomePage = () => {
      const [page, setPage] = useState('login');
      const [users, setUsers] = useState([]);
      const [assessments, setAssessments] = useState([]);
      const [submissions, setSubmissions] = useState([]);
      const [questions, setQuestions] = useState([]);
      const [modules, setModules] = useState([]);
      const [classes, setClasses] = useState([]);
      const [currentUser, setCurrentUser] = useState(null);
      const [loginData, setLoginData] = useState({ email: '', password: '' });
      const [registerData, setRegisterData] = useState({ name: '', email: '', password: '', role: '' });
      const [isLoading, setIsLoading] = useState(true);
      
      // Global popup state
      const [showAddUserPopup, setShowAddUserPopup] = useState(false);
      const [popupUserData, setPopupUserData] = useState({ name: '', email: '', password: '', role: '' });

      useEffect(() => {
        const initializeData = async () => {
          setIsLoading(true);
          
          try {
            // Try to load from Supabase first
            console.log('Loading data from Supabase...');
            
            const [
              usersData, 
              assessmentsData, 
              submissionsData, 
              questionsData, 
              modulesData, 
              classesData
            ] = await Promise.all([
              SupabaseService.getUsers(),
              SupabaseService.getAssessments(),
              SupabaseService.getSubmissions(),
              SupabaseService.getQuestions(),
              SupabaseService.getModules(),
              SupabaseService.getClasses()
            ]);
            
            console.log('Supabase data loaded:', {
              users: usersData.length,
              assessments: assessmentsData.length,
              submissions: submissionsData.length,
              questions: questionsData.length,
              modules: modulesData.length,
              classes: classesData.length
            });
            
            // If Supabase returns data, use it
            if (usersData.length > 0 || modulesData.length > 0) {
              setUsers(usersData);
              setAssessments(assessmentsData);
              setSubmissions(submissionsData);
              setQuestions(questionsData);
              setModules(modulesData);
              setClasses(classesData);
              
              // Create default data if empty
              if (usersData.length === 0) {
                await createDefaultUsers();
              }
              if (modulesData.length === 0) {
                await createDefaultModules();
              }
            } else {
              // Fallback to localStorage
              loadFromLocalStorage();
            }
            
            // Check for current user session
            const storedUser = JSON.parse(localStorage.getItem('currentUser'));
            if (storedUser) {
              setCurrentUser(storedUser);
              redirectBasedOnRole(storedUser.role);
            } else {
              setPage('login');
            }
            
          } catch (error) {
            console.error('Error loading data from Supabase:', error);
            // Fallback to localStorage
            loadFromLocalStorage();
          } finally {
            setIsLoading(false);
          }
        };
        
        initializeData();
      }, []);

      const loadFromLocalStorage = () => {
        console.log('Loading from localStorage...');
        const storedUsers = JSON.parse(localStorage.getItem('users')) || [];
        const storedAssessments = JSON.parse(localStorage.getItem('assessments')) || [];
        const storedSubmissions = JSON.parse(localStorage.getItem('submissions')) || [];
        const storedQuestions = JSON.parse(localStorage.getItem('questions')) || [];
        const storedModules = JSON.parse(localStorage.getItem('modules')) || [];
        const storedClasses = JSON.parse(localStorage.getItem('classes')) || [];
        
        // Create defaults if empty
        let updatedUsers = storedUsers;
        if (storedUsers.length === 0) {
          updatedUsers = createDefaultUsersLocal();
          localStorage.setItem('users', JSON.stringify(updatedUsers));
        }
        
        let updatedModules = storedModules;
        if (storedModules.length === 0) {
          updatedModules = createDefaultModulesLocal();
          localStorage.setItem('modules', JSON.stringify(updatedModules));
        }
        
        let updatedClasses = storedClasses;
        if (storedClasses.length === 0 && updatedModules.length > 0) {
          updatedClasses = createDefaultClassesLocal(updatedModules);
          localStorage.setItem('classes', JSON.stringify(updatedClasses));
        }
        
        setUsers(updatedUsers);
        setAssessments(storedAssessments);
        setSubmissions(storedSubmissions);
        setQuestions(storedQuestions);
        setModules(updatedModules);
        setClasses(updatedClasses);
      };

      const createDefaultModulesLocal = () => {
        return [
          { 
            code: 'NWT-112025-01', 
            name: 'Networking Technologies', 
            description: 'Basic networking concepts and technologies',
            instructor_id: null,
            exam_admin_id: null 
          },
          { 
            code: 'OOP-112025-02', 
            name: 'Object-Oriented Programming', 
            description: 'Advanced object-oriented programming concepts',
            instructor_id: null,
            exam_admin_id: null 
          },
          { 
            code: 'SDM-112025-03', 
            name: 'Software Development Methods', 
            description: 'Software development methodologies and practices',
            instructor_id: null,
            exam_admin_id: null 
          }
        ];
      };

      const createDefaultClassesLocal = (modules) => {
        return [
          { 
            id: Date.now(), 
            name: 'Networking Technologies - Lecture 1', 
            module_code: 'NWT-112025-01', 
            class_type: 'lecture',
            students: [],
            display_code: 'NWT-112025-01_lecture_1',
            created_at: new Date().toISOString()
          },
          { 
            id: Date.now() + 1, 
            name: 'Object-Oriented Programming - Tutorial 1', 
            module_code: 'OOP-112025-02', 
            class_type: 'tutorial',
            students: [],
            display_code: 'OOP-112025-02_tutorial_1',
            created_at: new Date().toISOString()
          },
          { 
            id: Date.now() + 2, 
            name: 'Software Development Methods - Lab 1', 
            module_code: 'SDM-112025-03', 
            class_type: 'lab',
            students: [],
            display_code: 'SDM-112025-03_lab_1',
            created_at: new Date().toISOString()
          }
        ];
      };

      const createDefaultUsers = async () => {
        const defaultUsers = [
          {
            id: 1,
            name: 'System Administrator',
            email: 'admin@educonnect.com',
            password: 'admin123',
            role: 'System Administrator',
            active: true
          },
          {
            id: 2,
            name: 'John Student',
            email: 'student@educonnect.com',
            password: 'student123',
            role: 'Student',
            active: true
          },
          {
            id: 3,
            name: 'Dr. Instructor',
            email: 'instructor@educonnect.com',
            password: 'instructor123',
            role: 'Instructor',
            active: true
          },
          {
            id: 4,
            name: 'Exam Admin',
            email: 'exam@educonnect.com',
            password: 'exam123',
            role: 'Exam Administrator',
            active: true
          }
        ];
        
        for (const user of defaultUsers) {
          try {
            await SupabaseService.createUser(user);
          } catch (error) {
            console.error('Error creating default user:', error);
          }
        }
        
        return defaultUsers;
      };

      const createDefaultUsersLocal = () => {
        return [
          {
            id: 1,
            name: 'System Administrator',
            email: 'admin@educonnect.com',
            password: 'admin123',
            role: 'System Administrator',
            active: true
          },
          {
            id: 2,
            name: 'John Student',
            email: 'student@educonnect.com',
            password: 'student123',
            role: 'Student',
            active: true
          },
          {
            id: 3,
            name: 'Dr. Instructor',
            email: 'instructor@educonnect.com',
            password: 'instructor123',
            role: 'Instructor',
            active: true
          },
          {
            id: 4,
            name: 'Exam Admin',
            email: 'exam@educonnect.com',
            password: 'exam123',
            role: 'Exam Administrator',
            active: true
          }
        ];
      };

      const createDefaultModules = async () => {
        const defaultModules = [
          { 
            code: 'NWT-112025-01', 
            name: 'Networking Technologies', 
            description: 'Basic networking concepts and technologies',
            instructor_id: null,
            exam_admin_id: null 
          },
          { 
            code: 'OOP-112025-02', 
            name: 'Object-Oriented Programming', 
            description: 'Advanced object-oriented programming concepts',
            instructor_id: null,
            exam_admin_id: null 
          },
          { 
            code: 'SDM-112025-03', 
            name: 'Software Development Methods', 
            description: 'Software development methodologies and practices',
            instructor_id: null,
            exam_admin_id: null 
          }
        ];
        
        for (const module of defaultModules) {
          try {
            await SupabaseService.createModule(module);
          } catch (error) {
            console.error('Error creating default module:', error);
          }
        }
        
        return defaultModules;
      };

      const redirectBasedOnRole = (role) => {
        if (role === 'Student') {
          setPage('student-dashboard');
        } else if (role === 'Instructor') {
          setPage('instructor-dashboard');
        } else if (role === 'Exam Administrator') {
          setPage('exam-admin-dashboard');
        } else if (role === 'System Administrator') {
          setPage('admin-dashboard');
        } else {
          console.warn('Unknown role:', role);
          setPage('login');
        }
      };

      const handlePopupUserSubmit = async (e) => {
        e.preventDefault();
        
        try {
          // Check if user exists in Supabase
          const exists = await SupabaseService.userExists(popupUserData.email);
          if (exists) {
            alert('User already exists');
            return;
          }
          
          const newUser = { 
            id: Date.now(), 
            name: popupUserData.name, 
            email: popupUserData.email, 
            password: popupUserData.password, 
            role: popupUserData.role, 
            active: true 
          };
          
          const createdUser = await SupabaseService.createUser(newUser);
          const updatedUsers = [...users, createdUser];
          setUsers(updatedUsers);
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          setPopupUserData({ name: '', email: '', password: '', role: '' });
          setShowAddUserPopup(false);
          alert('User created successfully');
          window.location.reload();
        } catch (error) {
          console.error('Error creating user:', error);
          // Fallback to localStorage
          if (users.find(u => u.email === popupUserData.email)) {
            alert('User already exists');
            return;
          }
          const newUser = { 
            id: Date.now(), 
            name: popupUserData.name, 
            email: popupUserData.email, 
            password: popupUserData.password, 
            role: popupUserData.role, 
            active: true 
          };
          const updatedUsers = [...users, newUser];
          setUsers(updatedUsers);
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          setPopupUserData({ name: '', email: '', password: '', role: '' });
          setShowAddUserPopup(false);
          alert('User created (local)');
          window.location.reload();
        }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        
        try {
          // Try Supabase login first
          const user = await SupabaseService.loginUser(loginData.email, loginData.password);
          
          if (user) {
            console.log('User found via Supabase:', user.name);
            setCurrentUser(user);
            localStorage.setItem('currentUser', JSON.stringify(user));
            redirectBasedOnRole(user.role);
            return;
          }
        } catch (supabaseError) {
          console.log('Supabase login failed, trying local...');
          // Supabase login failed, try local storage
        }
        
        // Fallback to local storage
        const localUser = users.find(u => 
          u.email === loginData.email && 
          u.password === loginData.password && 
          u.active !== false
        );
        
        if (localUser) {
          console.log('User found locally:', localUser.name);
          setCurrentUser(localUser);
          localStorage.setItem('currentUser', JSON.stringify(localUser));
          redirectBasedOnRole(localUser.role);
        } else {
          console.log('Login failed - no matching user found');
          alert('Invalid credentials. Please try again.');
        }
      };

      const handleRegister = async (e) => {
        e.preventDefault();
        
        try {
          // Check if user exists in Supabase
          const exists = await SupabaseService.userExists(registerData.email);
          if (exists) {
            alert('User already exists with this email');
            return;
          }
          
          const newUser = { 
            id: Date.now(), 
            name: registerData.name, 
            email: registerData.email, 
            password: registerData.password, 
            role: registerData.role, 
            active: true 
          };
          
          const createdUser = await SupabaseService.createUser(newUser);
          const updatedUsers = [...users, createdUser];
          setUsers(updatedUsers);
          setCurrentUser(createdUser);
          
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          localStorage.setItem('currentUser', JSON.stringify(createdUser));
          
          console.log('New user registered:', createdUser);
          redirectBasedOnRole(createdUser.role);
          
        } catch (error) {
          console.error('Registration error:', error);
          // Fallback to localStorage
          const existingUser = users.find(u => u.email === registerData.email);
          if (existingUser) {
            alert('User already exists with this email');
            return;
          }
          
          const newUser = { 
            id: Date.now(), 
            name: registerData.name, 
            email: registerData.email, 
            password: registerData.password, 
            role: registerData.role, 
            active: true 
          };
          
          const updatedUsers = [...users, newUser];
          setUsers(updatedUsers);
          setCurrentUser(newUser);
          
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          localStorage.setItem('currentUser', JSON.stringify(newUser));
          
          console.log('New user registered (local):', newUser);
          redirectBasedOnRole(newUser.role);
        }
      };

      const handleLogout = () => {
        console.log('Logging out user:', currentUser?.name);
        setCurrentUser(null);
        localStorage.removeItem('currentUser');
        setPage('login');
        setLoginData({ email: '', password: '' });
      };

      const goToRegister = () => {
        console.log('Going to register page');
        setPage('register');
        setRegisterData({ name: '', email: '', password: '', role: '' });
      };

      const goToLogin = () => {
        console.log('Going to login page');
        setPage('login');
        setLoginData({ email: '', password: '' });
      };

      const goToProfile = () => {
        console.log('Going to profile page');
        setPage('profile');
      };

      const goBack = () => {
        console.log('Going back from profile');
        if (!currentUser) {
          setPage('login');
          return;
        }
        redirectBasedOnRole(currentUser.role);
      };

      // Show loading screen
      if (isLoading) {
        return (
          <div className="loading-screen">
            <div className="loading-spinner"></div>
            <h2>Loading EduConnect System...</h2>
            <p>Please wait while we initialize the application.</p>
          </div>
        );
      }

      // Render the appropriate page based on state
      switch(page) {
        case 'login':
          return (
            <LoginPage 
              loginData={loginData} 
              setLoginData={setLoginData} 
              handleLogin={handleLogin} 
              goToRegister={goToRegister} 
            />
          );
          
        case 'register':
          return (
            <RegisterPage 
              registerData={registerData} 
              setRegisterData={setRegisterData} 
              handleRegister={handleRegister} 
              goToLogin={goToLogin} 
            />
          );
          
        case 'student-dashboard':
          return (
            <StudentDashboard 
              currentUser={currentUser} 
              assessments={assessments} 
              submissions={submissions} 
              questions={questions} 
              setSubmissions={setSubmissions} 
              setQuestions={setQuestions} 
              handleLogout={handleLogout} 
              goToProfile={goToProfile}
              modules={modules}
              classes={classes}
              setClasses={setClasses}
            />
          );
          
        case 'instructor-dashboard':
          return (
            <InstructorDashboard 
              currentUser={currentUser} 
              assessments={assessments} 
              submissions={submissions} 
              questions={questions} 
              setAssessments={setAssessments} 
              setSubmissions={setSubmissions} 
              setQuestions={setQuestions} 
              handleLogout={handleLogout} 
              goToProfile={goToProfile}
              modules={modules}
              setModules={setModules}
            />
          );
          
        case 'exam-admin-dashboard':
          return (
            <ExamAdminDashboard 
              currentUser={currentUser} 
              assessments={assessments} 
              submissions={submissions} 
              users={users}
              handleLogout={handleLogout} 
              goToProfile={goToProfile} 
            />
          );
          
        case 'admin-dashboard':
          return (
            <>
              <SystemAdminDashboard 
                currentUser={currentUser} 
                users={users} 
                setUsers={setUsers}
                modules={modules}
                setModules={setModules}
                classes={classes}
                setClasses={setClasses}
                handleLogout={handleLogout} 
                goToProfile={goToProfile}
                showAddUserPopup={showAddUserPopup}
                setShowAddUserPopup={setShowAddUserPopup}
                popupUserData={popupUserData}
                setPopupUserData={setPopupUserData}
                handlePopupUserSubmit={handlePopupUserSubmit}
              />
              <GlobalAddUserPopup 
                show={showAddUserPopup}
                onClose={() => setShowAddUserPopup(false)}
                userData={popupUserData}
                setUserData={setPopupUserData}
                onSubmit={handlePopupUserSubmit}
              />
            </>
          );
          
        case 'profile':
          return (
            <ProfilePage 
              currentUser={currentUser} 
              setCurrentUser={setCurrentUser} 
              users={users} 
              setUsers={setUsers} 
              goBack={goBack} 
              handleLogout={handleLogout} 
            />
          );
          
        default:
          return (
            <div className="error-page">
              <h2>Page Not Found</h2>
              <p>The page "{page}" could not be found.</p>
              <button onClick={goToLogin} className="btn-primary">
                Go to Login Page
              </button>
            </div>
          );
      }
    };

    // Main App Component
    function App() {
      return (
        <div className="App">
          <HomePage />
        </div>
      );
    }

    // Render the app
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>