<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduConnect Learning Centre</title>
  <link rel="icon" href="Images/Logo.png" type="image/png">
  <link rel="stylesheet" href="App.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Global popup styles */
    .global-popup-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background-color: rgba(0, 0, 0, 0.7) !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      z-index: 9999 !important;
    }
    
    .global-popup-content {
      background: white !important;
      padding: 30px !important;
      border-radius: 15px !important;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
      width: 90% !important;
      max-width: 500px !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
    }
    
    .global-popup-content form {
      display: flex !important;
      flex-direction: column !important;
      gap: 15px !important;
    }
    
    .global-popup-content input,
    .global-popup-content select {
      padding: 12px 15px !important;
      border: 1px solid #ddd !important;
      border-radius: 8px !important;
      font-size: 16px !important;
      transition: border-color 0.3s !important;
    }
    
    .global-popup-content input:focus,
    .global-popup-content select:focus {
      outline: none !important;
      border-color: #667eea !important;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1) !important;
    }
    
    /* Fix body overflow */
    body.popup-open {
      overflow: hidden !important;
    }

    /* Login alert styling */
    .login-alert-credentials {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    
    .login-alert-credentials h4 {
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .login-alert-credentials p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }

    /* Loading screen styles */
    .loading-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 20px;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    /* Invitation code styles */
    .invitation-code-display {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
      font-size: 24px;
      letter-spacing: 2px;
      font-weight: bold;
    }
    
    .invite-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .copy-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.3s;
    }
    
    .copy-btn:hover {
      background-color: #45a049;
    }
    
    .refresh-btn {
      background-color: #ff9800;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.3s;
    }
    
    .refresh-btn:hover {
      background-color: #e68900;
    }
    
    .join-module-form {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #667eea;
    }
    
    .no-class-found {
      background-color: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }

    /* Tab styles */
    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: #667eea;
      background-color: rgba(102, 126, 234, 0.05);
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }

    .tab-content {
      animation: fadeIn 0.3s ease-out;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background-color: #f8f9fa;
      border-radius: 12px;
      border: 2px dashed #dee2e6;
    }

    .empty-state h4 {
      color: #495057;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #6c757d;
      max-width: 500px;
      margin: 0 auto;
    }

    /* Status badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .status-draft { background-color: #f39c12; color: white; }
    .status-submitted { background-color: #3498db; color: white; }
    .status-graded { background-color: #f39c12; color: white; }
    .status-released { background-color: #2ecc71; color: white; }
    .status-needs_revision { background-color: #e74c3c; color: white; }

    /* Type badges */
    .type-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .type-assignment { background-color: #3498db; color: white; }
    .type-quiz { background-color: #9b59b6; color: white; }
    .type-exam { background-color: #e74c3c; color: white; }
    .type-project { background-color: #1abc9c; color: white; }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="global-popup-container"></div>
  
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Supabase configuration
    const supabaseUrl = 'https://etilwlveocqsozzuizil.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0aWx3bHZlb2Nxc296enVpemlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDc0NTQsImV4cCI6MjA4MjY4MzQ1NH0.VY_acdqcgBFXxXCfUUCIGKKrDRYqZmFTpsNj9_h2pm0';
    
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
    
    // ==================== SUPABASE SERVICE ====================
    const SupabaseService = {
      // Users
      async getUsers() {
        try {
          const { data, error } = await supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching users:', error);
          return [];
        }
      },
      
      async createUser(user) {
        try {
          const { data, error } = await supabase
            .from('users')
            .insert([user])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating user:', error);
          throw error;
        }
      },
      
      async updateUser(userId, updates) {
        try {
          const { data, error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', userId)
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error updating user:', error);
          throw error;
        }
      },
      
      async userExists(email) {
        try {
          const { data, error } = await supabase
            .from('users')
            .select('id')
            .eq('email', email)
            .single();
          
          return !error && data !== null;
        } catch (error) {
          return false;
        }
      },
      
      async loginUser(email, password) {
        try {
          const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .eq('active', true)
            .single();
          
          if (error) throw error;
          return data;
        } catch (error) {
          console.error('Login error:', error);
          throw error;
        }
      },
      
      // Modules
      async getModules() {
        try {
          const { data, error } = await supabase
            .from('modules')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching modules:', error);
          return [];
        }
      },
      
      async createModule(module) {
        try {
          const supabaseModule = {
            code: module.code,
            name: module.name,
            description: module.description,
            instructor_id: module.instructor_id || module.instructorId || null,
            exam_admin_id: module.exam_admin_id || module.examAdminId || null,
            invitation_code: module.invitation_code
          };
          
          const { data, error } = await supabase
            .from('modules')
            .insert([supabaseModule])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating module:', error);
          throw error;
        }
      },
      
      async deleteModule(moduleCode) {
        try {
          const { error } = await supabase
            .from('modules')
            .delete()
            .eq('code', moduleCode);
          
          if (error) throw error;
        } catch (error) {
          console.error('Error deleting module:', error);
          throw error;
        }
      },
      
      // Classes
      async getClasses() {
        try {
          const { data, error } = await supabase
            .from('classes')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching classes:', error);
          return [];
        }
      },
      
      async createClass(classData) {
        try {
          const supabaseClass = {
            name: classData.name,
            module_code: classData.module_code,
            students: classData.students || []
          };
          
          const { data, error } = await supabase
            .from('classes')
            .insert([supabaseClass])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating class:', error);
          throw error;
        }
      },
      
      async deleteClass(classId) {
        try {
          const { error } = await supabase
            .from('classes')
            .delete()
            .eq('id', classId);
          
          if (error) throw error;
        } catch (error) {
          console.error('Error deleting class:', error);
          throw error;
        }
      },
      
      // Assessments
      async getAssessments() {
        try {
          const { data, error } = await supabase
            .from('assessments')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching assessments:', error);
          return [];
        }
      },
      
      async createAssessment(assessment) {
        try {
          const dbAssessment = {
            module_code: assessment.moduleCode || assessment.module_code,
            title: assessment.title,
            description: assessment.description,
            type: assessment.type || 'assignment',
            due_date: assessment.dueDate || assessment.due_date,
            max_marks: assessment.maxMarks || assessment.max_marks,
            criteria: assessment.criteria || '',
            instructor_id: assessment.instructorId || assessment.instructor_id,
            file_name: assessment.fileName || assessment.file_name,
            file_path: assessment.fileUrl || assessment.file_path,
            status: assessment.status || 'draft',
            approved_by_exam_admin: assessment.approvedByExamAdmin || assessment.approved_by_exam_admin || false,
            created_at: assessment.createdAt || assessment.created_at || new Date().toISOString()
          };

          // Remove undefined/null values
          Object.keys(dbAssessment).forEach(key => {
            if (dbAssessment[key] === undefined || dbAssessment[key] === null) {
              delete dbAssessment[key];
            }
          });

          const { data, error } = await supabase
            .from('assessments')
            .insert([dbAssessment])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating assessment:', error);
          throw error;
        }
      },

      async updateAssessment(assessmentId, updates) {
        try {
          const { data, error } = await supabase
            .from('assessments')
            .update(updates)
            .eq('id', assessmentId)
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error updating assessment:', error);
          throw error;
        }
      },

      async deleteAssessment(assessmentId) {
        try {
          const { error } = await supabase
            .from('assessments')
            .delete()
            .eq('id', assessmentId);
          
          if (error) throw error;
        } catch (error) {
          console.error('Error deleting assessment:', error);
          throw error;
        }
      },
      
      // Submissions
      async getSubmissions() {
        try {
          const { data, error } = await supabase
            .from('submissions')
            .select('*')
            .order('submitted_at', { ascending: false }); // Changed to 'submitted_at'
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching submissions:', error);
          return [];
        }
      },
      
      async createSubmission(submission) {
        try {
          // Convert camelCase to snake_case for database
          const dbSubmission = {
            assessment_id: submission.assessmentId || submission.assessment_id,
            student_id: submission.studentId || submission.student_id,
            file_name: submission.fileName || submission.file_name,
            file_path: submission.fileUrl || submission.file_path,
            submitted_at: submission.submittedAt || submission.submitted_at || new Date().toISOString(),
            status: submission.status || 'submitted',
            grade: submission.grade,
            feedback: submission.feedback || '',
            marked_by: submission.markedBy || submission.marked_by,
            marked_at: submission.markedAt || submission.marked_at,
            approved_by_exam_admin: submission.approvedByExamAdmin || submission.approved_by_exam_admin || false,
            released_to_student: submission.releasedToStudent || submission.released_to_student || false,
            updated_at: new Date().toISOString() // Always set updated_at
          };

          // Remove undefined/null values
          Object.keys(dbSubmission).forEach(key => {
            if (dbSubmission[key] === undefined) {
              delete dbSubmission[key];
            }
          });

          const { data, error } = await supabase
            .from('submissions')
            .insert([dbSubmission])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating submission:', error);
          throw error;
        }
      },
      
      async updateSubmission(submissionId, updates) {
        try {
          // Convert camelCase to snake_case
          const dbUpdates = {};
          
          // Map camelCase to snake_case
          if (updates.assessmentId !== undefined) dbUpdates.assessment_id = updates.assessmentId;
          if (updates.studentId !== undefined) dbUpdates.student_id = updates.studentId;
          if (updates.fileName !== undefined) dbUpdates.file_name = updates.fileName;
          if (updates.fileUrl !== undefined) dbUpdates.file_path = updates.fileUrl;
          if (updates.submittedAt !== undefined) dbUpdates.submitted_at = updates.submittedAt;
          if (updates.status !== undefined) dbUpdates.status = updates.status;
          if (updates.grade !== undefined) dbUpdates.grade = updates.grade;
          if (updates.feedback !== undefined) dbUpdates.feedback = updates.feedback;
          if (updates.markedBy !== undefined) dbUpdates.marked_by = updates.markedBy;
          if (updates.markedAt !== undefined) dbUpdates.marked_at = updates.markedAt;
          if (updates.approvedByExamAdmin !== undefined) dbUpdates.approved_by_exam_admin = updates.approvedByExamAdmin;
          if (updates.releasedToStudent !== undefined) dbUpdates.released_to_student = updates.releasedToStudent;
          
          // Also handle snake_case directly
          if (updates.assessment_id !== undefined) dbUpdates.assessment_id = updates.assessment_id;
          if (updates.student_id !== undefined) dbUpdates.student_id = updates.student_id;
          if (updates.file_name !== undefined) dbUpdates.file_name = updates.file_name;
          if (updates.file_path !== undefined) dbUpdates.file_path = updates.file_path;
          if (updates.submitted_at !== undefined) dbUpdates.submitted_at = updates.submitted_at;
          if (updates.marked_by !== undefined) dbUpdates.marked_by = updates.marked_by;
          if (updates.marked_at !== undefined) dbUpdates.marked_at = updates.marked_at;
          if (updates.approved_by_exam_admin !== undefined) dbUpdates.approved_by_exam_admin = updates.approved_by_exam_admin;
          if (updates.released_to_student !== undefined) dbUpdates.released_to_student = updates.released_to_student;
          
          // Always update the updated_at timestamp
          dbUpdates.updated_at = new Date().toISOString();

          const { data, error } = await supabase
            .from('submissions')
            .update(dbUpdates)
            .eq('id', submissionId)
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error updating submission:', error);
          throw error;
        }
      },
      
      // Questions
      async getQuestions() {
        try {
          const { data, error } = await supabase
            .from('questions')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching questions:', error);
          return [];
        }
      },
      
      async createQuestion(question) {
        try {
          const { data, error } = await supabase
            .from('questions')
            .insert([question])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating question:', error);
          throw error;
        }
      },
      
      async updateQuestion(questionId, updates) {
        try {
          const { data, error } = await supabase
            .from('questions')
            .update(updates)
            .eq('id', questionId)
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error updating question:', error);
          throw error;
        }
      },

      // Teaching Materials
      async getTeachingMaterials() {
        try {
          const { data, error } = await supabase
            .from('teaching_materials')
            .select('*')
            .order('uploaded_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching teaching materials:', error);
          return [];
        }
      },
      
      async createTeachingMaterial(material) {
        try {
          const { data, error } = await supabase
            .from('teaching_materials')
            .insert([material])
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error creating teaching material:', error);
          throw error;
        }
      },
      
      async deleteTeachingMaterial(materialId) {
        try {
          const { error } = await supabase
            .from('teaching_materials')
            .delete()
            .eq('id', materialId);
          
          if (error) throw error;
        } catch (error) {
          console.error('Error deleting teaching material:', error);
          throw error;
        }
      },

      // Invitation Code Functions
      generateInvitationCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let invitation_code = '';
        for (let i = 0; i < 8; i++) {
          invitation_code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return invitation_code;
      },
      
      async checkInvitationCodeExists(invitationCode) {
        try {
          const { data, error } = await supabase
            .from('modules')
            .select('invitation_code')
            .eq('invitation_code', invitationCode)
            .single();
          
          return data !== null;
        } catch (error) {
          return false;
        }
      },
      
      async generateUniqueInvitationCode(maxAttempts = 10) {
        let attempts = 0;
        
        while (attempts < maxAttempts) {
          const code = this.generateInvitationCode();
          const exists = await this.checkInvitationCodeExists(code);
          
          if (!exists) {
            return code;
          }
          
          attempts++;
        }
        
        const timestamp = Date.now().toString().slice(-4);
        const baseCode = this.generateInvitationCode().slice(0, 4);
        return baseCode + timestamp;
      },
      
      async updateModuleInvitationCode(moduleCode, invitationCode) {
        try {
          const { data, error } = await supabase
            .from('modules')
            .update({ 
              invitation_code: invitationCode,
              updated_at: new Date().toISOString()
            })
            .eq('code', moduleCode)
            .select();
          
          if (error) throw error;
          return data[0];
        } catch (error) {
          console.error('Error updating invitation code:', error);
          throw error;
        }
      },
      
      async findModuleByInvitationCode(invitationCode) {
        try {
          const { data, error } = await supabase
            .from('modules')
            .select('*')
            .eq('invitation_code', invitationCode)
            .single();
          
          if (error) return null;
          return data;
        } catch (error) {
          return null;
        }
      },
      
      async getModuleByCode(moduleCode) {
        try {
          const { data, error } = await supabase
            .from('modules')
            .select('*')
            .eq('code', moduleCode)
            .single();
          
          if (error) throw error;
          return data;
        } catch (error) {
          console.error('Error getting module:', error);
          throw error;
        }
      },
      
      async addStudentToClass(classId, studentId) {
        try {
          const { data: classData, error: fetchError } = await supabase
            .from('classes')
            .select('students')
            .eq('id', classId)
            .single();
          
          if (fetchError) throw fetchError;
          
          const students = classData.students || [];
          if (!students.includes(parseInt(studentId))) {
            students.push(parseInt(studentId));
            
            const { data, error } = await supabase
              .from('classes')
              .update({ 
                students: students,
                updated_at: new Date().toISOString()
              })
              .eq('id', classId)
              .select();
            
            if (error) throw error;
            return data[0];
          }
          return classData;
        } catch (error) {
          console.error('Error adding student to class:', error);
          throw error;
        }
      },
      
      async getClassesForModule(moduleCode) {
        try {
          const { data, error } = await supabase
            .from('classes')
            .select('*')
            .eq('module_code', moduleCode);
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Error fetching classes for module:', error);
          return [];
        }
      }
    };

    // ==================== GLOBAL POPUP COMPONENT ====================
    const GlobalAddUserPopup = ({ show, onClose, userData, setUserData, onSubmit }) => {
      if (!show) return null;
      
      useEffect(() => {
        document.body.classList.add('popup-open');
        return () => {
          document.body.classList.remove('popup-open');
        };
      }, []);
      
      return ReactDOM.createPortal(
        <div className="global-popup-overlay">
          <div className="global-popup-content">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h2 style={{
                fontSize: '28px',
                fontWeight: '300',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                margin: 0
              }}>
                Add New User
              </h2>
              <button 
                onClick={onClose}
                style={{ 
                  background: 'none', 
                  border: 'none', 
                  fontSize: '28px', 
                  cursor: 'pointer', 
                  color: '#666',
                  width: '40px',
                  height: '40px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '50%',
                  transition: 'background-color 0.3s'
                }}
              >
                Ã—
              </button>
            </div>
            
            <form onSubmit={onSubmit}>
              <input 
                type="text" 
                placeholder="Full Name" 
                value={userData.name} 
                onChange={e => setUserData({ ...userData, name: e.target.value })} 
                required
              />
              <input 
                type="email" 
                placeholder="Email Address" 
                value={userData.email} 
                onChange={e => setUserData({ ...userData, email: e.target.value })} 
                required
              />
              <input 
                type="password" 
                placeholder="Password" 
                value={userData.password} 
                onChange={e => setUserData({ ...userData, password: e.target.value })} 
                required
              />
              <select 
                value={userData.role} 
                onChange={e => setUserData({ ...userData, role: e.target.value })} 
                required
              >
                <option value="">Select Role</option>
                <option value="Student">Student</option>
                <option value="Instructor">Instructor</option>
                <option value="System Administrator">System Administrator</option>
                <option value="Exam Administrator">Exam Administrator</option>
              </select>
              <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                <button type="submit" className="btn-primary" style={{ flex: 1 }}>Create User</button>
                <button type="button" onClick={onClose} className="btn-secondary" style={{ flex: 1 }}>Cancel</button>
              </div>
            </form>
          </div>
        </div>,
        document.getElementById('global-popup-container')
      );
    };

    // ==================== MODULE CARD COMPONENT ====================
    const ModuleCard = ({ 
      module, 
      userRole, 
      currentUser, 
      classes = [], 
      assessments = [],
      submissions = [],
      onClick
    }) => {
      const getModuleStats = () => {
        const moduleAssessments = assessments.filter(a => 
          a.moduleCode === module.code || a.course === module.name
        );
        const moduleClasses = classes.filter(c => c.module_code === module.code);
        
        if (userRole === 'Student') {
          const studentSubmissions = submissions.filter(s => 
            s.studentId === currentUser.id && 
            moduleAssessments.some(a => a.id === s.assessmentId)
          );
          const pendingGrades = studentSubmissions.filter(s => !s.releasedToStudent && s.grade !== null);
          const releasedGrades = studentSubmissions.filter(s => s.releasedToStudent);
          
          return {
            totalAssessments: moduleAssessments.length,
            yourSubmissions: studentSubmissions.length,
            pendingGrades: pendingGrades.length,
            releasedGrades: releasedGrades.length,
            classesEnrolled: moduleClasses.filter(c => 
              c.students && c.students.includes(parseInt(currentUser.id))
            ).length
          };
        } else if (userRole === 'Instructor') {
          const moduleSubmissions = submissions.filter(s => 
            moduleAssessments.some(a => a.id === s.assessmentId)
          );
          const pendingGrading = moduleSubmissions.filter(s => s.status === 'submitted');
          const needsRevision = moduleSubmissions.filter(s => s.status === 'needs_revision');
          
          return {
            totalAssessments: moduleAssessments.length,
            totalClasses: moduleClasses.length,
            pendingGrading: pendingGrading.length,
            needsRevision: needsRevision.length,
            graded: moduleSubmissions.filter(s => s.status === 'graded').length
          };
        } else if (userRole === 'Exam Administrator') {
          const moduleSubmissions = submissions.filter(s => 
            moduleAssessments.some(a => a.id === s.assessmentId)
          );
          const pendingApproval = moduleSubmissions.filter(s => s.status === 'graded' && !s.approvedByExamAdmin);
          const approved = moduleSubmissions.filter(s => s.approvedByExamAdmin);
          
          return {
            totalAssessments: moduleAssessments.length,
            pendingApproval: pendingApproval.length,
            approved: approved.length,
            released: moduleSubmissions.filter(s => s.releasedToStudent).length
          };
        }
        
        return {};
      };

      const stats = getModuleStats();
      
      return (
        <div className="item-card" onClick={onClick} style={{ cursor: 'pointer' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
            <div style={{ flex: 1 }}>
              <h4>{module.name}</h4>
              <p style={{ color: '#666', marginBottom: '10px' }}>{module.code}</p>
              <p style={{ fontSize: '14px', marginBottom: '15px' }}>{module.description}</p>
            </div>
            <span style={{
              padding: '4px 8px',
              backgroundColor: '#667eea',
              color: 'white',
              borderRadius: '4px',
              fontSize: '12px',
              fontWeight: '600'
            }}>
              {userRole}
            </span>
          </div>
          
          <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', 
            gap: '10px',
            marginTop: '15px',
            paddingTop: '15px',
            borderTop: '1px solid #eee'
          }}>
            {userRole === 'Student' && (
              <>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Assessments</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#3498db' }}>
                    {stats.totalAssessments}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Your Submissions</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#2ecc71' }}>
                    {stats.yourSubmissions}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Pending Grades</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#f39c12' }}>
                    {stats.pendingGrades}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Released</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#9b59b6' }}>
                    {stats.releasedGrades}
                  </p>
                </div>
              </>
            )}
            
            {userRole === 'Instructor' && (
              <>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Classes</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#3498db' }}>
                    {stats.totalClasses}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>To Grade</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#e74c3c' }}>
                    {stats.pendingGrading}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Needs Revision</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#f39c12' }}>
                    {stats.needsRevision}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Graded</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#2ecc71' }}>
                    {stats.graded}
                  </p>
                </div>
              </>
            )}
            
            {userRole === 'Exam Administrator' && (
              <>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Assessments</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#3498db' }}>
                    {stats.totalAssessments}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>To Approve</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#e74c3c' }}>
                    {stats.pendingApproval}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Approved</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#2ecc71' }}>
                    {stats.approved}
                  </p>
                </div>
                <div style={{ textAlign: 'center' }}>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>Released</p>
                  <p style={{ margin: '5px 0 0 0', fontSize: '18px', fontWeight: '600', color: '#9b59b6' }}>
                    {stats.released}
                  </p>
                </div>
              </>
            )}
          </div>
          
          <div style={{ marginTop: '15px', textAlign: 'center' }}>
            <button className="btn-primary" style={{ width: '100%' }}>
              <i className="fas fa-external-link-alt"></i> Open Module
            </button>
          </div>
        </div>
      );
    };

    // ==================== MODULE PAGE COMPONENT ====================
    const ModulePage = ({ 
      currentUser, 
      modules = [], 
      assessments = [], 
      submissions = [], 
      questions = [], 
      users = [],
      teachingMaterials = [],
      setAssessments = () => {},
      setSubmissions = () => {},
      setTeachingMaterials = () => {},
      setQuestions = () => {},
      handleLogout = () => {},
      goToProfile = () => {},
      goBack = () => {}
    }) => {
      const [currentModule, setCurrentModule] = useState(null);
      const [activeTab, setActiveTab] = useState('overview');
      const [newMaterial, setNewMaterial] = useState({ title: '', description: '', file: null });
      const [newAssessment, setNewAssessment] = useState({ 
        title: '', 
        description: '', 
        type: 'assignment', 
        dueDate: '', 
        maxMarks: 100,
        criteria: '',
        file: null 
      });
      const [selectedFile, setSelectedFile] = useState(null);
      const [gradingData, setGradingData] = useState({});
      const [approvalStatus, setApprovalStatus] = useState({});

      // Debug: Log everything on component mount
      useEffect(() => {
        console.log('=== MODULE PAGE MOUNTED ===');
        console.log('Current user:', currentUser);
        console.log('All modules:', modules);
        console.log('All assessments:', assessments);
        console.log('Assessments count:', assessments.length);
        
        // Check each assessment's module reference
        if (assessments.length > 0) {
          console.log('=== ASSESSMENT MODULE REFERENCES ===');
          assessments.forEach((a, i) => {
            console.log(`Assessment ${i} (ID: ${a.id}):`, {
              title: a.title,
              module_code: a.module_code,
              moduleCode: a.moduleCode,
              course: a.course,
              instructor_id: a.instructor_id,
              instructorId: a.instructorId
            });
          });
        }
      }, []);

      // Get module from URL parameter
      useEffect(() => {
        console.log('=== GETTING MODULE FROM URL ===');
        const urlParams = new URLSearchParams(window.location.search);
        const moduleCode = urlParams.get('module');
        console.log('URL module parameter:', moduleCode);
        
        if (moduleCode) {
          const module = modules.find(m => m.code === moduleCode);
          console.log('Found module in modules array:', module);
          
          if (module) {
            setCurrentModule(module);
            
            // Check if user has access to this module
            if (currentUser.role === 'Student') {
              // Student: Check if enrolled in any class of this module
              console.log('Student access check - module found');
            } else if (currentUser.role === 'Instructor') {
              // Instructor: Check if assigned to this module
              const instructorId = module.instructor_id || module.instructorId;
              console.log('Module instructor ID:', instructorId, 'Current user ID:', currentUser.id);
              if (instructorId !== currentUser.id) {
                alert('You are not assigned to this module');
                goBack();
              }
            } else if (currentUser.role === 'Exam Administrator') {
              // Exam Admin: Check if assigned to this module
              const examAdminId = module.exam_admin_id || module.examAdminId;
              if (examAdminId !== currentUser.id) {
                alert('You are not assigned to this module');
                goBack();
              }
            }
          } else {
            console.log('Module not found in modules array');
            alert('Module not found');
            goBack();
          }
        }
      }, [modules, currentUser, goBack]);

      // FIXED: Filter module-specific data with SIMPLE, WORKING filter
      const moduleAssessments = assessments.filter(a => {
        // Get module reference from ANY possible field
        const assessmentModuleRef = a.module_code || a.moduleCode || a.course;
        
        console.log('Filtering - Assessment:', a.id, a.title);
        console.log('  - Assessment module ref:', assessmentModuleRef);
        console.log('  - Current module code:', currentModule?.code);
        
        // Simple exact match
        const match = assessmentModuleRef === currentModule?.code;
        console.log('  - Match result:', match);
        
        return match;
      });

      console.log('=== FILTER RESULTS ===');
      console.log('Current module:', currentModule);
      console.log('Module assessments found:', moduleAssessments.length);
      console.log('Module assessments:', moduleAssessments);

      const moduleTeachingMaterials = teachingMaterials.filter(tm => 
        tm.moduleCode === currentModule?.code || tm.module_code === currentModule?.code
      );
      
      const moduleSubmissions = submissions.filter(s => 
        moduleAssessments.some(a => a.id === s.assessmentId)
      );
      
      const moduleQuestions = questions.filter(q => 
        moduleAssessments.some(a => a.id === q.assessmentId)
      );

      // Handle file upload
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          setSelectedFile(file);
        }
      };

      // Add teaching material (Instructor only)
      const addTeachingMaterial = async (e) => {
        e.preventDefault();
        
        if (!newMaterial.title || !newMaterial.description) {
          alert('Please fill in all required fields');
          return;
        }

        const material = {
          id: Date.now(),
          moduleCode: currentModule.code,
          title: newMaterial.title,
          description: newMaterial.description,
          type: newMaterial.file ? 'file' : 'text',
          fileName: newMaterial.file ? newMaterial.file.name : null,
          fileUrl: newMaterial.file ? URL.createObjectURL(newMaterial.file) : null,
          uploadedBy: currentUser.id,
          uploadedAt: new Date().toISOString(),
          views: 0
        };

        try {
          const createdMaterial = await SupabaseService.createTeachingMaterial(material);
          const updatedMaterials = [...teachingMaterials, createdMaterial];
          setTeachingMaterials(updatedMaterials);
          localStorage.setItem('teachingMaterials', JSON.stringify(updatedMaterials));
          alert('Teaching material added successfully');
          setNewMaterial({ title: '', description: '', file: null });
          setSelectedFile(null);
        } catch (error) {
          console.error('Error adding teaching material:', error);
          const updatedMaterials = [...teachingMaterials, material];
          setTeachingMaterials(updatedMaterials);
          localStorage.setItem('teachingMaterials', JSON.stringify(updatedMaterials));
          alert('Teaching material added (local)');
          setNewMaterial({ title: '', description: '', file: null });
          setSelectedFile(null);
        }
      };

      const addAssessment = async (e) => {
        e.preventDefault();
        
        if (!newAssessment.title || !newAssessment.dueDate) {
            alert('Please fill in all required fields');
            return;
        }

        console.log('Creating assessment for module:', currentModule.code);

        // Convert to snake_case for database
        const assessment = {
            module_code: currentModule.code,
            title: newAssessment.title,
            description: newAssessment.description,
            type: newAssessment.type,
            due_date: newAssessment.dueDate,
            max_marks: parseInt(newAssessment.maxMarks),
            criteria: newAssessment.criteria,
            instructor_id: currentUser.id,
            file_name: newAssessment.file ? newAssessment.file.name : null,
            file_path: newAssessment.file ? URL.createObjectURL(newAssessment.file) : null,
            status: 'draft',
            approved_by_exam_admin: false,
            created_at: new Date().toISOString()
        };

        try {
            const createdAssessment = await SupabaseService.createAssessment(assessment);
            
            // Convert back to camelCase for frontend
            const frontendAssessment = {
                ...createdAssessment,
                moduleCode: createdAssessment.module_code,
                dueDate: createdAssessment.due_date,
                maxMarks: createdAssessment.max_marks,
                instructorId: createdAssessment.instructor_id,
                fileName: createdAssessment.file_name,
                fileUrl: createdAssessment.file_path,
                createdAt: createdAssessment.created_at,
                approvedByExamAdmin: createdAssessment.approved_by_exam_admin
            };
            
            const updatedAssessments = [...assessments, frontendAssessment];
            setAssessments(updatedAssessments);
            localStorage.setItem('assessments', JSON.stringify(updatedAssessments));
            alert('Assessment created successfully');
            
            setNewAssessment({ 
                title: '', 
                description: '', 
                type: 'assignment', 
                dueDate: '', 
                maxMarks: 100,
                criteria: '',
                file: null 
            });
            setActiveTab('assessments');
        } catch (error) {
            console.error('Error creating assessment:', error);
            
            const fallbackAssessment = {
                id: Date.now(),
                moduleCode: currentModule.code,
                title: newAssessment.title,
                description: newAssessment.description,
                type: newAssessment.type,
                dueDate: newAssessment.dueDate,
                maxMarks: parseInt(newAssessment.maxMarks),
                criteria: newAssessment.criteria,
                instructorId: currentUser.id,
                fileName: newAssessment.file ? newAssessment.file.name : null,
                fileUrl: newAssessment.file ? URL.createObjectURL(newAssessment.file) : null,
                createdAt: new Date().toISOString(),
                status: 'draft',
                approvedByExamAdmin: false
            };
            
            const updatedAssessments = [...assessments, fallbackAssessment];
            setAssessments(updatedAssessments);
            localStorage.setItem('assessments', JSON.stringify(updatedAssessments));
            alert('Assessment created (local)');
            
            setNewAssessment({ 
                title: '', 
                description: '', 
                type: 'assignment', 
                dueDate: '', 
                maxMarks: 100,
                criteria: '',
                file: null 
            });
            setActiveTab('assessments');
        }
      };

      // Submit assessment (Student only)
      const submitAssessment = async (assessmentId) => {
        if (!selectedFile) {
          alert('Please select a file to submit');
          return;
        }

        const submission = {
          id: Date.now(),
          assessmentId,
          studentId: currentUser.id,
          fileName: selectedFile.name,
          fileUrl: URL.createObjectURL(selectedFile),
          submittedAt: new Date().toISOString(),
          status: 'submitted',
          grade: null,
          feedback: '',
          markedBy: null,
          markedAt: null,
          approvedByExamAdmin: false,
          releasedToStudent: false
        };

        try {
          const createdSubmission = await SupabaseService.createSubmission(submission);
          const updatedSubmissions = [...submissions, createdSubmission];
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Assessment submitted successfully');
          setSelectedFile(null);
        } catch (error) {
          console.error('Error submitting assessment:', error);
          const updatedSubmissions = [...submissions, submission];
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Assessment submitted (local)');
          setSelectedFile(null);
        }
      };

      // Grade submission (Instructor only)
      const gradeSubmission = async (submissionId, grade, feedback) => {
        try {
          const submission = submissions.find(s => s.id === submissionId);
          const updatedSubmission = {
            ...submission,
            grade: parseFloat(grade),
            feedback,
            markedBy: currentUser.id,
            markedAt: new Date().toISOString(),
            status: 'graded',
            approvedByExamAdmin: false
          };

          const supabaseUpdated = await SupabaseService.updateSubmission(submissionId, updatedSubmission);
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? supabaseUpdated : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Submission graded successfully');
        } catch (error) {
          console.error('Error grading submission:', error);
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? { 
              ...s, 
              grade: parseFloat(grade), 
              feedback,
              markedBy: currentUser.id,
              markedAt: new Date().toISOString(),
              status: 'graded',
              approvedByExamAdmin: false
            } : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Submission graded (local)');
        }
      };

      // Approve/reject grade (Exam Admin only)
      const handleGradeApproval = async (submissionId, approved) => {
        try {
          const submission = submissions.find(s => s.id === submissionId);
          const updatedSubmission = {
            ...submission,
            approvedByExamAdmin: approved,
            releasedToStudent: approved,
            status: approved ? 'released' : 'needs_revision'
          };

          const supabaseUpdated = await SupabaseService.updateSubmission(submissionId, updatedSubmission);
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? supabaseUpdated : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          
          setApprovalStatus(prev => ({
            ...prev,
            [submissionId]: approved ? 'approved' : 'rejected'
          }));
          
          alert(`Grade ${approved ? 'approved and released' : 'rejected'}`);
        } catch (error) {
          console.error('Error updating approval:', error);
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? { 
              ...s, 
              approvedByExamAdmin: approved,
              releasedToStudent: approved,
              status: approved ? 'released' : 'needs_revision'
            } : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          
          setApprovalStatus(prev => ({
            ...prev,
            [submissionId]: approved ? 'approved' : 'rejected'
          }));
          
          alert(`Grade ${approved ? 'approved (local)' : 'rejected (local)'}`);
        }
      };

      // Delete teaching material (Instructor only)
      const deleteTeachingMaterial = async (materialId) => {
        if (window.confirm('Are you sure you want to delete this teaching material?')) {
          try {
            await SupabaseService.deleteTeachingMaterial(materialId);
            const updatedMaterials = teachingMaterials.filter(tm => tm.id !== materialId);
            setTeachingMaterials(updatedMaterials);
            localStorage.setItem('teachingMaterials', JSON.stringify(updatedMaterials));
            alert('Teaching material deleted');
          } catch (error) {
            console.error('Error deleting material:', error);
            const updatedMaterials = teachingMaterials.filter(tm => tm.id !== materialId);
            setTeachingMaterials(updatedMaterials);
            localStorage.setItem('teachingMaterials', JSON.stringify(updatedMaterials));
            alert('Teaching material deleted (local)');
          }
        }
      };

      // Delete assessment (Instructor only)
      const deleteAssessment = async (assessmentId) => {
        if (window.confirm('Are you sure you want to delete this assessment? All submissions will also be deleted.')) {
          try {
            await SupabaseService.deleteAssessment(assessmentId);
            const updatedAssessments = assessments.filter(a => a.id !== assessmentId);
            setAssessments(updatedAssessments);
            localStorage.setItem('assessments', JSON.stringify(updatedAssessments));
            
            const updatedSubmissions = submissions.filter(s => s.assessmentId !== assessmentId);
            setSubmissions(updatedSubmissions);
            localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
            
            alert('Assessment and related submissions deleted');
          } catch (error) {
            console.error('Error deleting assessment:', error);
            const updatedAssessments = assessments.filter(a => a.id !== assessmentId);
            setAssessments(updatedAssessments);
            localStorage.setItem('assessments', JSON.stringify(updatedAssessments));
            
            const updatedSubmissions = submissions.filter(s => s.assessmentId !== assessmentId);
            setSubmissions(updatedSubmissions);
            localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
            
            alert('Assessment deleted (local)');
          }
        }
      };

      if (!currentModule) {
        return (
          <div className="loading-screen">
            <div className="loading-spinner"></div>
            <p>Loading module...</p>
          </div>
        );
      }

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
              <button onClick={goBack} className="btn-secondary" style={{ padding: '8px 16px' }}>
                <i className="fas fa-arrow-left"></i> Back
              </button>
              <div>
                <h1>{currentModule.name}</h1>
                <p style={{ margin: '5px 0 0 0', color: '#666', fontSize: '16px' }}>
                  Code: {currentModule.code} â€¢ {currentUser.role}
                </p>
              </div>
            </div>
            <div>
              <button onClick={goToProfile} className="btn-secondary">Profile</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>

          <main>
            {/* Module Overview */}
            <section className="welcome-banner">
              <h2 className="welcome-title">{currentModule.name}</h2>
              <p className="welcome-subtitle">{currentModule.description}</p>
              <div style={{ 
                display: 'flex', 
                gap: '20px', 
                marginTop: '20px',
                flexWrap: 'wrap' 
              }}>
                <div style={{ 
                  backgroundColor: 'rgba(255,255,255,0.2)', 
                  padding: '10px 20px', 
                  borderRadius: '8px' 
                }}>
                  <strong>Assessments:</strong> {moduleAssessments.length}
                </div>
                <div style={{ 
                  backgroundColor: 'rgba(255,255,255,0.2)', 
                  padding: '10px 20px', 
                  borderRadius: '8px' 
                }}>
                  <strong>Materials:</strong> {moduleTeachingMaterials.length}
                </div>
                <div style={{ 
                  backgroundColor: 'rgba(255,255,255,0.2)', 
                  padding: '10px 20px', 
                  borderRadius: '8px' 
                }}>
                  <strong>Your Submissions:</strong> {moduleSubmissions.filter(s => s.studentId === currentUser.id).length}
                </div>
              </div>
            </section>

            {/* Tab Navigation */}
            <div style={{ 
              display: 'flex', 
              borderBottom: '1px solid #ddd',
              marginBottom: '30px',
              overflowX: 'auto'
            }}>
              <button
                className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                onClick={() => setActiveTab('overview')}
              >
                <i className="fas fa-home"></i> Overview
              </button>
              <button
                className={`tab-btn ${activeTab === 'materials' ? 'active' : ''}`}
                onClick={() => setActiveTab('materials')}
              >
                <i className="fas fa-book"></i> Teaching Materials
              </button>
              <button
                className={`tab-btn ${activeTab === 'assessments' ? 'active' : ''}`}
                onClick={() => setActiveTab('assessments')}
              >
                <i className="fas fa-tasks"></i> Assessments
              </button>
              {(currentUser.role === 'Instructor' || currentUser.role === 'Exam Administrator') && (
                <button
                  className={`tab-btn ${activeTab === 'grading' ? 'active' : ''}`}
                  onClick={() => setActiveTab('grading')}
                >
                  <i className="fas fa-graduation-cap"></i> Grading
                </button>
              )}
              {currentUser.role === 'Student' && (
                <button
                  className={`tab-btn ${activeTab === 'my-work' ? 'active' : ''}`}
                  onClick={() => setActiveTab('my-work')}
                >
                  <i className="fas fa-user-check"></i> My Work
                </button>
              )}
            </div>

            {/* Tab Content */}
            <div className="tab-content">
              {/* Overview Tab */}
              {activeTab === 'overview' && (
                <section>
                  <h3>Module Overview</h3>
                  <div className="quick-actions">
                    <div className="item-card">
                      <h4><i className="fas fa-info-circle" style={{ color: '#667eea' }}></i> Module Information</h4>
                      <p><strong>Code:</strong> {currentModule.code}</p>
                      <p><strong>Name:</strong> {currentModule.name}</p>
                      <p><strong>Description:</strong> {currentModule.description}</p>
                    </div>
                    
                    <div className="item-card">
                      <h4><i className="fas fa-chart-line" style={{ color: '#2ecc71' }}></i> Quick Stats</h4>
                      <p><strong>Total Assessments:</strong> {moduleAssessments.length}</p>
                      <p><strong>Teaching Materials:</strong> {moduleTeachingMaterials.length}</p>
                      <p><strong>Pending Submissions:</strong> {moduleSubmissions.filter(s => s.status === 'submitted').length}</p>
                      <p><strong>Released Grades:</strong> {moduleSubmissions.filter(s => s.releasedToStudent).length}</p>
                    </div>

                    {(currentUser.role === 'Instructor' || currentUser.role === 'Exam Administrator') && (
                      <div className="item-card">
                        <h4><i className="fas fa-bell" style={{ color: '#e74c3c' }}></i> Action Required</h4>
                        {currentUser.role === 'Instructor' && (
                          <>
                            <p><strong>Submissions to grade:</strong> {moduleSubmissions.filter(s => s.status === 'submitted').length}</p>
                            <p><strong>Grades needing revision:</strong> {moduleSubmissions.filter(s => s.status === 'needs_revision').length}</p>
                          </>
                        )}
                        {currentUser.role === 'Exam Administrator' && (
                          <>
                            <p><strong>Grades to approve:</strong> {moduleSubmissions.filter(s => s.status === 'graded' && !s.approvedByExamAdmin).length}</p>
                            <p><strong>Approved grades:</strong> {moduleSubmissions.filter(s => s.approvedByExamAdmin).length}</p>
                          </>
                        )}
                      </div>
                    )}
                  </div>
                </section>
              )}

              {/* Teaching Materials Tab */}
              {activeTab === 'materials' && (
                <section>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3>Teaching Materials</h3>
                    {currentUser.role === 'Instructor' && (
                      <button 
                        className="btn-primary"
                        onClick={() => setActiveTab('add-material')}
                      >
                        <i className="fas fa-plus"></i> Add Material
                      </button>
                    )}
                  </div>
                  
                  {moduleTeachingMaterials.length === 0 ? (
                    <div className="empty-state">
                      <i className="fas fa-book-open" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                      <h4>No teaching materials yet</h4>
                      <p>Check back later or contact your instructor.</p>
                    </div>
                  ) : (
                    <div className="quick-actions">
                      {moduleTeachingMaterials.map(material => (
                        <div key={material.id} className="item-card">
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <div style={{ flex: 1 }}>
                              <h4>{material.title}</h4>
                              <p>{material.description}</p>
                              <p style={{ fontSize: '14px', color: '#666', marginTop: '10px' }}>
                                <i className="far fa-calendar"></i> Uploaded: {new Date(material.uploadedAt).toLocaleDateString()}
                              </p>
                            </div>
                            <div style={{ display: 'flex', gap: '10px' }}>
                              {material.fileUrl && (
                                <a href={material.fileUrl} download className="btn-secondary" style={{ padding: '8px 12px' }}>
                                  <i className="fas fa-download"></i>
                                </a>
                              )}
                              {currentUser.role === 'Instructor' && (
                                <button 
                                  onClick={() => deleteTeachingMaterial(material.id)}
                                  className="btn-danger"
                                  style={{ padding: '8px 12px' }}
                                >
                                  <i className="fas fa-trash"></i>
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </section>
              )}

              {/* Add Teaching Material Tab (Instructor only) */}
              {activeTab === 'add-material' && currentUser.role === 'Instructor' && (
                <section>
                  <h3>Add Teaching Material</h3>
                  <form onSubmit={addTeachingMaterial} className="form-container">
                    <input
                      type="text"
                      placeholder="Title *"
                      value={newMaterial.title}
                      onChange={e => setNewMaterial({ ...newMaterial, title: e.target.value })}
                      required
                    />
                    <textarea
                      placeholder="Description *"
                      value={newMaterial.description}
                      onChange={e => setNewMaterial({ ...newMaterial, description: e.target.value })}
                      rows="4"
                      required
                    />
                    <div>
                      <label style={{ display: 'block', marginBottom: '10px', fontWeight: '500' }}>
                        Upload File (Optional)
                      </label>
                      <input
                        type="file"
                        onChange={(e) => setNewMaterial({ ...newMaterial, file: e.target.files[0] })}
                        style={{ width: '100%', padding: '10px', border: '1px solid #ddd', borderRadius: '8px' }}
                      />
                    </div>
                    <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                      <button type="submit" className="btn-primary" style={{ flex: 1 }}>
                        <i className="fas fa-upload"></i> Upload Material
                      </button>
                      <button type="button" onClick={() => setActiveTab('materials')} className="btn-secondary" style={{ flex: 1 }}>
                        Cancel
                      </button>
                    </div>
                  </form>
                </section>
              )}

              {/* Assessments Tab */}
              {activeTab === 'assessments' && (
                <section>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3>Assessments</h3>
                    {currentUser.role === 'Instructor' && (
                      <button 
                        className="btn-primary"
                        onClick={() => setActiveTab('add-assessment')}
                      >
                        <i className="fas fa-plus"></i> Create Assessment
                      </button>
                    )}
                  </div>
                  
                  {moduleAssessments.length === 0 ? (
                    <div className="empty-state">
                      <i className="fas fa-tasks" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                      <h4>No assessments yet</h4>
                      <p>Check back later or contact your instructor.</p>
                    </div>
                  ) : (
                    <div className="quick-actions">
                      {moduleAssessments.map(assessment => {
                        const studentSubmission = moduleSubmissions.find(s => 
                          s.assessmentId === assessment.id && s.studentId === currentUser.id
                        );
                        
                        return (
                          <div key={assessment.id} className="item-card">
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                              <div style={{ flex: 1 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' }}>
                                  <h4 style={{ margin: 0 }}>{assessment.title}</h4>
                                  <span style={{
                                    padding: '4px 8px',
                                    backgroundColor: assessment.type === 'exam' ? '#e74c3c' : '#3498db',
                                    color: 'white',
                                    borderRadius: '4px',
                                    fontSize: '12px',
                                    fontWeight: '600'
                                  }}>
                                    {assessment.type.toUpperCase()}
                                  </span>
                                </div>
                                <p>{assessment.description}</p>
                                <div style={{ 
                                  display: 'flex', 
                                  gap: '20px', 
                                  marginTop: '15px',
                                  fontSize: '14px',
                                  color: '#666'
                                }}>
                                  <div>
                                    <i className="far fa-calendar"></i> Due: {new Date(assessment.dueDate || assessment.due_date).toLocaleDateString()}
                                  </div>
                                  <div>
                                    <i className="fas fa-star"></i> Max Marks: {assessment.maxMarks || assessment.max_marks}
                                  </div>
                                  {studentSubmission && (
                                    <div style={{
                                      color: studentSubmission.status === 'released' ? '#2ecc71' : 
                                             studentSubmission.status === 'graded' ? '#f39c12' : '#3498db'
                                    }}>
                                      <i className="fas fa-check-circle"></i> Status: {studentSubmission.status}
                                    </div>
                                  )}
                                </div>
                                
                                {/* Student Actions */}
                                {currentUser.role === 'Student' && (
                                  <div style={{ marginTop: '20px' }}>
                                    {!studentSubmission ? (
                                      <>
                                        <div style={{ marginBottom: '10px' }}>
                                          <input
                                            type="file"
                                            id={`file-${assessment.id}`}
                                            onChange={handleFileUpload}
                                            style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '4px' }}
                                          />
                                        </div>
                                        <button 
                                          onClick={() => submitAssessment(assessment.id)}
                                          className="btn-primary"
                                          style={{ width: '100%' }}
                                          disabled={!selectedFile}
                                        >
                                          Submit Assessment
                                        </button>
                                      </>
                                    ) : (
                                      <div style={{ 
                                        padding: '15px', 
                                        backgroundColor: '#f8f9fa',
                                        borderRadius: '8px',
                                        border: '1px solid #e9ecef'
                                      }}>
                                        <h5>Your Submission</h5>
                                        <p><strong>Submitted:</strong> {new Date(studentSubmission.submittedAt).toLocaleDateString()}</p>
                                        <p><strong>Status:</strong> {studentSubmission.status}</p>
                                        {studentSubmission.grade !== null && (
                                          <p><strong>Grade:</strong> {studentSubmission.grade}/{assessment.maxMarks || assessment.max_marks}</p>
                                        )}
                                        {studentSubmission.feedback && (
                                          <p><strong>Feedback:</strong> {studentSubmission.feedback}</p>
                                        )}
                                        <a 
                                          href={studentSubmission.fileUrl} 
                                          download 
                                          className="btn-secondary"
                                          style={{ marginTop: '10px' }}
                                        >
                                          <i className="fas fa-download"></i> Download Submission
                                        </a>
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                              
                              {/* Instructor Actions */}
                              {currentUser.role === 'Instructor' && (
                                <div style={{ display: 'flex', gap: '10px' }}>
                                  <button 
                                    onClick={() => {
                                      setActiveTab('grading');
                                    }}
                                    className="btn-secondary"
                                    style={{ padding: '8px 12px' }}
                                  >
                                    <i className="fas fa-graduation-cap"></i> Grade
                                  </button>
                                  <button 
                                    onClick={() => deleteAssessment(assessment.id)}
                                    className="btn-danger"
                                    style={{ padding: '8px 12px' }}
                                  >
                                    <i className="fas fa-trash"></i>
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </section>
              )}

              {/* Add Assessment Tab (Instructor only) */}
              {activeTab === 'add-assessment' && currentUser.role === 'Instructor' && (
                <section>
                  <h3>Create Assessment</h3>
                  <form onSubmit={addAssessment} className="form-container">
                    <input
                      type="text"
                      placeholder="Assessment Title *"
                      value={newAssessment.title}
                      onChange={e => setNewAssessment({ ...newAssessment, title: e.target.value })}
                      required
                    />
                    <textarea
                      placeholder="Description *"
                      value={newAssessment.description}
                      onChange={e => setNewAssessment({ ...newAssessment, description: e.target.value })}
                      rows="4"
                      required
                    />
                    <select
                      value={newAssessment.type}
                      onChange={e => setNewAssessment({ ...newAssessment, type: e.target.value })}
                      required
                    >
                      <option value="assignment">Assignment</option>
                      <option value="quiz">Quiz</option>
                      <option value="exam">Exam</option>
                      <option value="project">Project</option>
                    </select>
                    <input
                      type="datetime-local"
                      placeholder="Due Date *"
                      value={newAssessment.dueDate}
                      onChange={e => setNewAssessment({ ...newAssessment, dueDate: e.target.value })}
                      required
                    />
                    <input
                      type="number"
                      placeholder="Maximum Marks *"
                      value={newAssessment.maxMarks}
                      onChange={e => setNewAssessment({ ...newAssessment, maxMarks: e.target.value })}
                      min="0"
                      max="1000"
                      required
                    />
                    <textarea
                      placeholder="Grading Criteria"
                      value={newAssessment.criteria}
                      onChange={e => setNewAssessment({ ...newAssessment, criteria: e.target.value })}
                      rows="3"
                    />
                    <div>
                      <label style={{ display: 'block', marginBottom: '10px', fontWeight: '500' }}>
                        Assessment File (Optional)
                      </label>
                      <input
                        type="file"
                        onChange={(e) => setNewAssessment({ ...newAssessment, file: e.target.files[0] })}
                        style={{ width: '100%', padding: '10px', border: '1px solid #ddd', borderRadius: '8px' }}
                      />
                    </div>
                    <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                      <button type="submit" className="btn-primary" style={{ flex: 1 }}>
                        <i className="fas fa-plus-circle"></i> Create Assessment
                      </button>
                      <button type="button" onClick={() => setActiveTab('assessments')} className="btn-secondary" style={{ flex: 1 }}>
                        Cancel
                      </button>
                    </div>
                  </form>
                </section>
              )}

              {/* Grading Tab (Instructor & Exam Admin) */}
              {(activeTab === 'grading' && (currentUser.role === 'Instructor' || currentUser.role === 'Exam Administrator')) && (
                <section>
                  <h3>Grading & Approval</h3>
                  
                  {currentUser.role === 'Instructor' && (
                    <>
                      <div className="quick-actions">
                        {moduleSubmissions.filter(s => s.status === 'submitted' || s.status === 'needs_revision').map(submission => {
                          const assessment = moduleAssessments.find(a => a.id === submission.assessmentId);
                          const student = users.find(u => u.id === submission.studentId);
                          
                          return (
                            <div key={submission.id} className="item-card">
                              <h4>{assessment?.title || 'Unknown Assessment'}</h4>
                              <p><strong>Student:</strong> {student?.name || 'Unknown'}</p>
                              <p><strong>Submitted:</strong> {new Date(submission.submittedAt).toLocaleDateString()}</p>
                              <p><strong>Current Status:</strong> {submission.status}</p>
                              
                              <div style={{ marginTop: '15px' }}>
                                <div style={{ marginBottom: '10px' }}>
                                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Grade (/{assessment?.maxMarks || assessment?.max_marks || 100})</label>
                                  <input
                                    type="number"
                                    placeholder="Enter grade"
                                    min="0"
                                    max={assessment?.maxMarks || assessment?.max_marks || 100}
                                    value={gradingData[submission.id]?.grade || submission.grade || ''}
                                    onChange={e => setGradingData(prev => ({
                                      ...prev,
                                      [submission.id]: { ...prev[submission.id], grade: e.target.value }
                                    }))}
                                    style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '4px' }}
                                  />
                                </div>
                                
                                <div style={{ marginBottom: '10px' }}>
                                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500' }}>Feedback</label>
                                  <textarea
                                    placeholder="Provide feedback..."
                                    value={gradingData[submission.id]?.feedback || submission.feedback || ''}
                                    onChange={e => setGradingData(prev => ({
                                      ...prev,
                                      [submission.id]: { ...prev[submission.id], feedback: e.target.value }
                                    }))}
                                    rows="3"
                                    style={{ width: '100%', padding: '8px', border: '1px solid #ddd', borderRadius: '4px' }}
                                  />
                                </div>
                                
                                <div style={{ display: 'flex', gap: '10px' }}>
                                  <button
                                    onClick={() => gradeSubmission(
                                      submission.id,
                                      gradingData[submission.id]?.grade || submission.grade,
                                      gradingData[submission.id]?.feedback || submission.feedback
                                    )}
                                    className="btn-primary"
                                    style={{ flex: 1 }}
                                  >
                                    <i className="fas fa-check"></i> Submit Grade
                                  </button>
                                  <a href={submission.fileUrl} download className="btn-secondary" style={{ padding: '8px 16px' }}>
                                    <i className="fas fa-download"></i>
                                  </a>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                      
                      <div style={{ marginTop: '30px' }}>
                        <h4>Graded Submissions</h4>
                        <div className="quick-actions">
                          {moduleSubmissions.filter(s => s.status === 'graded').map(submission => {
                            const assessment = moduleAssessments.find(a => a.id === submission.assessmentId);
                            const student = users.find(u => u.id === submission.studentId);
                            
                            return (
                              <div key={submission.id} className="item-card">
                                <h4>{assessment?.title || 'Unknown Assessment'}</h4>
                                <p><strong>Student:</strong> {student?.name || 'Unknown'}</p>
                                <p><strong>Grade:</strong> {submission.grade}/{assessment?.maxMarks || assessment?.max_marks || 100}</p>
                                <p><strong>Status:</strong> 
                                  {submission.approvedByExamAdmin ? ' Approved by Exam Admin' : ' Pending Exam Admin Approval'}
                                </p>
                                <p><strong>Feedback:</strong> {submission.feedback || 'No feedback provided'}</p>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </>
                  )}

                  {currentUser.role === 'Exam Administrator' && (
                    <>
                      <div className="quick-actions">
                        {moduleSubmissions.filter(s => s.status === 'graded' && !s.approvedByExamAdmin).map(submission => {
                          const assessment = moduleAssessments.find(a => a.id === submission.assessmentId);
                          const student = users.find(u => u.id === submission.studentId);
                          const instructor = users.find(u => u.id === submission.markedBy);
                          
                          return (
                            <div key={submission.id} className="item-card">
                              <h4>{assessment?.title || 'Unknown Assessment'}</h4>
                              <div style={{ 
                                display: 'grid', 
                                gridTemplateColumns: '1fr 1fr', 
                                gap: '10px',
                                marginBottom: '15px'
                              }}>
                                <div>
                                  <p><strong>Student:</strong> {student?.name || 'Unknown'}</p>
                                  <p><strong>Instructor:</strong> {instructor?.name || 'Unknown'}</p>
                                </div>
                                <div>
                                  <p><strong>Grade:</strong> {submission.grade}/{assessment?.maxMarks || assessment?.max_marks || 100}</p>
                                  <p><strong>Marked:</strong> {new Date(submission.markedAt).toLocaleDateString()}</p>
                                </div>
                              </div>
                              
                              <div style={{ 
                                padding: '15px', 
                                backgroundColor: '#f8f9fa',
                                borderRadius: '8px',
                                marginBottom: '15px'
                              }}>
                                <h5 style={{ marginTop: '0' }}>Instructor Feedback</h5>
                                <p>{submission.feedback || 'No feedback provided'}</p>
                              </div>
                              
                              <div style={{ display: 'flex', gap: '10px' }}>
                                <button
                                  onClick={() => handleGradeApproval(submission.id, true)}
                                  className="btn-success"
                                  style={{ flex: 1 }}
                                >
                                  <i className="fas fa-check-circle"></i> Approve & Release
                                </button>
                                <button
                                  onClick={() => handleGradeApproval(submission.id, false)}
                                  className="btn-danger"
                                  style={{ flex: 1 }}
                                >
                                  <i className="fas fa-times-circle"></i> Reject & Return
                                </button>
                                <a href={submission.fileUrl} download className="btn-secondary" style={{ padding: '8px 16px' }}>
                                  <i className="fas fa-download"></i>
                                </a>
                              </div>
                              
                              {approvalStatus[submission.id] && (
                                <div style={{
                                  marginTop: '10px',
                                  padding: '10px',
                                  backgroundColor: approvalStatus[submission.id] === 'approved' ? '#d4edda' : '#f8d7da',
                                  color: approvalStatus[submission.id] === 'approved' ? '#155724' : '#721c24',
                                  borderRadius: '4px',
                                  textAlign: 'center'
                                }}>
                                  <i className={`fas fa-${approvalStatus[submission.id] === 'approved' ? 'check' : 'times'}`}></i>
                                  {' '}
                                  Grade {approvalStatus[submission.id]} successfully
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                      
                      <div style={{ marginTop: '30px' }}>
                        <h4>Approved Grades</h4>
                        <div className="quick-actions">
                          {moduleSubmissions.filter(s => s.approvedByExamAdmin).map(submission => {
                            const assessment = moduleAssessments.find(a => a.id === submission.assessmentId);
                            const student = users.find(u => u.id === submission.studentId);
                            
                            return (
                              <div key={submission.id} className="item-card">
                                <div style={{ 
                                  display: 'flex', 
                                  justifyContent: 'space-between', 
                                  alignItems: 'center' 
                                }}>
                                  <div>
                                    <h4 style={{ margin: '0 0 5px 0' }}>{assessment?.title || 'Unknown Assessment'}</h4>
                                    <p style={{ margin: '0', color: '#666' }}>{student?.name || 'Unknown'}</p>
                                  </div>
                                  <span style={{
                                    padding: '4px 8px',
                                    backgroundColor: '#2ecc71',
                                    color: 'white',
                                    borderRadius: '4px',
                                    fontSize: '12px',
                                    fontWeight: '600'
                                  }}>
                                    RELEASED
                                  </span>
                                </div>
                                <div style={{ 
                                  display: 'grid', 
                                  gridTemplateColumns: '1fr 1fr', 
                                  gap: '10px',
                                  marginTop: '10px'
                                }}>
                                  <div>
                                    <p><strong>Grade:</strong> {submission.grade}/{assessment?.maxMarks || assessment?.max_marks || 100}</p>
                                    <p><strong>Approved:</strong> {new Date(submission.markedAt).toLocaleDateString()}</p>
                                  </div>
                                  <div>
                                    <p><strong>Status:</strong> Released to Student</p>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </>
                  )}
                </section>
              )}

              {/* Student My Work Tab */}
              {activeTab === 'my-work' && currentUser.role === 'Student' && (
                <section>
                  <h3>My Work & Grades</h3>
                  
                  <div className="quick-actions">
                    {moduleSubmissions.filter(s => s.studentId === currentUser.id).map(submission => {
                      const assessment = moduleAssessments.find(a => a.id === submission.assessmentId);
                      
                      return (
                        <div key={submission.id} className="item-card">
                          <div style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'flex-start',
                            marginBottom: '15px'
                          }}>
                            <div>
                              <h4 style={{ margin: '0 0 5px 0' }}>{assessment?.title || 'Unknown Assessment'}</h4>
                              <p style={{ margin: '0', color: '#666' }}>
                                Submitted: {new Date(submission.submittedAt).toLocaleDateString()}
                              </p>
                            </div>
                            <span style={{
                              padding: '4px 8px',
                              backgroundColor: submission.status === 'released' ? '#2ecc71' : 
                                             submission.status === 'graded' ? '#f39c12' : 
                                             submission.status === 'submitted' ? '#3498db' : '#e74c3c',
                              color: 'white',
                              borderRadius: '4px',
                              fontSize: '12px',
                              fontWeight: '600'
                            }}>
                              {submission.status.toUpperCase()}
                            </span>
                          </div>
                          
                          <div style={{ 
                            padding: '15px', 
                            backgroundColor: '#f8f9fa',
                            borderRadius: '8px',
                            border: '1px solid #e9ecef'
                          }}>
                            {submission.releasedToStudent ? (
                              <>
                                <div style={{ 
                                  display: 'grid', 
                                  gridTemplateColumns: '1fr 1fr', 
                                  gap: '15px',
                                  marginBottom: '15px'
                                }}>
                                  <div>
                                    <p style={{ margin: '0 0 5px 0', color: '#666' }}>Your Grade</p>
                                    <h3 style={{ margin: '0', color: '#2ecc71' }}>
                                      {submission.grade}/{assessment?.maxMarks || assessment?.max_marks || 100}
                                    </h3>
                                  </div>
                                  <div>
                                    <p style={{ margin: '0 0 5px 0', color: '#666' }}>Percentage</p>
                                    <h3 style={{ margin: '0', color: '#3498db' }}>
                                      {((submission.grade / (assessment?.maxMarks || assessment?.max_marks || 100)) * 100).toFixed(1)}%
                                    </h3>
                                  </div>
                                </div>
                                
                                {submission.feedback && (
                                  <div>
                                    <h5 style={{ margin: '0 0 10px 0', color: '#333' }}>Instructor Feedback</h5>
                                    <p style={{ margin: '0', color: '#666' }}>{submission.feedback}</p>
                                  </div>
                                )}
                              </>
                            ) : submission.status === 'graded' ? (
                              <div style={{ textAlign: 'center', padding: '20px' }}>
                                <i className="fas fa-clock" style={{ fontSize: '48px', color: '#f39c12', marginBottom: '15px' }}></i>
                                <h4>Grade Pending Approval</h4>
                                <p>Your grade has been marked but is awaiting exam administrator approval.</p>
                              </div>
                            ) : (
                              <div style={{ textAlign: 'center', padding: '20px' }}>
                                <i className="fas fa-hourglass-half" style={{ fontSize: '48px', color: '#3498db', marginBottom: '15px' }}></i>
                                <h4>Submission Received</h4>
                                <p>Your submission has been received and is awaiting grading.</p>
                              </div>
                            )}
                          </div>
                          
                          <div style={{ marginTop: '15px', display: 'flex', gap: '10px' }}>
                            <a href={submission.fileUrl} download className="btn-secondary" style={{ flex: 1 }}>
                              <i className="fas fa-download"></i> Download Submission
                            </a>
                            {assessment?.fileUrl && (
                              <a href={assessment.fileUrl} download className="btn-primary" style={{ flex: 1 }}>
                                <i className="fas fa-file-download"></i> Download Assessment
                              </a>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {moduleSubmissions.filter(s => s.studentId === currentUser.id && s.releasedToStudent).length > 0 && (
                    <div style={{ marginTop: '30px' }}>
                      <h4>Overall Performance</h4>
                      <div className="item-card">
                        <div style={{ 
                          display: 'grid', 
                          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                          gap: '20px'
                        }}>
                          <div style={{ textAlign: 'center' }}>
                            <p style={{ margin: '0 0 5px 0', color: '#666' }}>Total Submissions</p>
                            <h3 style={{ margin: '0', color: '#3498db' }}>
                              {moduleSubmissions.filter(s => s.studentId === currentUser.id).length}
                            </h3>
                          </div>
                          <div style={{ textAlign: 'center' }}>
                            <p style={{ margin: '0 0 5px 0', color: '#666' }}>Released Grades</p>
                            <h3 style={{ margin: '0', color: '#2ecc71' }}>
                              {moduleSubmissions.filter(s => s.studentId === currentUser.id && s.releasedToStudent).length}
                            </h3>
                          </div>
                          <div style={{ textAlign: 'center' }}>
                            <p style={{ margin: '0 0 5px 0', color: '#666' }}>Average Grade</p>
                            <h3 style={{ margin: '0', color: '#9b59b6' }}>
                              {(() => {
                                const releasedGrades = moduleSubmissions.filter(s => 
                                  s.studentId === currentUser.id && s.releasedToStudent && s.grade !== null
                                );
                                if (releasedGrades.length === 0) return 'N/A';
                                const total = releasedGrades.reduce((sum, s) => sum + parseFloat(s.grade), 0);
                                return (total / releasedGrades.length).toFixed(1);
                              })()}
                            </h3>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </section>
              )}
            </div>
          </main>
        </div>
      );
    };

    // ==================== STUDENT DASHBOARD ====================
    const StudentDashboard = ({ 
      currentUser, 
      assessments, 
      submissions, 
      questions, 
      setSubmissions, 
      setQuestions, 
      handleLogout, 
      goToProfile,
      modules = [],
      classes = [],
      setClasses = () => {}
    }) => {
      const [questionData, setQuestionData] = useState({ assessmentId: '', text: '' });
      const [invitationCode, setInvitationCode] = useState('');
      const [userModules, setUserModules] = useState([]);
      const [selectedFile, setSelectedFile] = useState(null);

      useEffect(() => {
        loadUserModules();
      }, [classes, currentUser, modules]);

      const loadUserModules = () => {
        const enrolledModules = [];
        modules.forEach(module => {
          const moduleClasses = classes.filter(c => 
            c.module_code === module.code && 
            c.students && 
            c.students.includes(parseInt(currentUser.id))
          );
          if (moduleClasses.length > 0) {
            enrolledModules.push({
              ...module,
              classCount: moduleClasses.length
            });
          }
        });
        setUserModules(enrolledModules);
      };

      const submitAssessment = async (assessmentId) => {
        try {
          const submission = {
            id: Date.now(),
            assessmentId,
            studentId: currentUser.id,
            files: 'file.pdf',
            drafts: [{ version: 1, content: 'file.pdf', timestamp: new Date().toISOString() }],
            grade: null,
            feedback: '',
            status: 'submitted'
          };
          
          const createdSubmission = await SupabaseService.createSubmission(submission);
          const updatedSubmissions = [...submissions, createdSubmission];
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Submission successful');
        } catch (error) {
          const submission = {
            id: Date.now(),
            assessmentId,
            studentId: currentUser.id,
            files: 'file.pdf',
            drafts: [{ version: 1, content: 'file.pdf', timestamp: new Date().toISOString() }],
            grade: null,
            feedback: '',
            status: 'submitted'
          };
          const updatedSubmissions = [...submissions, submission];
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Submission successful');
        }
      };

      const handleQuestionSubmit = async (e) => {
        e.preventDefault();
        try {
          const question = {
            id: Date.now(),
            assessmentId: parseInt(questionData.assessmentId),
            studentId: currentUser.id,
            question: questionData.text,
            answers: []
          };
          
          const createdQuestion = await SupabaseService.createQuestion(question);
          const updatedQuestions = [...questions, createdQuestion];
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          setQuestionData({ assessmentId: '', text: '' });
          alert('Question submitted');
        } catch (error) {
          const question = {
            id: Date.now(),
            assessmentId: parseInt(questionData.assessmentId),
            studentId: currentUser.id,
            question: questionData.text,
            answers: []
          };
          const updatedQuestions = [...questions, question];
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          setQuestionData({ assessmentId: '', text: '' });
          alert('Question submitted');
        }
      };

      const handleJoinModule = async (e) => {
        e.preventDefault();
        const noClassElement = document.getElementById('no-class-found');
        noClassElement.style.display = 'none';
        
        if (!invitationCode || invitationCode.length < 6) {
          noClassElement.innerHTML = `
            <i class="fas fa-exclamation-circle"></i> 
            <strong> Invalid invitation code.</strong>
            <div style="font-size: 14px; margin-top: 5px;">
              Please enter a valid invitation code (8 characters).
            </div>
          `;
          noClassElement.style.display = 'block';
          return;
        }
        
        try {
          const module = await SupabaseService.findModuleByInvitationCode(invitationCode);
          
          if (!module) {
            noClassElement.innerHTML = `
              <i class="fas fa-exclamation-circle"></i> 
              <strong> No module found with invitation code: ${invitationCode}</strong>
              <div style="font-size: 14px; margin-top: 5px;">
                Please check the code and try again, or contact your instructor.
              </div>
            `;
            noClassElement.style.display = 'block';
            return;
          }
          
          const moduleClasses = await SupabaseService.getClassesForModule(module.code);
          
          if (moduleClasses.length === 0) {
            alert(`Module "${module.name}" has no classes set up yet. Please contact the instructor.`);
            return;
          }
          
          let enrolledCount = 0;
          let alreadyEnrolledCount = 0;
          
          for (const classItem of moduleClasses) {
            try {
              const result = await SupabaseService.addStudentToClass(classItem.id, currentUser.id);
              
              const students = result.students || [];
              if (students.includes(parseInt(currentUser.id))) {
                enrolledCount++;
              } else {
                alreadyEnrolledCount++;
              }
            } catch (error) {
              console.error(`Error adding to class ${classItem.id}:`, error);
            }
          }
          
          const updatedClasses = [...classes];
          moduleClasses.forEach(classItem => {
            const index = updatedClasses.findIndex(c => c.id === classItem.id);
            if (index !== -1) {
              const students = updatedClasses[index].students || [];
              if (!students.includes(parseInt(currentUser.id))) {
                students.push(parseInt(currentUser.id));
                updatedClasses[index] = { ...updatedClasses[index], students };
              }
            }
          });
          
          setClasses(updatedClasses);
          localStorage.setItem('classes', JSON.stringify(updatedClasses));
          
          loadUserModules();
          
          setInvitationCode('');
          
          let message = `Successfully joined module: ${module.name}\n`;
          message += `Module Code: ${module.code}\n`;
          message += `Invitation Code: ${module.invitation_code}\n\n`;
          
          if (enrolledCount > 0) {
            message += `You've been added to ${enrolledCount} new class(es).\n`;
          }
          if (alreadyEnrolledCount > 0) {
            message += `You were already enrolled in ${alreadyEnrolledCount} class(es).\n`;
          }
          
          alert(message);
          
        } catch (error) {
          console.error('Error joining module:', error);
          alert('Failed to join module. Please try again or contact support.');
        }
      };

      const openModule = (moduleCode) => {
        window.location.href = `?page=module&module=${moduleCode}`;
      };

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Welcome, {currentUser.name} (Student)</h1>
            </div>
            <div>
              <button onClick={goToProfile} className="btn-secondary">Profile</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>
          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">Student Dashboard</h2>
              <p className="welcome-subtitle">
                View assessments, submit work, and ask questions
              </p>
            </section>
            
            <section>
              <h3>My Assessments ({assessments.length})</h3>
              {assessments.length === 0 ? (
                <div className="empty-state">
                  <i className="fas fa-tasks" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                  <h4>No assessments yet</h4>
                  <p>Your instructors haven't created any assessments yet.</p>
                </div>
              ) : (
                <div className="quick-actions">
                  {assessments.map(a => {
                    const submission = submissions.find(s => s.assessmentId === a.id && s.studentId === currentUser.id);
                    return (
                      <div key={a.id} className="item-card">
                        <h4>{a.title}</h4>
                        <p>{a.description}</p>
                        <p><strong>Deadline:</strong> {new Date(a.deadline).toLocaleDateString()}</p>
                        {submission ? (
                          <div style={{ marginTop: '10px' }}>
                            <p><strong>Status:</strong> 
                              <span className={`status-badge status-${submission.status}`} style={{ marginLeft: '10px' }}>
                                {submission.status}
                              </span>
                            </p>
                            {submission.grade && (
                              <p><strong>Grade:</strong> {submission.grade}/100</p>
                            )}
                          </div>
                        ) : (
                          <>
                            <input
                              type="file"
                              onChange={(e) => setSelectedFile(e.target.files[0])}
                              style={{ width: '100%', padding: '8px', marginTop: '10px', border: '1px solid #ddd', borderRadius: '4px' }}
                            />
                            <button 
                              onClick={() => submitAssessment(a.id)}
                              className="btn-primary"
                              style={{ marginTop: '10px', width: '100%' }}
                              disabled={!selectedFile}
                            >
                              Submit Assessment
                            </button>
                          </>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </section>
            
            <section>
              <h3>Ask a Question</h3>
              <form onSubmit={handleQuestionSubmit} className="form-container" style={{ maxWidth: '600px' }}>
                <select 
                  value={questionData.assessmentId} 
                  onChange={e => setQuestionData({ ...questionData, assessmentId: e.target.value })} 
                  required
                >
                  <option value="">Select Assessment</option>
                  {assessments.map(a => (
                    <option key={a.id} value={a.id}>{a.title}</option>
                  ))}
                </select>
                <textarea 
                  placeholder="Enter your question here..." 
                  value={questionData.text} 
                  onChange={e => setQuestionData({ ...questionData, text: e.target.value })} 
                  required
                  rows="4"
                />
                <button type="submit" className="btn-primary">Submit Question</button>
              </form>
            </section>

            <section>
              <h3>Join a Module</h3>
              <div className="join-module-form">
                <form onSubmit={handleJoinModule} style={{ marginBottom: '15px' }}>
                  <input 
                    type="text" 
                    placeholder="Enter invitation code (e.g., ABC123XY)" 
                    value={invitationCode}
                    onChange={(e) => {
                      const value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                      setInvitationCode(value.slice(0, 8));
                    }}
                    required
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px',
                      marginBottom: '10px',
                      fontSize: '16px',
                      letterSpacing: '2px',
                      textAlign: 'center',
                      fontFamily: 'monospace',
                      fontWeight: 'bold'
                    }}
                    maxLength="8"
                  />
                  <button type="submit" className="btn-primary" style={{ width: '100%' }}>
                    <i className="fas fa-sign-in-alt"></i> Join Module
                  </button>
                </form>
                
                <div id="no-class-found" className="no-class-found">
                  <i className="fas fa-exclamation-circle"></i> No module found with this invitation code.
                </div>
              </div>
              
              <div style={{ marginTop: '20px' }}>
                <h4>My Enrolled Modules ({userModules.length})</h4>
                {userModules.length > 0 ? (
                  <div className="quick-actions">
                    {userModules.map(module => (
                      <ModuleCard
                        key={module.code}
                        module={module}
                        userRole={currentUser.role}
                        currentUser={currentUser}
                        classes={classes}
                        assessments={assessments}
                        submissions={submissions}
                        onClick={() => openModule(module.code)}
                      />
                    ))}
                  </div>
                ) : (
                  <div className="empty-state">
                    <i className="fas fa-book" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                    <h4>No modules enrolled</h4>
                    <p>Join a module using an invitation code above.</p>
                  </div>
                )}
              </div>
            </section>
          </main>
        </div>
      );
    };

    // ==================== INSTRUCTOR DASHBOARD ====================
    const InstructorDashboard = ({ 
      currentUser, 
      assessments, 
      submissions, 
      questions, 
      setAssessments, 
      setSubmissions, 
      setQuestions, 
      handleLogout, 
      goToProfile,
      modules = [],
      setModules = () => {},
      teachingMaterials = [],
      setTeachingMaterials = () => {}
    }) => {
      const [userModules, setUserModules] = useState([]);
      const [assessmentData, setAssessmentData] = useState({ 
        title: '', 
        description: '', 
        moduleCode: '', 
        deadline: '', 
        criteria: '',
        type: 'assignment',
        maxMarks: 100
      });

      useEffect(() => {
        console.log('=== INSTRUCTOR DASHBOARD DEBUG ===');
        console.log('Current user:', currentUser);
        console.log('All modules:', modules);
        console.log('All assessments:', assessments);
        
        loadUserModules();
      }, [modules, currentUser]);

      const loadUserModules = () => {
        const instructorModules = modules.filter(m => 
          m.instructor_id === currentUser.id || m.instructorId === currentUser.id
        );
        console.log('Instructor modules:', instructorModules);
        setUserModules(instructorModules);
      };

      const handleAssessmentSubmit = async (e) => {
        e.preventDefault();
        
        if (!assessmentData.moduleCode) {
          alert('Please select a module');
          return;
        }
        
        console.log('Creating assessment for module:', assessmentData.moduleCode);
        
        try {
          // Use snake_case for database
          const assessment = {
            module_code: assessmentData.moduleCode,
            title: assessmentData.title,
            description: assessmentData.description,
            due_date: assessmentData.deadline,
            criteria: assessmentData.criteria,
            instructor_id: currentUser.id,
            status: 'draft',
            approved_by_exam_admin: false,
            created_at: new Date().toISOString(),
            type: assessmentData.type || 'assignment',
            max_marks: assessmentData.maxMarks || 100
          };
          
          console.log('Sending to Supabase:', assessment);
          
          const createdAssessment = await SupabaseService.createAssessment(assessment);
          
          console.log('Created assessment response:', createdAssessment);
          
          // Convert back to camelCase for frontend
          const frontendAssessment = {
            ...createdAssessment,
            moduleCode: createdAssessment.module_code,
            dueDate: createdAssessment.due_date,
            instructorId: createdAssessment.instructor_id,
            createdAt: createdAssessment.created_at,
            approvedByExamAdmin: createdAssessment.approved_by_exam_admin,
            maxMarks: createdAssessment.max_marks
          };
          
          const updatedAssessments = [...assessments, frontendAssessment];
          setAssessments(updatedAssessments);
          localStorage.setItem('assessments', JSON.stringify(updatedAssessments));
          
          setAssessmentData({ 
            title: '', 
            description: '', 
            moduleCode: '', 
            deadline: '', 
            criteria: '',
            type: 'assignment',
            maxMarks: 100
          });
          
          alert('Assessment created successfully');
        } catch (error) {
          console.error('Error creating assessment:', error);
          
          // Fallback to localStorage
          const assessment = {
            id: Date.now(),
            moduleCode: assessmentData.moduleCode,
            title: assessmentData.title,
            description: assessmentData.description,
            dueDate: assessmentData.deadline,
            criteria: assessmentData.criteria,
            instructorId: currentUser.id,
            files: [],
            status: 'draft',
            approvedByExamAdmin: false,
            type: assessmentData.type || 'assignment',
            maxMarks: assessmentData.maxMarks || 100
          };
          
          const updatedAssessments = [...assessments, assessment];
          setAssessments(updatedAssessments);
          localStorage.setItem('assessments', JSON.stringify(updatedAssessments));
          
          setAssessmentData({ 
            title: '', 
            description: '', 
            moduleCode: '', 
            deadline: '', 
            criteria: '',
            type: 'assignment',
            maxMarks: 100
          });
          
          alert('Assessment created (local storage)');
        }
      };

      const gradeSubmission = async (submissionId, grade) => {
        try {
          const updatedSubmission = await SupabaseService.updateSubmission(submissionId, { 
            grade, 
            status: 'graded' 
          });
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? updatedSubmission : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Submission graded successfully');
        } catch (error) {
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? { ...s, grade, status: 'graded' } : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Submission graded');
        }
      };

      const updateFeedback = async (submissionId, feedback) => {
        try {
          const updatedSubmission = await SupabaseService.updateSubmission(submissionId, { feedback });
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? updatedSubmission : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
        } catch (error) {
          const updatedSubmissions = submissions.map(s => 
            s.id === submissionId ? { ...s, feedback } : s
          );
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
        }
      };

      const answerQuestion = async (questionId, answer) => {
        try {
          const question = questions.find(q => q.id === questionId);
          const updatedAnswers = [...(question.answers || []), { 
            instructorId: currentUser.id, 
            answer, 
            official: true, 
            resolved: false 
          }];
          
          const updatedQuestion = await SupabaseService.updateQuestion(questionId, { 
            answers: updatedAnswers 
          });
          
          const updatedQuestions = questions.map(q => 
            q.id === questionId ? updatedQuestion : q
          );
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          alert('Answer submitted successfully');
        } catch (error) {
          const updatedQuestions = questions.map(q => 
            q.id === questionId ? { 
              ...q, 
              answers: [...(q.answers || []), { 
                instructorId: currentUser.id, 
                answer, 
                official: true, 
                resolved: false 
              }] 
            } : q
          );
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          alert('Answer submitted');
        }
      };

      const generateInvitationCode = async (moduleCode) => {
        try {
          const newCode = await SupabaseService.generateUniqueInvitationCode();
          const updatedModule = await SupabaseService.updateModuleInvitationCode(moduleCode, newCode);
          
          const updatedModules = modules.map(m => 
            m.code === moduleCode ? { ...m, invitation_code: newCode } : m
          );
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          
          alert(`Invitation code generated: ${newCode}`);
        } catch (error) {
          alert('Failed to generate invitation code');
        }
      };

      const regenerateInvitationCode = async (moduleCode) => {
        if (!confirm('Are you sure you want to regenerate the invitation code? The old code will no longer work.')) {
          return;
        }
        
        try {
          const newCode = await SupabaseService.generateUniqueInvitationCode();
          const updatedModule = await SupabaseService.updateModuleInvitationCode(moduleCode, newCode);
          
          const updatedModules = modules.map(m => 
            m.code === moduleCode ? { ...m, invitation_code: newCode } : m
          );
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          
          alert(`New invitation code generated: ${newCode}\n\nShare this new code with students.`);
        } catch (error) {
          alert('Failed to regenerate invitation code');
        }
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text)
          .then(() => {
            alert('Invitation code copied to clipboard!');
          })
          .catch(err => {
            console.error('Failed to copy: ', err);
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Invitation code copied!');
          });
      };

      const openModule = (moduleCode) => {
        console.log('Opening module:', moduleCode);
        window.location.href = `?page=module&module=${moduleCode}`;
      };

      // Get instructor's assessments
      const instructorAssessments = assessments.filter(a => 
        a.instructorId === currentUser.id || a.instructor_id === currentUser.id
      );

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Welcome, {currentUser.name} (Instructor)</h1>
            </div>
            <div>
              <button onClick={goToProfile} className="btn-secondary">Profile</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>
          
          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">Instructor Dashboard</h2>
              <p className="welcome-subtitle">
                Create assessments, grade submissions, manage modules, and answer student questions
              </p>
            </section>
            
            <section>
              <h3>My Assessments ({instructorAssessments.length})</h3>
              {instructorAssessments.length === 0 ? (
                <div className="empty-state">
                  <i className="fas fa-tasks" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                  <h4>No assessments created yet</h4>
                  <p>Create your first assessment using the form above.</p>
                </div>
              ) : (
                <div className="quick-actions">
                  {instructorAssessments.map(assessment => {
                    const module = modules.find(m => m.code === assessment.moduleCode || m.code === assessment.module_code);
                    const assessmentSubmissions = submissions.filter(s => s.assessmentId === assessment.id);
                    
                    return (
                      <div key={assessment.id} className="item-card">
                        <h4>{assessment.title}</h4>
                        <p>{assessment.description}</p>
                        <p><strong>Module:</strong> {module ? `${module.name} (${module.code})` : 'Unknown module'}</p>
                        <p><strong>Deadline:</strong> {new Date(assessment.dueDate || assessment.due_date).toLocaleDateString()}</p>
                        <p><strong>Submissions:</strong> {assessmentSubmissions.length}</p>
                        <p><strong>Status:</strong> 
                          <span className={`status-badge status-${assessment.status || 'draft'}`} style={{ marginLeft: '10px' }}>
                            {assessment.status || 'draft'}
                          </span>
                        </p>
                        
                        {module && (
                          <button 
                            onClick={() => openModule(module.code)}
                            className="btn-secondary"
                            style={{ marginTop: '10px', width: '100%' }}
                          >
                            <i className="fas fa-external-link-alt"></i> Open Module to View
                          </button>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </section>
            
            <section>
              <h3>Student Submissions ({submissions.filter(s => 
                assessments.find(a => a.id === s.assessmentId && (a.instructorId === currentUser.id || a.instructor_id === currentUser.id))
              ).length})</h3>
              {submissions.filter(s => 
                assessments.find(a => a.id === s.assessmentId && (a.instructorId === currentUser.id || a.instructor_id === currentUser.id))
              ).length === 0 ? (
                <div className="empty-state">
                  <i className="fas fa-inbox" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                  <h4>No submissions yet</h4>
                  <p>Student submissions will appear here once they submit their work.</p>
                </div>
              ) : (
                <div className="quick-actions">
                  {submissions.filter(s => 
                    assessments.find(a => a.id === s.assessmentId && (a.instructorId === currentUser.id || a.instructor_id === currentUser.id))
                  ).map(s => {
                    const assessment = assessments.find(a => a.id === s.assessmentId);
                    const module = modules.find(m => 
                      m.code === assessment?.moduleCode || 
                      m.code === assessment?.module_code ||
                      (assessment?.course && m.name.includes(assessment.course))
                    );
                    
                    return (
                      <div key={s.id} className="item-card">
                        <h4>Submission #{s.id}</h4>
                        <p><strong>Assessment:</strong> {assessment?.title || 'Unknown'}</p>
                        <p><strong>Module:</strong> {module ? module.name : 'Unknown'}</p>
                        <p><strong>Student ID:</strong> {s.studentId}</p>
                        <p><strong>Status:</strong> 
                          <span className={`status-badge status-${s.status}`} style={{ marginLeft: '10px' }}>
                            {s.status}
                          </span>
                        </p>
                        <p><strong>Current Grade:</strong> {s.grade || 'Not graded'}</p>
                        <div style={{ marginTop: '15px' }}>
                          <input 
                            type="number" 
                            placeholder="Enter grade" 
                            onChange={e => gradeSubmission(s.id, e.target.value)}
                            style={{ marginBottom: '10px', width: '100%', padding: '8px' }}
                          />
                          <textarea 
                            placeholder="Provide feedback..." 
                            value={s.feedback || ''}
                            onChange={e => updateFeedback(s.id, e.target.value)}
                            style={{ width: '100%', padding: '8px', marginBottom: '10px' }}
                            rows="3"
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </section>
            
            <section>
              <h3>My Modules ({userModules.length})</h3>
              {userModules.length === 0 ? (
                <div className="empty-state">
                  <i className="fas fa-book" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                  <h4>No modules assigned</h4>
                  <p>Contact the system administrator to get assigned to modules.</p>
                </div>
              ) : (
                <div className="quick-actions">
                  {userModules.map(module => {
                    const moduleAssessments = assessments.filter(a => 
                      a.moduleCode === module.code || a.module_code === module.code
                    );
                    const moduleSubmissions = submissions.filter(s => 
                      moduleAssessments.some(a => a.id === s.assessmentId)
                    );
                    
                    return (
                      <div key={module.code} className="item-card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                          <div style={{ flex: 1 }}>
                            <h4>{module.name}</h4>
                            <p><strong>Code:</strong> {module.code}</p>
                            <p><strong>Description:</strong> {module.description}</p>
                            <p><strong>Assessments:</strong> {moduleAssessments.length}</p>
                            <p><strong>Submissions:</strong> {moduleSubmissions.length}</p>
                          </div>
                          <button 
                            onClick={() => openModule(module.code)}
                            className="btn-primary"
                            style={{ padding: '8px 16px' }}
                          >
                            <i className="fas fa-external-link-alt"></i> Open Module
                          </button>
                        </div>
                        
                        {module.invitation_code ? (
                          <>
                            <div className="invitation-code-display">
                              {module.invitation_code}
                            </div>
                            <div className="invite-actions">
                              <button 
                                onClick={() => regenerateInvitationCode(module.code)}
                                className="refresh-btn"
                              >
                                <i className="fas fa-sync-alt"></i> Regenerate Code
                              </button>
                              <button 
                                onClick={() => copyToClipboard(module.invitation_code)}
                                className="copy-btn"
                              >
                                <i className="fas fa-copy"></i> Copy
                              </button>
                            </div>
                          </>
                        ) : (
                          <div>
                            <p style={{ color: '#666', marginBottom: '10px' }}>
                              No invitation code generated yet.
                            </p>
                            <button 
                              onClick={() => generateInvitationCode(module.code)}
                              className="btn-primary"
                              style={{ width: '100%' }}
                            >
                              <i className="fas fa-key"></i> Generate Invitation Code
                            </button>
                          </div>
                        )}
                        
                        <div style={{ marginTop: '15px', fontSize: '14px', color: '#666' }}>
                          <p><strong>How to invite students:</strong></p>
                          <ol style={{ margin: '10px 0', paddingLeft: '20px' }}>
                            <li>Generate an invitation code</li>
                            <li>Share the code with students</li>
                            <li>Students enter the code in their dashboard</li>
                            <li>Students are automatically added to all classes in this module</li>
                          </ol>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </section>
            
            <section>
              <h3>Student Questions ({questions.filter(q => 
                assessments.find(a => a.id === q.assessmentId && (a.instructorId === currentUser.id || a.instructor_id === currentUser.id))
              ).length})</h3>
              {questions.filter(q => 
                assessments.find(a => a.id === q.assessmentId && (a.instructorId === currentUser.id || a.instructor_id === currentUser.id))
              ).length === 0 ? (
                <div className="empty-state">
                  <i className="fas fa-question-circle" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                  <h4>No questions yet</h4>
                  <p>Student questions will appear here once they ask them.</p>
                </div>
              ) : (
                <div className="quick-actions">
                  {questions.filter(q => 
                    assessments.find(a => a.id === q.assessmentId && (a.instructorId === currentUser.id || a.instructor_id === currentUser.id))
                  ).map(q => {
                    const assessment = assessments.find(a => a.id === q.assessmentId);
                    
                    return (
                      <div key={q.id} className="item-card">
                        <h4>Question #{q.id}</h4>
                        <p><strong>Assessment:</strong> {assessment?.title || 'Unknown'}</p>
                        <p><strong>Question:</strong> {q.question}</p>
                        {q.answers && q.answers.length > 0 && (
                          <div style={{ marginTop: '10px' }}>
                            <p><strong>Previous Answers:</strong></p>
                            {q.answers.map((answer, idx) => (
                              <div key={idx} style={{ 
                                padding: '8px', 
                                margin: '5px 0', 
                                backgroundColor: '#f8f9fa',
                                borderRadius: '4px',
                                fontSize: '14px'
                              }}>
                                <p><strong>Answer {idx + 1}:</strong> {answer.answer}</p>
                                <p><em>{answer.official ? '(Official Answer)' : '(Peer Answer)'}</em></p>
                              </div>
                            ))}
                          </div>
                        )}
                        <textarea 
                          placeholder="Type your answer here..." 
                          onChange={(e) => {
                            const textarea = e.target;
                            textarea.dataset.answer = e.target.value;
                          }}
                          style={{ width: '100%', padding: '8px', marginTop: '10px' }}
                          rows="3"
                        />
                        <button 
                          onClick={(e) => {
                            const textarea = e.target.previousElementSibling;
                            if (textarea && textarea.dataset.answer) {
                              answerQuestion(q.id, textarea.dataset.answer);
                              alert('Answer submitted!');
                              textarea.value = '';
                              textarea.dataset.answer = '';
                            }
                          }}
                          className="btn-primary"
                          style={{ marginTop: '10px', width: '100%' }}
                        >
                          Submit Answer
                        </button>
                      </div>
                    );
                  })}
                </div>
              )}
            </section>
          </main>
        </div>
      );
    };

    // ==================== ASSESSMENT VIEW PAGE ====================
    const AssessmentViewPage = ({
      currentUser,
      assessments = [],
      submissions = [],
      questions = [],
      modules = [],
      users = [],
      setSubmissions = () => {},
      setQuestions = () => {},
      handleLogout = () => {},
      goToProfile = () => {},
      goBack = () => {}
    }) => {
      const [currentAssessment, setCurrentAssessment] = useState(null);
      const [selectedFile, setSelectedFile] = useState(null);
      const [newQuestion, setNewQuestion] = useState('');
      const [answers, setAnswers] = useState({});

      // Get assessment ID from URL
      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const assessmentId = urlParams.get('assessment');
        
        if (assessmentId) {
          const assessment = assessments.find(a => a.id === parseInt(assessmentId) || a.id === assessmentId);
          if (assessment) {
            setCurrentAssessment(assessment);
            
            // Check if user has access to this assessment
            const module = modules.find(m => 
              m.code === assessment.module_code || 
              m.code === assessment.moduleCode ||
              (assessment.course && m.name.includes(assessment.course))
            );
            
            if (currentUser.role === 'Student') {
              // Student: Check if enrolled in the module
              if (!module) {
                alert('You do not have access to this assessment');
                goBack();
                return;
              }
              
              // Check if student is enrolled in any class of this module
              const hasAccess = true; // You should implement proper access check
              if (!hasAccess) {
                alert('You are not enrolled in this module');
                goBack();
              }
            }
          } else {
            alert('Assessment not found');
            goBack();
          }
        }
      }, [assessments, currentUser, modules, goBack]);

      // Get assessment submissions
      const assessmentSubmissions = submissions.filter(s => 
        s.assessmentId === currentAssessment?.id
      );

      // Get student's submission
      const studentSubmission = assessmentSubmissions.find(s => 
        s.studentId === currentUser.id
      );

      // Get assessment questions
      const assessmentQuestions = questions.filter(q => 
        q.assessmentId === currentAssessment?.id
      );

      // Get module
      const module = modules.find(m => 
        m.code === currentAssessment?.module_code || 
        m.code === currentAssessment?.moduleCode ||
        (currentAssessment?.course && m.name.includes(currentAssessment.course))
      );

      // Handle file selection
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          setSelectedFile(file);
        }
      };

      // Submit assessment (Student only)
      const submitAssessment = async () => {
        if (!selectedFile) {
          alert('Please select a file to submit');
          return;
        }

        const submission = {
          id: Date.now(),
          assessmentId: currentAssessment.id,
          studentId: currentUser.id,
          fileName: selectedFile.name,
          fileUrl: URL.createObjectURL(selectedFile),
          submittedAt: new Date().toISOString(),
          status: 'submitted',
          grade: null,
          feedback: '',
          markedBy: null,
          markedAt: null,
          approvedByExamAdmin: false,
          releasedToStudent: false
        };

        try {
          const createdSubmission = await SupabaseService.createSubmission(submission);
          const updatedSubmissions = [...submissions, createdSubmission];
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Assessment submitted successfully');
          setSelectedFile(null);
        } catch (error) {
          console.error('Error submitting assessment:', error);
          const updatedSubmissions = [...submissions, submission];
          setSubmissions(updatedSubmissions);
          localStorage.setItem('submissions', JSON.stringify(updatedSubmissions));
          alert('Assessment submitted (local)');
          setSelectedFile(null);
        }
      };

      // Ask a question (Student only)
      const askQuestion = async () => {
        if (!newQuestion.trim()) {
          alert('Please enter a question');
          return;
        }

        const question = {
          id: Date.now(),
          assessmentId: currentAssessment.id,
          studentId: currentUser.id,
          question: newQuestion,
          answers: []
        };

        try {
          const createdQuestion = await SupabaseService.createQuestion(question);
          const updatedQuestions = [...questions, createdQuestion];
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          alert('Question submitted successfully');
          setNewQuestion('');
        } catch (error) {
          console.error('Error asking question:', error);
          const updatedQuestions = [...questions, question];
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          alert('Question submitted (local)');
          setNewQuestion('');
        }
      };

      // Answer a question (Instructor only)
      const answerQuestion = async (questionId) => {
        const answer = answers[questionId];
        if (!answer || !answer.trim()) {
          alert('Please enter an answer');
          return;
        }

        try {
          const question = questions.find(q => q.id === questionId);
          const updatedAnswers = [...(question.answers || []), {
            instructorId: currentUser.id,
            answer,
            official: true,
            resolved: false,
            answeredAt: new Date().toISOString()
          }];

          const updatedQuestion = await SupabaseService.updateQuestion(questionId, {
            answers: updatedAnswers
          });

          const updatedQuestions = questions.map(q =>
            q.id === questionId ? updatedQuestion : q
          );
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          
          setAnswers(prev => ({ ...prev, [questionId]: '' }));
          alert('Answer submitted successfully');
        } catch (error) {
          console.error('Error answering question:', error);
          const updatedQuestions = questions.map(q =>
            q.id === questionId ? {
              ...q,
              answers: [...(q.answers || []), {
                instructorId: currentUser.id,
                answer,
                official: true,
                resolved: false,
                answeredAt: new Date().toISOString()
              }]
            } : q
          );
          setQuestions(updatedQuestions);
          localStorage.setItem('questions', JSON.stringify(updatedQuestions));
          
          setAnswers(prev => ({ ...prev, [questionId]: '' }));
          alert('Answer submitted (local)');
        }
      };

      // Download assessment file
      const downloadAssessmentFile = () => {
        if (currentAssessment?.fileUrl) {
          const link = document.createElement('a');
          link.href = currentAssessment.fileUrl;
          link.download = currentAssessment.fileName || 'assessment_file';
          link.click();
        } else {
          alert('No file available for download');
        }
      };

      if (!currentAssessment) {
        return (
          <div className="loading-screen">
            <div className="loading-spinner"></div>
            <p>Loading assessment...</p>
          </div>
        );
      }

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
              <button onClick={goBack} className="btn-secondary" style={{ padding: '8px 16px' }}>
                <i className="fas fa-arrow-left"></i> Back
              </button>
              <div>
                <h1>{currentAssessment.title}</h1>
                <p style={{ margin: '5px 0 0 0', color: '#666', fontSize: '16px' }}>
                  {module ? `${module.name} (${module.code})` : 'Unknown Module'} â€¢ {currentUser.role}
                </p>
              </div>
            </div>
            <div>
              <button onClick={goToProfile} className="btn-secondary">Profile</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>

          <main>
            {/* Assessment Overview */}
            <section className="welcome-banner">
              <h2 className="welcome-title">{currentAssessment.title}</h2>
              <p className="welcome-subtitle">{currentAssessment.description}</p>
              <div style={{
                display: 'flex',
                gap: '20px',
                marginTop: '20px',
                flexWrap: 'wrap'
              }}>
                <div style={{
                  backgroundColor: 'rgba(255,255,255,0.2)',
                  padding: '10px 20px',
                  borderRadius: '8px'
                }}>
                  <strong>Type:</strong> {currentAssessment.type?.toUpperCase() || 'ASSIGNMENT'}
                </div>
                <div style={{
                  backgroundColor: 'rgba(255,255,255,0.2)',
                  padding: '10px 20px',
                  borderRadius: '8px'
                }}>
                  <strong>Due:</strong> {new Date(currentAssessment.dueDate || currentAssessment.due_date).toLocaleDateString()}
                </div>
                <div style={{
                  backgroundColor: 'rgba(255,255,255,0.2)',
                  padding: '10px 20px',
                  borderRadius: '8px'
                }}>
                  <strong>Max Marks:</strong> {currentAssessment.maxMarks || currentAssessment.max_marks || 100}
                </div>
                <div style={{
                  backgroundColor: 'rgba(255,255,255,0.2)',
                  padding: '10px 20px',
                  borderRadius: '8px'
                }}>
                  <strong>Status:</strong> {currentAssessment.status || 'draft'}
                </div>
              </div>
            </section>

            {/* Main Content */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: '1fr 1fr',
              gap: '30px',
              marginTop: '30px'
            }}>
              {/* Left Column - Assessment Details */}
              <div>
                <section style={{ marginBottom: '30px' }}>
                  <h3><i className="fas fa-info-circle" style={{ color: '#667eea' }}></i> Assessment Details</h3>
                  <div className="item-card">
                    <h4>Description</h4>
                    <p>{currentAssessment.description}</p>
                    
                    {currentAssessment.criteria && (
                      <>
                        <h4 style={{ marginTop: '20px' }}>Grading Criteria</h4>
                        <p>{currentAssessment.criteria}</p>
                      </>
                    )}
                    
                    <div style={{ marginTop: '20px', paddingTop: '20px', borderTop: '1px solid #eee' }}>
                      <h4>Assessment Information</h4>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginTop: '10px' }}>
                        <div>
                          <p><strong>Type:</strong> {currentAssessment.type?.toUpperCase() || 'ASSIGNMENT'}</p>
                          <p><strong>Max Marks:</strong> {currentAssessment.maxMarks || currentAssessment.max_marks || 100}</p>
                        </div>
                        <div>
                          <p><strong>Due Date:</strong> {new Date(currentAssessment.dueDate || currentAssessment.due_date).toLocaleString()}</p>
                          <p><strong>Created:</strong> {new Date(currentAssessment.createdAt || currentAssessment.created_at).toLocaleDateString()}</p>
                        </div>
                      </div>
                    </div>
                    
                    {currentAssessment.fileUrl && (
                      <div style={{ marginTop: '20px' }}>
                        <button onClick={downloadAssessmentFile} className="btn-primary" style={{ width: '100%' }}>
                          <i className="fas fa-download"></i> Download Assessment File
                        </button>
                      </div>
                    )}
                  </div>
                </section>

                {/* Questions Section */}
                <section>
                  <h3><i className="fas fa-question-circle" style={{ color: '#9b59b6' }}></i> Questions & Answers ({assessmentQuestions.length})</h3>
                  {currentUser.role === 'Student' && (
                    <div className="item-card" style={{ marginBottom: '20px' }}>
                      <h4>Ask a Question</h4>
                      <textarea
                        placeholder="Type your question here..."
                        value={newQuestion}
                        onChange={(e) => setNewQuestion(e.target.value)}
                        rows="4"
                        style={{ width: '100%', padding: '12px', marginBottom: '10px', borderRadius: '8px', border: '1px solid #ddd' }}
                      />
                      <button onClick={askQuestion} className="btn-primary" style={{ width: '100%' }}>
                        <i className="fas fa-paper-plane"></i> Submit Question
                      </button>
                    </div>
                  )}

                  {assessmentQuestions.length === 0 ? (
                    <div className="empty-state">
                      <i className="fas fa-comments" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                      <h4>No questions yet</h4>
                      <p>Be the first to ask a question about this assessment.</p>
                    </div>
                  ) : (
                    <div>
                      {assessmentQuestions.map(question => {
                        const student = users.find(u => u.id === question.studentId);
                        return (
                          <div key={question.id} className="item-card" style={{ marginBottom: '15px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                              <div style={{ flex: 1 }}>
                                <h4 style={{ margin: '0 0 10px 0' }}>
                                  <i className="fas fa-user-graduate" style={{ color: '#3498db', marginRight: '8px' }}></i>
                                  {student?.name || 'Unknown Student'}
                                </h4>
                                <p style={{ margin: '0 0 15px 0', color: '#333' }}>{question.question}</p>
                                <p style={{ fontSize: '12px', color: '#666', margin: 0 }}>
                                  <i className="far fa-clock"></i> Asked on {new Date(question.createdAt || question.created_at).toLocaleDateString()}
                                </p>
                              </div>
                            </div>

                            {/* Answers */}
                            {question.answers && question.answers.length > 0 && (
                              <div style={{ marginTop: '15px', padding: '15px', backgroundColor: '#f8f9fa', borderRadius: '8px' }}>
                                <h5 style={{ margin: '0 0 10px 0', color: '#666' }}>Answers:</h5>
                                {question.answers.map((answer, idx) => {
                                  const instructor = users.find(u => u.id === answer.instructorId);
                                  return (
                                    <div key={idx} style={{
                                      padding: '10px',
                                      marginBottom: '10px',
                                      backgroundColor: 'white',
                                      borderRadius: '6px',
                                      border: '1px solid #e9ecef'
                                    }}>
                                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                                        <div>
                                          <strong style={{ color: answer.official ? '#2ecc71' : '#f39c12' }}>
                                            <i className={`fas fa-${answer.official ? 'user-tie' : 'user-graduate'}`}></i>
                                            {answer.official ? ' Official Answer' : ' Peer Answer'}
                                          </strong>
                                          {instructor && (
                                            <span style={{ marginLeft: '10px', fontSize: '14px', color: '#666' }}>
                                              by {instructor.name}
                                            </span>
                                          )}
                                        </div>
                                        {answer.answeredAt && (
                                          <span style={{ fontSize: '12px', color: '#999' }}>
                                            {new Date(answer.answeredAt).toLocaleDateString()}
                                          </span>
                                        )}
                                      </div>
                                      <p style={{ margin: '5px 0 0 0', color: '#333' }}>{answer.answer}</p>
                                    </div>
                                  );
                                })}
                              </div>
                            )}

                            {/* Instructor Answer Input */}
                            {currentUser.role === 'Instructor' && (
                              <div style={{ marginTop: '15px' }}>
                                <textarea
                                  placeholder="Type your answer here..."
                                  value={answers[question.id] || ''}
                                  onChange={(e) => setAnswers(prev => ({ ...prev, [question.id]: e.target.value }))}
                                  rows="3"
                                  style={{ width: '100%', padding: '12px', marginBottom: '10px', borderRadius: '8px', border: '1px solid #ddd' }}
                                />
                                <button onClick={() => answerQuestion(question.id)} className="btn-primary" style={{ width: '100%' }}>
                                  <i className="fas fa-reply"></i> Submit Answer
                                </button>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </section>
              </div>

              {/* Right Column - Submission & Status */}
              <div>
                {/* Student Submission Section */}
                {currentUser.role === 'Student' && (
                  <section style={{ marginBottom: '30px' }}>
                    <h3><i className="fas fa-upload" style={{ color: '#2ecc71' }}></i> Your Submission</h3>
                    {!studentSubmission ? (
                      <div className="item-card">
                        <h4>Submit Your Work</h4>
                        <p>Please upload your completed assessment file.</p>
                        
                        <div style={{ margin: '20px 0' }}>
                          <label style={{ display: 'block', marginBottom: '10px', fontWeight: '500' }}>
                            Select File
                          </label>
                          <input
                            type="file"
                            onChange={handleFileUpload}
                            style={{ width: '100%', padding: '12px', border: '2px dashed #ddd', borderRadius: '8px', backgroundColor: '#f8f9fa' }}
                          />
                          {selectedFile && (
                            <div style={{ marginTop: '10px', padding: '10px', backgroundColor: '#e8f5e9', borderRadius: '6px' }}>
                              <i className="fas fa-check-circle" style={{ color: '#2ecc71', marginRight: '8px' }}></i>
                              <strong>Selected:</strong> {selectedFile.name} ({(selectedFile.size / 1024).toFixed(2)} KB)
                            </div>
                          )}
                        </div>
                        
                        <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                          <button
                            onClick={submitAssessment}
                            className="btn-primary"
                            style={{ flex: 1 }}
                            disabled={!selectedFile}
                          >
                            <i className="fas fa-paper-plane"></i> Submit Assessment
                          </button>
                          <button
                            onClick={() => setSelectedFile(null)}
                            className="btn-secondary"
                            disabled={!selectedFile}
                          >
                            <i className="fas fa-times"></i> Clear
                          </button>
                        </div>
                        
                        <div style={{ marginTop: '20px', fontSize: '14px', color: '#666' }}>
                          <p><strong>Submission Guidelines:</strong></p>
                          <ul style={{ margin: '10px 0', paddingLeft: '20px' }}>
                            <li>Only upload the required file types (PDF, DOC, DOCX, ZIP)</li>
                            <li>Maximum file size: 10MB</li>
                            <li>Make sure to include your name and student ID in the submission</li>
                            <li>You can only submit once</li>
                          </ul>
                        </div>
                      </div>
                    ) : (
                      <div className="item-card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                          <h4 style={{ margin: 0 }}>Submission Status</h4>
                          <span className={`status-badge status-${studentSubmission.status}`}>
                            {studentSubmission.status.toUpperCase()}
                          </span>
                        </div>
                        
                        <div style={{
                          padding: '15px',
                          backgroundColor: '#f8f9fa',
                          borderRadius: '8px',
                          marginBottom: '15px'
                        }}>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '15px' }}>
                            <div>
                              <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>Submitted On</p>
                              <p style={{ margin: 0, fontWeight: '600' }}>
                                {new Date(studentSubmission.submittedAt).toLocaleString()}
                              </p>
                            </div>
                            <div>
                              <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>File</p>
                              <p style={{ margin: 0, fontWeight: '600' }}>{studentSubmission.fileName}</p>
                            </div>
                          </div>
                          
                          {studentSubmission.grade !== null && (
                            <div style={{
                              padding: '12px',
                              backgroundColor: studentSubmission.releasedToStudent ? '#e8f5e9' : '#fff3cd',
                              borderRadius: '6px',
                              marginBottom: '10px'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                  <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>Grade</p>
                                  <h3 style={{ margin: 0, color: studentSubmission.releasedToStudent ? '#2ecc71' : '#f39c12' }}>
                                    {studentSubmission.grade}/{currentAssessment.maxMarks || currentAssessment.max_marks || 100}
                                  </h3>
                                </div>
                                <div>
                                  <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>Percentage</p>
                                  <h3 style={{ margin: 0, color: '#3498db' }}>
                                    {((studentSubmission.grade / (currentAssessment.maxMarks || currentAssessment.max_marks || 100)) * 100).toFixed(1)}%
                                  </h3>
                                </div>
                              </div>
                            </div>
                          )}
                          
                          {studentSubmission.feedback && (
                            <div>
                              <p style={{ margin: '0 0 8px 0', fontSize: '14px', color: '#666' }}>Instructor Feedback</p>
                              <div style={{
                                padding: '12px',
                                backgroundColor: 'white',
                                borderRadius: '6px',
                                border: '1px solid #e9ecef'
                              }}>
                                <p style={{ margin: 0, color: '#333' }}>{studentSubmission.feedback}</p>
                              </div>
                            </div>
                          )}
                        </div>
                        
                        <div style={{ display: 'flex', gap: '10px' }}>
                          <a
                            href={studentSubmission.fileUrl}
                            download
                            className="btn-primary"
                            style={{ flex: 1 }}
                          >
                            <i className="fas fa-download"></i> Download Your Submission
                          </a>
                          {currentAssessment.fileUrl && (
                            <a
                              href={currentAssessment.fileUrl}
                              download
                              className="btn-secondary"
                            >
                              <i className="fas fa-file-download"></i> Assessment
                            </a>
                          )}
                        </div>
                      </div>
                    )}
                  </section>
                )}

                {/* Instructor View - Submissions */}
                {currentUser.role === 'Instructor' && (
                  <section style={{ marginBottom: '30px' }}>
                    <h3><i className="fas fa-users" style={{ color: '#e74c3c' }}></i> Student Submissions ({assessmentSubmissions.length})</h3>
                    {assessmentSubmissions.length === 0 ? (
                      <div className="empty-state">
                        <i className="fas fa-inbox" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                        <h4>No submissions yet</h4>
                        <p>Student submissions will appear here once they submit their work.</p>
                      </div>
                    ) : (
                      <div>
                        {assessmentSubmissions.map(submission => {
                          const student = users.find(u => u.id === submission.studentId);
                          return (
                            <div key={submission.id} className="item-card" style={{ marginBottom: '15px' }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px' }}>
                                <div>
                                  <h4 style={{ margin: '0 0 5px 0' }}>
                                    <i className="fas fa-user-graduate" style={{ color: '#3498db', marginRight: '8px' }}></i>
                                    {student?.name || 'Unknown Student'}
                                  </h4>
                                  <p style={{ margin: 0, fontSize: '14px', color: '#666' }}>
                                    Submitted: {new Date(submission.submittedAt).toLocaleString()}
                                  </p>
                                </div>
                                <span className={`status-badge status-${submission.status}`}>
                                  {submission.status.toUpperCase()}
                                </span>
                              </div>
                              
                              <div style={{
                                padding: '12px',
                                backgroundColor: '#f8f9fa',
                                borderRadius: '6px',
                                marginBottom: '10px'
                              }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                  <div>
                                    <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>File</p>
                                    <p style={{ margin: 0, fontWeight: '600' }}>{submission.fileName}</p>
                                  </div>
                                  <a href={submission.fileUrl} download className="btn-secondary" style={{ padding: '6px 12px' }}>
                                    <i className="fas fa-download"></i>
                                  </a>
                                </div>
                                
                                {submission.grade !== null && (
                                  <div style={{
                                    padding: '10px',
                                    backgroundColor: 'white',
                                    borderRadius: '4px',
                                    marginTop: '10px'
                                  }}>
                                    <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>Grade</p>
                                    <h4 style={{ margin: 0, color: '#2ecc71' }}>
                                      {submission.grade}/{currentAssessment.maxMarks || currentAssessment.max_marks || 100}
                                    </h4>
                                  </div>
                                )}
                                
                                {submission.feedback && (
                                  <div style={{ marginTop: '10px' }}>
                                    <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>Feedback</p>
                                    <p style={{ margin: 0, color: '#333' }}>{submission.feedback}</p>
                                  </div>
                                )}
                              </div>
                              
                              <button
                                onClick={() => {
                                  window.location.href = `?page=module&module=${module?.code}&tab=grading`;
                                }}
                                className="btn-primary"
                                style={{ width: '100%' }}
                              >
                                <i className="fas fa-graduation-cap"></i> Grade Submission
                              </button>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </section>
                )}

                {/* Module Information */}
                <section>
                  <h3><i className="fas fa-book" style={{ color: '#3498db' }}></i> Module Information</h3>
                  <div className="item-card">
                    {module ? (
                      <>
                        <h4>{module.name}</h4>
                        <p><strong>Code:</strong> {module.code}</p>
                        <p><strong>Description:</strong> {module.description}</p>
                        
                        <div style={{ marginTop: '15px', paddingTop: '15px', borderTop: '1px solid #eee' }}>
                          <div style={{ display: 'flex', gap: '15px', marginBottom: '10px' }}>
                            <div>
                              <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>Total Submissions</p>
                              <p style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#3498db' }}>
                                {assessmentSubmissions.length}
                              </p>
                            </div>
                            <div>
                              <p style={{ margin: '0 0 5px 0', fontSize: '14px', color: '#666' }}>Pending Grading</p>
                              <p style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#f39c12' }}>
                                {assessmentSubmissions.filter(s => s.status === 'submitted').length}
                              </p>
                            </div>
                          </div>
                        </div>
                        
                        <button
                          onClick={() => {
                            window.location.href = `?page=module&module=${module.code}`;
                          }}
                          className="btn-secondary"
                          style={{ width: '100%', marginTop: '15px' }}
                        >
                          <i className="fas fa-external-link-alt"></i> Go to Module
                        </button>
                      </>
                    ) : (
                      <div className="empty-state">
                        <i className="fas fa-exclamation-circle" style={{ fontSize: '32px', color: '#ccc', marginBottom: '10px' }}></i>
                        <p>Module information not available</p>
                      </div>
                    )}
                  </div>
                </section>
              </div>
            </div>
          </main>
        </div>
      );
    };

    // ==================== EXAM ADMIN DASHBOARD ====================
    const ExamAdminDashboard = ({ 
      currentUser, 
      assessments, 
      submissions, 
      users, 
      handleLogout, 
      goToProfile,
      modules = []
    }) => {
      const [userModules, setUserModules] = useState([]);

      useEffect(() => {
        loadUserModules();
      }, [modules, currentUser]);

      const loadUserModules = () => {
        const examAdminModules = modules.filter(m => 
          m.exam_admin_id === currentUser.id || m.examAdminId === currentUser.id
        );
        setUserModules(examAdminModules);
      };

      const groupedSubmissions = {};
      assessments.forEach(assessment => {
        const assessmentSubmissions = submissions.filter(s => s.assessmentId === assessment.id);
        if (assessmentSubmissions.length > 0) {
          groupedSubmissions[assessment.id] = {
            assessment,
            submissions: assessmentSubmissions
          };
        }
      });

      const assessmentStats = assessments.map(assessment => {
        const assessmentSubmissions = submissions.filter(s => s.assessmentId === assessment.id && s.grade);
        const totalGrade = assessmentSubmissions.reduce((sum, s) => sum + parseFloat(s.grade || 0), 0);
        const averageGrade = assessmentSubmissions.length > 0 ? totalGrade / assessmentSubmissions.length : 0;
        
        return {
          ...assessment,
          submissionCount: assessmentSubmissions.length,
          averageGrade: averageGrade.toFixed(2)
        };
      });

      const openModule = (moduleCode) => {
        window.location.href = `?page=module&module=${moduleCode}`;
      };

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Welcome, {currentUser.name} (Exam Administrator)</h1>
            </div>
            <div>
              <button onClick={goToProfile} className="btn-secondary">Profile</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>
          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">Exam Administration Dashboard</h2>
              <p className="welcome-subtitle">
                Monitor assessment results, grades, and feedback across all courses
              </p>
            </section>
            
            <section>
              <h3>My Modules ({userModules.length})</h3>
              {userModules.length === 0 ? (
                <div className="empty-state">
                  <i className="fas fa-book" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                  <h4>No modules assigned</h4>
                  <p>Contact the system administrator to get assigned to modules.</p>
                </div>
              ) : (
                <div className="quick-actions">
                  {userModules.map(module => (
                    <div key={module.code} className="item-card">
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <div style={{ flex: 1 }}>
                          <h4>{module.name}</h4>
                          <p><strong>Code:</strong> {module.code}</p>
                          <p><strong>Description:</strong> {module.description}</p>
                        </div>
                        <button 
                          onClick={() => openModule(module.code)}
                          className="btn-primary"
                          style={{ padding: '8px 16px' }}
                        >
                          <i className="fas fa-external-link-alt"></i> Open
                        </button>
                      </div>
                      
                      <div style={{ marginTop: '15px', fontSize: '14px', color: '#666' }}>
                        <p><strong>Module Access:</strong> You can view and approve grades for this module.</p>
                        <p>Open the module to review graded submissions and approve/release grades to students.</p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </section>
            
            <section>
              <h3>Assessment Statistics ({assessments.length})</h3>
              {assessments.length === 0 ? (
                <div className="empty-state">
                  <i className="fas fa-chart-bar" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                  <h4>No assessments yet</h4>
                  <p>Assessment statistics will appear here once instructors create assessments.</p>
                </div>
              ) : (
                <div className="quick-actions">
                  {assessmentStats.map(stat => (
                    <div key={stat.id} className="item-card">
                      <h4>{stat.title}</h4>
                      <p><strong>Course:</strong> {stat.course}</p>
                      <p><strong>Submissions:</strong> {stat.submissionCount}</p>
                      <p><strong>Average Grade:</strong> {stat.averageGrade}%</p>
                      <p><strong>Deadline:</strong> {new Date(stat.deadline).toLocaleDateString()}</p>
                    </div>
                  ))}
                </div>
              )}
            </section>
            
            <section>
              <h3>Detailed Submission Results ({submissions.length})</h3>
              {submissions.length === 0 ? (
                <div className="empty-state">
                  <i className="fas fa-file-upload" style={{ fontSize: '48px', color: '#ccc', marginBottom: '20px' }}></i>
                  <h4>No submissions yet</h4>
                  <p>Submission results will appear here once students submit their work.</p>
                </div>
              ) : (
                <div className="quick-actions">
                  {Object.values(groupedSubmissions).map(({ assessment, submissions: assessmentSubmissions }) => (
                    <div key={assessment.id} className="item-card">
                      <h4>{assessment.title}</h4>
                      <p><strong>Grading Criteria:</strong> {assessment.criteria}</p>
                      <div style={{ marginTop: '15px' }}>
                        <h5>Student Submissions:</h5>
                        {assessmentSubmissions.map(submission => {
                          const student = users.find(u => u.id === submission.studentId);
                          return (
                            <div key={submission.id} style={{ 
                              padding: '10px', 
                              margin: '5px 0', 
                              backgroundColor: 'rgba(102, 126, 234, 0.05)',
                              borderRadius: '5px'
                            }}>
                              <p><strong>Student:</strong> {student?.name || 'Unknown'}</p>
                              <p><strong>Grade:</strong> {submission.grade || 'Not graded'}</p>
                              <p><strong>Status:</strong> 
                                <span className={`status-badge status-${submission.status}`} style={{ marginLeft: '10px' }}>
                                  {submission.status}
                                </span>
                              </p>
                              {submission.feedback && (
                                <p><strong>Feedback:</strong> {submission.feedback}</p>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </section>
          </main>
        </div>
      );
    };

    // ==================== PROFILE PAGE ====================
    const ProfilePage = ({ currentUser, setCurrentUser, users, setUsers, goBack, handleLogout }) => {
      const [profileData, setProfileData] = useState({ 
        name: currentUser.name, 
        email: currentUser.email,
        password: ''
      });

      const handleUpdate = async (e) => {
        e.preventDefault();
        try {
          const updatedUser = { 
            ...currentUser, 
            name: profileData.name, 
            email: profileData.email
          };
          
          if (profileData.password) {
            updatedUser.password = profileData.password;
          }
          
          const supabaseUpdatedUser = await SupabaseService.updateUser(currentUser.id, {
            name: profileData.name,
            email: profileData.email,
            ...(profileData.password && { password: profileData.password })
          });
          
          setCurrentUser(supabaseUpdatedUser);
          
          const updatedUsers = users.map(u => 
            u.id === currentUser.id ? supabaseUpdatedUser : u
          );
          setUsers(updatedUsers);
          
          localStorage.setItem('currentUser', JSON.stringify(supabaseUpdatedUser));
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          
          alert('Profile updated successfully');
          setProfileData({ ...profileData, password: '' });
        } catch (error) {
          const updatedUser = { 
            ...currentUser, 
            name: profileData.name, 
            email: profileData.email
          };
          
          if (profileData.password) {
            updatedUser.password = profileData.password;
          }
          
          setCurrentUser(updatedUser);
          
          const updatedUsers = users.map(u => 
            u.id === currentUser.id ? updatedUser : u
          );
          setUsers(updatedUsers);
          
          localStorage.setItem('currentUser', JSON.stringify(updatedUser));
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          
          alert('Profile updated');
          setProfileData({ ...profileData, password: '' });
        }
      };

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Profile Settings</h1>
            </div>
            <div>
              <button onClick={goBack} className="btn-secondary">Back to Dashboard</button>
              <button onClick={handleLogout} className="btn-danger">Logout</button>
            </div>
          </header>
          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">Profile Management</h2>
              <p className="welcome-subtitle">
                Update your personal information and account settings
              </p>
            </section>
            
            <section>
              <h3>Your Profile Information</h3>
              <form onSubmit={handleUpdate} className="form-container" style={{ maxWidth: '600px' }}>
                <div style={{ marginBottom: '20px' }}>
                  <p><strong>Current Role:</strong> {currentUser.role}</p>
                  <p><strong>Account Status:</strong> {currentUser.active ? 'Active' : 'Inactive'}</p>
                </div>
                
                <input 
                  type="text" 
                  placeholder="Full Name" 
                  value={profileData.name} 
                  onChange={e => setProfileData({ ...profileData, name: e.target.value })} 
                  required 
                />
                <input 
                  type="email" 
                  placeholder="Email Address" 
                  value={profileData.email} 
                  onChange={e => setProfileData({ ...profileData, email: e.target.value })} 
                  required 
                />
                <input 
                  type="password" 
                  placeholder="New Password (leave blank to keep current)" 
                  value={profileData.password} 
                  onChange={e => setProfileData({ ...profileData, password: e.target.value })} 
                />
                <button type="submit" className="btn-primary">Update Profile</button>
              </form>
            </section>
          </main>
        </div>
      );
    };

    // ==================== SYSTEM ADMIN DASHBOARD ====================
    const SystemAdminDashboard = ({ 
      currentUser, 
      users = [], 
      setUsers, 
      modules = [], 
      setModules,
      classes = [],
      setClasses,
      handleLogout, 
      goToProfile,
      showAddUserPopup,
      setShowAddUserPopup,
      popupUserData,
      setPopupUserData,
      handlePopupUserSubmit
    }) => {
      if (!currentUser) {
        return (
          <div className="form-container">
            <h2>No User Logged In</h2>
            <p>Please log in to access the admin dashboard.</p>
            <button className="btn-primary" onClick={handleLogout}>
              Go to Login
            </button>
          </div>
        );
      }

      const [moduleData, setModuleData] = useState({ 
        name: '', 
        description: '',
        instructorId: '',
        examAdminId: '' 
      });
      const [classData, setClassData] = useState({ name: '', moduleCode: '', classType: 'lecture' });

      const handleModuleSubmit = async (e) => {
        e.preventDefault();

        if (!moduleData.instructorId) {
          alert('Please select an instructor for the module');
          return;
        }
        
        if (!moduleData.examAdminId) {
          alert('Please select an exam administrator for the module');
          return;
        }
        
        try {
          const generateModuleCode = (name) => {
            if (!name) return 'MOD';
            
            const initials = name
              .split(' ')
              .map(word => word[0] || '')
              .filter(char => char && char.match(/[A-Za-z]/))
              .join('')
              .toUpperCase()
              .slice(0, 3);
            
            const now = new Date();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yyyy = now.getFullYear().toString();
            
            return `${initials || 'MOD'}-${mm}${yyyy}`;
          };
          
          const code = generateModuleCode(moduleData.name);
          const invitationCode = await SupabaseService.generateUniqueInvitationCode();
          
          const newModule = { 
            code, 
            name: moduleData.name, 
            description: moduleData.description,
            instructor_id: moduleData.instructorId ? parseInt(moduleData.instructorId) : null,
            exam_admin_id: moduleData.examAdminId ? parseInt(moduleData.examAdminId) : null,
            invitation_code: invitationCode
          };
          
          const createdModule = await SupabaseService.createModule(newModule);
          const updatedModules = [...modules, createdModule];
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          setModuleData({ name: '', description: '', instructorId: '', examAdminId: '' });
          alert(`Module "${moduleData.name}" created with code: ${code}, the invitation code is: ${invitationCode}`);
        } catch (error) {
          const generateModuleCode = (name) => {
            if (!name) return 'MOD';
            
            const initials = name
              .split(' ')
              .map(word => word[0] || '')
              .filter(char => char && char.match(/[A-Za-z]/))
              .join('')
              .toUpperCase()
              .slice(0, 3);
            
            const now = new Date();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yyyy = now.getFullYear().toString();
            
            return `${initials || 'MOD'}-${mm}${yyyy}`;
          };
          
          const moduleCode = generateModuleCode(moduleData.name);
          const invitationCode = SupabaseService.generateInvitationCode();
          
          const newModule = { 
            code: moduleCode,
            name: moduleData.name, 
            description: moduleData.description,
            instructorId: moduleData.instructorId ? parseInt(moduleData.instructorId) : null,
            examAdminId: moduleData.examAdminId ? parseInt(moduleData.examAdminId) : null,
            invitation_code: invitationCode
          };
          
          const updatedModules = [...modules, newModule];
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          
          setModuleData({ name: '', description: '', instructorId: '', examAdminId: '' });
          alert(`Module created\n\nModule Code: ${moduleCode}\nInvitation Code: ${invitationCode}`);
        }
      };

      const handleGenerateInvitationCode = async (moduleCode) => {
        try {
          const newCode = await SupabaseService.generateUniqueInvitationCode();
          
          const updatedModule = await SupabaseService.updateModuleInvitationCode(moduleCode, newCode);
          
          const updatedModules = modules.map(m => 
            m.code === moduleCode ? { ...m, invitation_code: newCode } : m
          );
          setModules(updatedModules);
          localStorage.setItem('modules', JSON.stringify(updatedModules));
          
          alert(`New invitation code generated: ${newCode}`);
        } catch (error) {
          alert('Failed to generate invitation code');
        }
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text)
          .then(() => {
            alert('Invitation code copied to clipboard!');
          })
          .catch(err => {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Invitation code copied!');
          });
      };

      const deleteModule = async (moduleCode) => {
        if (window.confirm('Are you sure you want to delete this module?')) {
          try {
            await SupabaseService.deleteModule(moduleCode);
            const updatedModules = modules.filter(m => m.code !== moduleCode);
            setModules(updatedModules);
            localStorage.setItem('modules', JSON.stringify(updatedModules));
          } catch (error) {
            const updatedModules = modules.filter(m => m.code !== moduleCode);
            setModules(updatedModules);
            localStorage.setItem('modules', JSON.stringify(updatedModules));
          }
        }
      };

      const handleClassSubmit = async (e) => {
        e.preventDefault();
        
        if (!classData.moduleCode || !classData.classType || !classData.name) {
          alert('Please fill in all required fields');
          return;
        }
        
        try {
          const existingClasses = classes.filter(c => 
            c.module_code === classData.moduleCode
          );
          const classNumber = existingClasses.length + 1;
          
          const displayName = `${classData.name} - ${classData.classType.charAt(0).toUpperCase() + classData.classType.slice(1)} ${classNumber}`;
          
          const newClass = { 
            name: displayName,
            module_code: classData.moduleCode,
            students: []
          };
          
          const createdClass = await SupabaseService.createClass(newClass);
          
          const classWithType = {
            ...createdClass,
            class_type: classData.classType,
            display_code: `${classData.moduleCode}_${classData.classType}_${classNumber}`
          };
          
          const updatedClasses = [...classes, classWithType];
          setClasses(updatedClasses);
          localStorage.setItem('classes', JSON.stringify(updatedClasses));
          
          setClassData({ name: '', moduleCode: '', classType: 'lecture' });
          alert(`Class "${displayName}" created successfully!`);
        } catch (error) {
          const existingClassesOfSameType = classes.filter(c => 
            c.module_code === classData.moduleCode
          );
          const classNumber = existingClassesOfSameType.length + 1;
          const displayName = `${classData.name} - ${classData.classType.charAt(0).toUpperCase() + classData.classType.slice(1)} ${classNumber}`;
          
          const newClass = { 
            id: Date.now(), 
            name: displayName,
            module_code: classData.moduleCode,
            class_type: classData.classType,
            students: [],
            display_code: `${classData.moduleCode}_${classData.classType}_${classNumber}`,
            created_at: new Date().toISOString()
          };
          
          const updatedClasses = [...classes, newClass];
          setClasses(updatedClasses);
          localStorage.setItem('classes', JSON.stringify(updatedClasses));
          
          setClassData({ name: '', moduleCode: '', classType: 'lecture' });
          alert(`Class created: ${displayName}`);
        }
      };

      const deleteClass = async (classId) => {
        if (window.confirm('Are you sure you want to delete this class?')) {
          try {
            await SupabaseService.deleteClass(classId);
            const updatedClasses = classes.filter(c => c.id !== classId);
            setClasses(updatedClasses);
            localStorage.setItem('classes', JSON.stringify(updatedClasses));
            alert('Class deleted successfully');
          } catch (error) {
            const updatedClasses = classes.filter(c => c.id !== classId);
            setClasses(updatedClasses);
            localStorage.setItem('classes', JSON.stringify(updatedClasses));
            alert('Class deleted');
          }
        }
      };

      const toggleUser = async (userId) => {
        try {
          const user = users.find(u => u.id === userId);
          const updatedUser = await SupabaseService.updateUser(userId, {
            active: !user.active
          });
          
          const updatedUsers = users.map(u => 
            u.id === userId ? updatedUser : u
          );
          setUsers(updatedUsers);
          localStorage.setItem('users', JSON.stringify(updatedUsers));
        } catch (error) {
          const updatedUsers = users.map(u => 
            u.id === userId ? { ...u, active: !u.active } : u
          );
          setUsers(updatedUsers);
          localStorage.setItem('users', JSON.stringify(updatedUsers));
        }
      };

      const getUserName = (userId) => {
        if (!userId) return 'Not assigned';
        const user = users.find(u => u.id === userId);
        return user ? user.name : 'Unknown';
      };

      const getClassTypeBadge = (type) => {
        switch(type) {
          case 'lecture':
            return { label: 'Lecture', color: '#3498db', bgColor: '#ebf5fb' };
          case 'tutorial':
            return { label: 'Tutorial', color: '#2ecc71', bgColor: '#eafaf1' };
          case 'lab':
            return { label: 'Lab', color: '#e74c3c', bgColor: '#fdedec' };
          default:
            return { label: type, color: '#7f8c8d', bgColor: '#f2f3f4' };
        }
      };

      const getClassTypeFromName = (name) => {
        if (!name) return 'unknown';
        const lowerName = name.toLowerCase();
        if (lowerName.includes('lecture')) return 'lecture';
        if (lowerName.includes('tutorial')) return 'tutorial';
        if (lowerName.includes('lab')) return 'lab';
        return 'unknown';
      };

      const getDisplayCode = (classObj) => {
        if (classObj.display_code) return classObj.display_code;
        
        const module = modules.find(m => m.code === classObj.module_code);
        if (module) {
          const type = getClassTypeFromName(classObj.name);
          const similarClasses = classes.filter(c => 
            c.module_code === classObj.module_code && 
            getClassTypeFromName(c.name) === type
          );
          const index = similarClasses.findIndex(c => c.id === classObj.id) + 1;
          return `${module.code}_${type}_${index}`;
        }
        return 'N/A';
      };

      return (
        <div className="main-container">
          <header>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
              <h1>Welcome, {currentUser.name} (System Administrator)</h1>
            </div>
            <div>
              <button className="btn-secondary" onClick={goToProfile}>Profile</button>
              <button className="btn-danger" onClick={handleLogout}>Logout</button>
            </div>
          </header>

          <main>
            <section className="welcome-banner">
              <h2 className="welcome-title">System Administrator Dashboard</h2>
              <p className="welcome-subtitle">
                Manage users, modules, classes, and system settings
              </p>
            </section>

            <section>
              <h3>Quick Actions</h3>
              <div className="quick-actions">
                <div className="action-card">
                  <div className="action-card-icon">
                    <i className="fas fa-user-plus"></i>
                  </div>
                  <h4 className="action-card-title">Create User Account</h4>
                  <p className="action-card-description">
                    Add new students, instructors, or administrators to the system
                  </p>
                  <button className="action-btn" onClick={() => setShowAddUserPopup(true)}>
                    <i className="fas fa-plus"></i> Add User
                  </button>
                </div>
                
                <div className="action-card">
                  <div className="action-card-icon">
                    <i className="fas fa-book"></i>
                  </div>
                  <h4 className="action-card-title">Manage Modules</h4>
                  <p className="action-card-description">
                    Create and manage course modules for the academic system
                  </p>
                  <button className="action-btn" onClick={() => document.getElementById('manage-modules')?.scrollIntoView({ behavior: 'smooth' })}>
                    <i className="fas fa-arrow-right"></i> View Modules
                  </button>
                </div>
                
                <div className="action-card">
                  <div className="action-card-icon">
                    <i className="fas fa-users"></i>
                  </div>
                  <h4 className="action-card-title">Class Management</h4>
                  <p className="action-card-description">
                    Create and manage classes (lecture, tutorial, lab) for modules
                  </p>
                  <button className="action-btn" onClick={() => document.getElementById('create-class-form')?.scrollIntoView({ behavior: 'smooth' })}>
                    <i className="fas fa-arrow-right"></i> Create Class
                  </button>
                </div>
              </div>
            </section>
            
            <section id="manage-users">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h3>Manage Users ({users.length})</h3>
                <button 
                  onClick={() => setShowAddUserPopup(true)}
                  className="btn-primary"
                  style={{ display: 'flex', alignItems: 'center', gap: '8px' }}
                >
                  <i className="fas fa-plus"></i> Add User
                </button>
              </div>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', 
                gap: '20px', 
                marginTop: '20px' 
              }}>
                {users.map(u => (
                  <div key={u.id} className="item-card">
                    <h4>{u.name}</h4>
                    <p><strong>Email:</strong> {u.email}</p>
                    <p><strong>Role:</strong> {u.role}</p>
                    <p><strong>Status:</strong> {u.active ? 'âœ… Active' : 'âŒ Inactive'}</p>
                    <button 
                      onClick={() => toggleUser(u.id)}
                      className={u.active ? 'btn-danger' : 'btn-success'}
                      style={{ marginTop: '10px', width: '100%' }}
                    >
                      {u.active ? 'Deactivate Account' : 'Activate Account'}
                    </button>
                  </div>
                ))}
              </div>
            </section>
            
            <section id="create-module-form">
              <h3>Create Module</h3>
              <form onSubmit={handleModuleSubmit} className="form-container" style={{ maxWidth: '600px', margin: '0 auto' }}>
                <input 
                  type="text" 
                  placeholder="Module Name (e.g., Software Development)" 
                  value={moduleData.name} 
                  onChange={(e) => setModuleData({ ...moduleData, name: e.target.value })} 
                  required
                />
                <textarea 
                  placeholder="Module Description" 
                  value={moduleData.description} 
                  onChange={(e) => setModuleData({ ...moduleData, description: e.target.value })} 
                  required
                  rows="4"
                />
                
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500', color: '#333' }}>
                    Select instructor
                  </label>
                  <select 
                    value={moduleData.instructorId} 
                    onChange={(e) => setModuleData({ ...moduleData, instructorId: e.target.value })} 
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px', 
                      marginBottom: '15px',
                      border: '1px solid #ddd',
                      borderRadius: '8px',
                      fontSize: '16px',
                      backgroundColor: 'white'
                    }}
                  >
                  <option value="">Select Instructor</option>
                    {users
                      .filter(user => user.role === 'Instructor' && user.active)
                      .map(instructor => (
                        <option key={instructor.id} value={instructor.id}>
                          {instructor.name} ({instructor.email})
                        </option>
                      ))
                    }
                  </select>
                </div>
                
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500', color: '#333' }}>
                    Select Exam Administrator
                  </label>
                  <select 
                    value={moduleData.examAdminId} 
                    onChange={(e) => setModuleData({ ...moduleData, examAdminId: e.target.value })} 
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px', 
                      marginBottom: '15px',
                      border: '1px solid #ddd',
                      borderRadius: '8px',
                      fontSize: '16px',
                      backgroundColor: 'white'
                    }}
                  >
                  <option value="">Select Exam Administrator</option>
                    {users
                      .filter(user => user.role === 'Exam Administrator' && user.active)
                      .map(admin => (
                        <option key={admin.id} value={admin.id}>
                          {admin.name} ({admin.email})
                        </option>
                      ))
                    }
                  </select>
                </div>
                
                <button type="submit" className="btn-primary">Create Module</button>
              </form>
            </section>
            
            <section id="manage-modules">
              <h3>Manage Modules ({modules.length})</h3>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', 
                gap: '20px', 
                marginTop: '20px' 
              }}>
                {modules.map(m => {
                  const instructorId = m.instructor_id || m.instructorId;
                  const examAdminId = m.exam_admin_id || m.examAdminId;
                  const moduleClasses = classes.filter(c => c.module_code === m.code);
                  
                  return (
                    <div key={m.code} className="item-card">
                      <h4>{m.name}</h4>
                      <p><strong>Code:</strong> {m.code}</p>
                      <p><strong>Description:</strong> {m.description}</p>
                      <p><strong>Instructor:</strong> {getUserName(instructorId)}</p>
                      <p><strong>Exam Admin:</strong> {getUserName(examAdminId)}</p>
                      <p><strong>Total Classes:</strong> {moduleClasses.length}</p>
                      <button 
                        onClick={() => deleteModule(m.code)}
                        className="btn-danger"
                        style={{ marginTop: '10px', width: '100%' }}
                      >
                        Delete Module
                      </button>
                    </div>
                  );
                })}
              </div>
            </section>

            <section id="module-invitation">
              <h3>Module Invitation Codes</h3>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', 
                gap: '20px', 
                marginTop: '20px' 
              }}>
                {modules.map(m => {
                  const instructorId = m.instructor_id || m.instructorId;
                  const moduleClasses = classes.filter(c => c.module_code === m.code);
                  
                  return (
                    <div key={m.code} className="item-card">
                      <h4>{m.name}</h4>
                      <p><strong>Code:</strong> {m.code}</p>
                      <div className="invitation-code-display">
                        {m.invitation_code || 'No code generated'}
                      </div>
                      
                      <div className="invite-actions">
                        <button 
                          onClick={() => handleGenerateInvitationCode(m.code)}
                          className="refresh-btn"
                        >
                          <i className="fas fa-sync-alt"></i>
                          {m.invitation_code ? 'Regenerate' : 'Generate'}
                        </button>
                        
                        {m.invitation_code && (
                          <button 
                            onClick={() => copyToClipboard(m.invitation_code)}
                            className="copy-btn"
                          >
                            <i className="fas fa-copy"></i>
                            Copy Code
                          </button>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </section>
            
            <section id="create-class-form">
              <h3>Create Class</h3>
              <form onSubmit={handleClassSubmit} className="form-container" style={{ maxWidth: '600px', margin: '0 auto' }}>
                <input 
                  type="text" 
                  placeholder="Class Base Name (e.g., SDM Class)" 
                  value={classData.name} 
                  onChange={(e) => setClassData({ ...classData, name: e.target.value })} 
                  required
                />
                
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500', color: '#333' }}>
                    Select Module *
                  </label>
                  <select 
                    value={classData.moduleCode} 
                    onChange={(e) => setClassData({ ...classData, moduleCode: e.target.value })} 
                    required
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px', 
                      marginBottom: '15px',
                      border: '1px solid #ddd',
                      borderRadius: '8px',
                      fontSize: '16px',
                      backgroundColor: 'white'
                    }}
                  >
                    <option value="">Select Module</option>
                    {modules.map(m => (
                      <option key={m.code} value={m.code}>
                        {m.name} ({m.code})
                      </option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label style={{ display: 'block', marginBottom: '5px', fontWeight: '500', color: '#333' }}>
                    Select Class Type *
                  </label>
                  <select 
                    value={classData.classType} 
                    onChange={(e) => setClassData({ ...classData, classType: e.target.value })} 
                    required
                    style={{ 
                      width: '100%', 
                      padding: '12px 15px', 
                      marginBottom: '15px',
                      border: '1px solid #ddd',
                      borderRadius: '8px',
                      fontSize: '16px',
                      backgroundColor: 'white'
                    }}
                  >
                    <option value="lecture">Lecture</option>
                    <option value="tutorial">Tutorial</option>
                    <option value="lab">Lab</option>
                  </select>
                </div>
                
                {classData.moduleCode && classData.classType && classData.name && (
                  <div style={{ 
                    padding: '12px 15px', 
                    marginBottom: '15px',
                    border: '1px solid #ddd',
                    borderRadius: '8px',
                    backgroundColor: '#f8f9fa',
                    fontSize: '14px'
                  }}>
                    <p style={{ margin: '0', fontWeight: '500' }}>Class Preview:</p>
                    <p style={{ 
                      margin: '5px 0 0 0', 
                      fontSize: '16px', 
                      fontWeight: '600',
                      color: '#667eea'
                    }}>
                      {classData.name} - {classData.classType.charAt(0).toUpperCase() + classData.classType.slice(1)} {classes.filter(c => c.module_code === classData.moduleCode).length + 1}
                    </p>
                    <p style={{ 
                      margin: '5px 0 0 0', 
                      fontSize: '14px', 
                      color: '#666'
                    }}>
                      <strong>Display Code:</strong> {classData.moduleCode}_{classData.classType}_{classes.filter(c => c.module_code === classData.moduleCode).length + 1}
                    </p>
                  </div>
                )}
                
                <button type="submit" className="btn-primary">Create Class</button>
              </form>
            </section>
            
            <section id="manage-classes">
              <h3>Manage Classes ({classes.length})</h3>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', 
                gap: '20px', 
                marginTop: '20px' 
              }}>
                {classes.map(c => {
                  const module = modules.find(m => m.code === c.module_code);
                  const classType = c.class_type || getClassTypeFromName(c.name);
                  const badge = getClassTypeBadge(classType);
                  const displayCode = getDisplayCode(c);
                  
                  return (
                    <div key={c.id} className="item-card">
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                        <h4 style={{ margin: 0 }}>{c.name}</h4>
                        <span style={{
                          padding: '4px 8px',
                          backgroundColor: badge.bgColor,
                          color: badge.color,
                          borderRadius: '4px',
                          fontSize: '12px',
                          fontWeight: '600'
                        }}>
                          {badge.label}
                        </span>
                      </div>
                      <p><strong>Module:</strong> {module?.name || 'Unknown'}</p>
                      <p><strong>Display Code:</strong> {displayCode}</p>
                      <p><strong>Module Code:</strong> {c.module_code || 'N/A'}</p>
                      <p><strong>Students:</strong> {c.students?.length || 0}</p>
                      {c.created_at && (
                        <p><strong>Created:</strong> {new Date(c.created_at).toLocaleDateString()}</p>
                      )}
                      <button 
                        onClick={() => deleteClass(c.id)}
                        className="btn-danger"
                        style={{ marginTop: '10px', width: '100%' }}
                      >
                        Delete Class
                      </button>
                    </div>
                  );
                })}
              </div>
            </section>
          </main>
        </div>
      );
    };

    // ==================== LOGIN PAGE ====================
    const LoginPage = ({ loginData, setLoginData, handleLogin, goToRegister }) => (
      <div className="form-container">
        <div style={{ textAlign: 'center', marginBottom: '20px' }}>
          <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
        </div>
        <h2 style={{
          fontSize: '32px',
          fontWeight: '300',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          WebkitBackgroundClip: 'text',
          WebkitTextFillColor: 'transparent',
          marginBottom: '25px',
          textAlign: 'center',
          letterSpacing: '0.5px'
        }}>
          Login to EduConnect
        </h2>
        
        <form onSubmit={handleLogin}>
          <input 
            type="email" 
            placeholder="Email" 
            value={loginData.email} 
            onChange={e => setLoginData({ ...loginData, email: e.target.value })} 
            required 
          />
          <input 
            type="password" 
            placeholder="Password" 
            value={loginData.password} 
            onChange={e => setLoginData({ ...loginData, password: e.target.value })} 
            required 
          />

          <div className="login-alert-credentials">
            <h4><i className="fas fa-info-circle"></i> No Account Access?</h4>
            <p>Contact the administrator to request account creation.</p>
          </div>

          <button type="submit" className="btn-primary">Login</button>
        </form>
      </div>
    );

    // ==================== REGISTER PAGE ====================
    const RegisterPage = ({ registerData, setRegisterData, handleRegister, goToLogin }) => (
      <div className="form-container">
        <div style={{ textAlign: 'center', marginBottom: '20px' }}>
          <img src="Images/Logo.png" alt="EduConnect Logo" className="logo" />
        </div>
        <h2
          style={{
            fontSize: '32px',
            fontWeight: '300',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            marginBottom: '25px',
            textAlign: 'center',
            letterSpacing: '0.5px'
          }}
        >Register for EduConnect</h2>
        <form onSubmit={handleRegister}>
          <input 
            type="text" 
            placeholder="Full Name" 
            value={registerData.name} 
            onChange={e => setRegisterData({ ...registerData, name: e.target.value })} 
            required 
          />
          <input 
            type="email" 
            placeholder="Email Address" 
            value={registerData.email} 
            onChange={e => setRegisterData({ ...registerData, email: e.target.value })} 
            required 
          />
          <input 
            type="password" 
            placeholder="Password" 
            value={registerData.password} 
            onChange={e => setRegisterData({ ...registerData, password: e.target.value })} 
            required 
          />
          <select 
            value={registerData.role} 
            onChange={e => setRegisterData({ ...registerData, role: e.target.value })} 
            required
          >
            <option value="">Select Role</option>
            <option value="Student">Student</option>
            <option value="Instructor">Instructor</option>
            <option value="System Administrator">System Administrator</option>
            <option value="Exam Administrator">Exam Administrator</option>
          </select>
          <button type="submit" className="btn-primary">Register</button>
        </form>
        <p>
          Already have an account?{' '}
          <button onClick={goToLogin} className="btn-secondary">Login</button>
        </p>
      </div>
    );

    // ==================== HOMEPAGE (MAIN CONTROLLER) ====================
    const HomePage = () => {
      const [page, setPage] = useState('login');
      const [users, setUsers] = useState([]);
      const [assessments, setAssessments] = useState([]);
      const [submissions, setSubmissions] = useState([]);
      const [questions, setQuestions] = useState([]);
      const [modules, setModules] = useState([]);
      const [classes, setClasses] = useState([]);
      const [teachingMaterials, setTeachingMaterials] = useState([]);
      const [currentUser, setCurrentUser] = useState(null);
      const [loginData, setLoginData] = useState({ email: '', password: '' });
      const [registerData, setRegisterData] = useState({ name: '', email: '', password: '', role: '' });
      const [isLoading, setIsLoading] = useState(true);
      
      const [showAddUserPopup, setShowAddUserPopup] = useState(false);
      const [popupUserData, setPopupUserData] = useState({ name: '', email: '', password: '', role: '' });

      useEffect(() => {
        const initializeData = async () => {
          setIsLoading(true);
          
          try {
            const [
              usersData, 
              assessmentsData, 
              submissionsData, 
              questionsData, 
              modulesData, 
              classesData,
              teachingMaterialsData
            ] = await Promise.all([
              SupabaseService.getUsers(),
              SupabaseService.getAssessments(),
              SupabaseService.getSubmissions(),
              SupabaseService.getQuestions(),
              SupabaseService.getModules(),
              SupabaseService.getClasses(),
              SupabaseService.getTeachingMaterials()
            ]);
            
            setUsers(usersData);
            setAssessments(assessmentsData);
            setSubmissions(submissionsData);
            setQuestions(questionsData);
            setModules(modulesData);
            setClasses(classesData);
            setTeachingMaterials(teachingMaterialsData);
            
            if (usersData.length === 0) {
              await createDefaultUsers();
            }
            if (modulesData.length === 0) {
              await createDefaultModules();
            }
            
            const storedUser = JSON.parse(localStorage.getItem('currentUser'));
            if (storedUser) {
              setCurrentUser(storedUser);
              redirectBasedOnRole(storedUser.role);
            } else {
              setPage('login');
            }
            
          } catch (error) {
            console.error('Error loading data:', error);
            loadFromLocalStorage();
          } finally {
            setIsLoading(false);
          }
        };
        
        initializeData();
      }, []);

      const loadFromLocalStorage = () => {
        const storedUsers = JSON.parse(localStorage.getItem('users')) || [];
        const storedAssessments = JSON.parse(localStorage.getItem('assessments')) || [];
        const storedSubmissions = JSON.parse(localStorage.getItem('submissions')) || [];
        const storedQuestions = JSON.parse(localStorage.getItem('questions')) || [];
        const storedModules = JSON.parse(localStorage.getItem('modules')) || [];
        const storedClasses = JSON.parse(localStorage.getItem('classes')) || [];
        const storedTeachingMaterials = JSON.parse(localStorage.getItem('teachingMaterials')) || [];
        
        let updatedUsers = storedUsers;
        if (storedUsers.length === 0) {
          updatedUsers = createDefaultUsersLocal();
          localStorage.setItem('users', JSON.stringify(updatedUsers));
        }
        
        let updatedModules = storedModules;
        if (storedModules.length === 0) {
          updatedModules = createDefaultModulesLocal();
          localStorage.setItem('modules', JSON.stringify(updatedModules));
        }
        
        let updatedClasses = storedClasses;
        if (storedClasses.length === 0 && updatedModules.length > 0) {
          updatedClasses = createDefaultClassesLocal(updatedModules);
          localStorage.setItem('classes', JSON.stringify(updatedClasses));
        }
        
        setUsers(updatedUsers);
        setAssessments(storedAssessments);
        setSubmissions(storedSubmissions);
        setQuestions(storedQuestions);
        setModules(updatedModules);
        setClasses(updatedClasses);
        setTeachingMaterials(storedTeachingMaterials);
      };

      const createDefaultModulesLocal = () => {
        return [
          { 
            code: 'NWT-112025-01', 
            name: 'Networking Technologies', 
            description: 'Basic networking concepts and technologies',
            instructor_id: null,
            exam_admin_id: null 
          },
          { 
            code: 'OOP-112025-02', 
            name: 'Object-Oriented Programming', 
            description: 'Advanced object-oriented programming concepts',
            instructor_id: null,
            exam_admin_id: null 
          },
          { 
            code: 'SDM-112025-03', 
            name: 'Software Development Methods', 
            description: 'Software development methodologies and practices',
            instructor_id: null,
            exam_admin_id: null 
          }
        ];
      };

      const createDefaultClassesLocal = (modules) => {
        return [
          { 
            id: Date.now(), 
            name: 'Networking Technologies - Lecture 1', 
            module_code: 'NWT-112025-01', 
            class_type: 'lecture',
            students: [],
            display_code: 'NWT-112025-01_lecture_1',
            created_at: new Date().toISOString()
          },
          { 
            id: Date.now() + 1, 
            name: 'Object-Oriented Programming - Tutorial 1', 
            module_code: 'OOP-112025-02', 
            class_type: 'tutorial',
            students: [],
            display_code: 'OOP-112025-02_tutorial_1',
            created_at: new Date().toISOString()
          },
          { 
            id: Date.now() + 2, 
            name: 'Software Development Methods - Lab 1', 
            module_code: 'SDM-112025-03', 
            class_type: 'lab',
            students: [],
            display_code: 'SDM-112025-03_lab_1',
            created_at: new Date().toISOString()
          }
        ];
      };

      const createDefaultUsers = async () => {
        const defaultUsers = [
          {
            id: 1,
            name: 'System Administrator',
            email: 'admin@educonnect.com',
            password: 'admin123',
            role: 'System Administrator',
            active: true
          },
          {
            id: 2,
            name: 'John Student',
            email: 'student@educonnect.com',
            password: 'student123',
            role: 'Student',
            active: true
          },
          {
            id: 3,
            name: 'Dr. Instructor',
            email: 'instructor@educonnect.com',
            password: 'instructor123',
            role: 'Instructor',
            active: true
          },
          {
            id: 4,
            name: 'Exam Admin',
            email: 'exam@educonnect.com',
            password: 'exam123',
            role: 'Exam Administrator',
            active: true
          }
        ];
        
        for (const user of defaultUsers) {
          try {
            await SupabaseService.createUser(user);
          } catch (error) {
            console.error('Error creating default user:', error);
          }
        }
        
        return defaultUsers;
      };

      const createDefaultUsersLocal = () => {
        return [
          {
            id: 1,
            name: 'System Administrator',
            email: 'admin@educonnect.com',
            password: 'admin123',
            role: 'System Administrator',
            active: true
          },
          {
            id: 2,
            name: 'John Student',
            email: 'student@educonnect.com',
            password: 'student123',
            role: 'Student',
            active: true
          },
          {
            id: 3,
            name: 'Dr. Instructor',
            email: 'instructor@educonnect.com',
            password: 'instructor123',
            role: 'Instructor',
            active: true
          },
          {
            id: 4,
            name: 'Exam Admin',
            email: 'exam@educonnect.com',
            password: 'exam123',
            role: 'Exam Administrator',
            active: true
          }
        ];
      };

      const createDefaultModules = async () => {
        const defaultModules = [
          { 
            code: 'NWT-112025-01', 
            name: 'Networking Technologies', 
            description: 'Basic networking concepts and technologies',
            instructor_id: null,
            exam_admin_id: null 
          },
          { 
            code: 'OOP-112025-02', 
            name: 'Object-Oriented Programming', 
            description: 'Advanced object-oriented programming concepts',
            instructor_id: null,
            exam_admin_id: null 
          },
          { 
            code: 'SDM-112025-03', 
            name: 'Software Development Methods', 
            description: 'Software development methodologies and practices',
            instructor_id: null,
            exam_admin_id: null 
          }
        ];
        
        for (const module of defaultModules) {
          try {
            await SupabaseService.createModule(module);
          } catch (error) {
            console.error('Error creating default module:', error);
          }
        }
        
        return defaultModules;
      };

      const redirectBasedOnRole = (role) => {
        const urlParams = new URLSearchParams(window.location.search);
        const pageParam = urlParams.get('page');
        const moduleParam = urlParams.get('module');
        
        if (pageParam === 'module' && moduleParam) {
          setPage('module');
        } else if (role === 'Student') {
          setPage('student-dashboard');
        } else if (role === 'Instructor') {
          setPage('instructor-dashboard');
        } else if (role === 'Exam Administrator') {
          setPage('exam-admin-dashboard');
        } else if (role === 'System Administrator') {
          setPage('admin-dashboard');
        } else {
          setPage('login');
        }
      };

      const handlePopupUserSubmit = async (e) => {
        e.preventDefault();
        
        try {
          const exists = await SupabaseService.userExists(popupUserData.email);
          if (exists) {
            alert('User already exists');
            return;
          }
          
          const newUser = { 
            id: Date.now(), 
            name: popupUserData.name, 
            email: popupUserData.email, 
            password: popupUserData.password, 
            role: popupUserData.role, 
            active: true 
          };
          
          const createdUser = await SupabaseService.createUser(newUser);
          const updatedUsers = [...users, createdUser];
          setUsers(updatedUsers);
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          setPopupUserData({ name: '', email: '', password: '', role: '' });
          setShowAddUserPopup(false);
          alert('User created successfully');
        } catch (error) {
          if (users.find(u => u.email === popupUserData.email)) {
            alert('User already exists');
            return;
          }
          const newUser = { 
            id: Date.now(), 
            name: popupUserData.name, 
            email: popupUserData.email, 
            password: popupUserData.password, 
            role: popupUserData.role, 
            active: true 
          };
          const updatedUsers = [...users, newUser];
          setUsers(updatedUsers);
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          setPopupUserData({ name: '', email: '', password: '', role: '' });
          setShowAddUserPopup(false);
          alert('User created');
        }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        
        try {
          const user = await SupabaseService.loginUser(loginData.email, loginData.password);
          
          if (user) {
            setCurrentUser(user);
            localStorage.setItem('currentUser', JSON.stringify(user));
            redirectBasedOnRole(user.role);
            return;
          }
        } catch (supabaseError) {
          console.log('Supabase login failed, trying local...');
        }
        
        const localUser = users.find(u => 
          u.email === loginData.email && 
          u.password === loginData.password && 
          u.active !== false
        );
        
        if (localUser) {
          setCurrentUser(localUser);
          localStorage.setItem('currentUser', JSON.stringify(localUser));
          redirectBasedOnRole(localUser.role);
        } else {
          alert('Invalid credentials. Please try again.');
        }
      };

      const handleRegister = async (e) => {
        e.preventDefault();
        
        try {
          const exists = await SupabaseService.userExists(registerData.email);
          if (exists) {
            alert('User already exists with this email');
            return;
          }
          
          const newUser = { 
            id: Date.now(), 
            name: registerData.name, 
            email: registerData.email, 
            password: registerData.password, 
            role: registerData.role, 
            active: true 
          };
          
          const createdUser = await SupabaseService.createUser(newUser);
          const updatedUsers = [...users, createdUser];
          setUsers(updatedUsers);
          setCurrentUser(createdUser);
          
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          localStorage.setItem('currentUser', JSON.stringify(createdUser));
          
          redirectBasedOnRole(createdUser.role);
          
        } catch (error) {
          const existingUser = users.find(u => u.email === registerData.email);
          if (existingUser) {
            alert('User already exists with this email');
            return;
          }
          
          const newUser = { 
            id: Date.now(), 
            name: registerData.name, 
            email: registerData.email, 
            password: registerData.password, 
            role: registerData.role, 
            active: true 
          };
          
          const updatedUsers = [...users, newUser];
          setUsers(updatedUsers);
          setCurrentUser(newUser);
          
          localStorage.setItem('users', JSON.stringify(updatedUsers));
          localStorage.setItem('currentUser', JSON.stringify(newUser));
          
          redirectBasedOnRole(newUser.role);
        }
      };

      const handleLogout = () => {
        setCurrentUser(null);
        localStorage.removeItem('currentUser');
        setPage('login');
        setLoginData({ email: '', password: '' });
      };

      const goToRegister = () => {
        setPage('register');
        setRegisterData({ name: '', email: '', password: '', role: '' });
      };

      const goToLogin = () => {
        setPage('login');
        setLoginData({ email: '', password: '' });
      };

      const goToProfile = () => {
        setPage('profile');
      };

      const goBack = () => {
        // Use browser history to go back
        if (window.history.length > 1) {
          window.history.back();
        } else {
          // If no history, go to appropriate dashboard
          if (!currentUser) {
            setPage('login');
          } else {
            redirectBasedOnRole(currentUser.role);
          }
        }
      };

      if (isLoading) {
        return (
          <div className="loading-screen">
            <div className="loading-spinner"></div>
            <h2>Loading EduConnect System...</h2>
            <p>Please wait while we initialize the application.</p>
          </div>
        );
      }

      switch(page) {
        case 'login':
          return (
            <LoginPage 
              loginData={loginData} 
              setLoginData={setLoginData} 
              handleLogin={handleLogin} 
              goToRegister={goToRegister} 
            />
          );
          
        case 'register':
          return (
            <RegisterPage 
              registerData={registerData} 
              setRegisterData={setRegisterData} 
              handleRegister={handleRegister} 
              goToLogin={goToLogin} 
            />
          );
          
        case 'student-dashboard':
          return (
            <StudentDashboard 
              currentUser={currentUser} 
              assessments={assessments} 
              submissions={submissions} 
              questions={questions} 
              setSubmissions={setSubmissions} 
              setQuestions={setQuestions} 
              handleLogout={handleLogout} 
              goToProfile={goToProfile}
              modules={modules}
              classes={classes}
              setClasses={setClasses}
            />
          );
          
        case 'instructor-dashboard':
          return (
            <InstructorDashboard 
              currentUser={currentUser} 
              assessments={assessments} 
              submissions={submissions} 
              questions={questions} 
              setAssessments={setAssessments} 
              setSubmissions={setSubmissions} 
              setQuestions={setQuestions} 
              handleLogout={handleLogout} 
              goToProfile={goToProfile}
              modules={modules}
              setModules={setModules}
              teachingMaterials={teachingMaterials}
              setTeachingMaterials={setTeachingMaterials}
            />
          );

        case 'assessment-view':
          return (
            <AssessmentViewPage
              currentUser={currentUser}
              assessments={assessments}
              submissions={submissions}
              questions={questions}
              modules={modules}
              users={users}
              setSubmissions={setSubmissions}
              setQuestions={setQuestions}
              handleLogout={handleLogout}
              goToProfile={goToProfile}
              goBack={goBack}
            />
          );
          
        case 'exam-admin-dashboard':
          return (
            <ExamAdminDashboard 
              currentUser={currentUser} 
              assessments={assessments} 
              submissions={submissions} 
              users={users}
              handleLogout={handleLogout} 
              goToProfile={goToProfile}
              modules={modules}
            />
          );
          
        case 'admin-dashboard':
          return (
            <>
              <SystemAdminDashboard 
                currentUser={currentUser} 
                users={users} 
                setUsers={setUsers}
                modules={modules}
                setModules={setModules}
                classes={classes}
                setClasses={setClasses}
                handleLogout={handleLogout} 
                goToProfile={goToProfile}
                showAddUserPopup={showAddUserPopup}
                setShowAddUserPopup={setShowAddUserPopup}
                popupUserData={popupUserData}
                setPopupUserData={setPopupUserData}
                handlePopupUserSubmit={handlePopupUserSubmit}
              />
              <GlobalAddUserPopup 
                show={showAddUserPopup}
                onClose={() => setShowAddUserPopup(false)}
                userData={popupUserData}
                setUserData={setPopupUserData}
                onSubmit={handlePopupUserSubmit}
              />
            </>
          );
          
        case 'profile':
          return (
            <ProfilePage 
              currentUser={currentUser} 
              setCurrentUser={setCurrentUser} 
              users={users} 
              setUsers={setUsers} 
              goBack={goBack} 
              handleLogout={handleLogout} 
            />
          );
          
        case 'module':
          return (
            <ModulePage
              currentUser={currentUser}
              modules={modules}
              assessments={assessments}
              submissions={submissions}
              questions={questions}
              users={users}
              teachingMaterials={teachingMaterials}
              setAssessments={setAssessments}
              setSubmissions={setSubmissions}
              setTeachingMaterials={setTeachingMaterials}
              setQuestions={setQuestions}
              handleLogout={handleLogout}
              goToProfile={goToProfile}
              goBack={goBack}
            />
          );
          
        default:
          return (
            <div className="error-page">
              <h2>Page Not Found</h2>
              <p>The page "{page}" could not be found.</p>
              <button onClick={goToLogin} className="btn-primary">
                Go to Login Page
              </button>
            </div>
          );
      }
    };

    function App() {
      return (
        <div className="App">
          <HomePage />
        </div>
      );
    }

    // Render the app
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>